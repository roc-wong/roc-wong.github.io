<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>roc wong</title>
  <subtitle>九万里风鹏正举</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://roc-wong.github.io/"/>
  <updated>2018-11-21T02:18:42.950Z</updated>
  <id>https://roc-wong.github.io/</id>
  
  <author>
    <name>roc.wong</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>eureka dns cluster</title>
    <link href="https://roc-wong.github.io/blog/2018/11/eureka-dns-cluster.html"/>
    <id>https://roc-wong.github.io/blog/2018/11/eureka-dns-cluster.html</id>
    <published>2018-11-20T13:34:38.000Z</published>
    <updated>2018-11-21T02:18:42.950Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Netflix-Eureka集群配置"><a href="#Netflix-Eureka集群配置" class="headerlink" title="Netflix Eureka集群配置"></a>Netflix Eureka集群配置</h2><p>Spring Cloud Netflix Eureka集群配置方式主要用两种：Static servers list config和dns，本文主要介绍基于DNS的方式搭建Eureka集群。</p>
<h3 id="Static-servers-list-config"><a href="#Static-servers-list-config" class="headerlink" title="Static servers list config"></a>Static servers list config</h3><p>client启动后从config中获取region和zone以及serviceUrl，进行服务注册、发现，这种静态集群模式无法动态扩容，一旦新增节点，只能挨个修改server和client端的配置文件，大致配置如下：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="attr">eureka:</span></div><div class="line"><span class="attr">  server:</span></div><div class="line"><span class="attr">    enable-self-preservation:</span> <span class="literal">false</span></div><div class="line"><span class="attr">  instance:</span></div><div class="line"><span class="attr">    prefer-ip-address:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    instance-id:</span> $&#123;spring.cloud.client.ip-address&#125;:$&#123;spring.application.name&#125;:$&#123;server.port&#125;</div><div class="line"><span class="attr">  client:</span></div><div class="line"><span class="attr">    register-with-eureka:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    fetch-registry:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    service-url:</span></div><div class="line"><span class="attr">      defaultZone:</span> http://<span class="number">10.25</span><span class="number">.102</span><span class="number">.174</span>:<span class="number">8082</span>/eureka/,http://<span class="number">10.25</span><span class="number">.102</span><span class="number">.174</span>:<span class="number">8083</span>/eureka/</div></pre></td></tr></table></figure></p>
<h3 id="DNS-configuration"><a href="#DNS-configuration" class="headerlink" title="DNS configuration"></a>DNS configuration</h3><p>基于DNS的Eureka Cluster架构图如下：</p>
<p><img src="https://raw.githubusercontent.com/roc-wong/images/master/eureka/eureka-dns-cluster-architecture-diagram.png" alt="eureka-dns-cluster-architecture-diagram"></p>
<p><img src="https://raw.githubusercontent.com/roc-wong/images/master/eureka/eureka-client-invoke-process.png" alt="eureka-client-invoke-process"></p>
<p>简单来说就是使用DNS服务器管理Eureka Server的地址，弹性伸缩对客户端没有影响。</p>
<p>大致流程如下：</p>
<ol>
<li>客户端开启DNS方式获取serviceUrl：<code>use-dns-for-fetching-service-urls: true</code>；</li>
<li>根据<code>client.region</code>配置的区域region，查询DNS区域配置文件中该区域下的所有可用区zone；</li>
<li>循环所有可用区zone，获取可用区配置的eureka-server地址；</li>
<li>拼接成完整的serviceUrl并加入serviceUrls列表中，serviceUrl格式为：<code>&quot;http://&quot; + ec2Url + &quot;:&quot; + clientConfig.getEurekaServerPort() + &quot;/&quot; + clientConfig.getEurekaServerURLContext() + &quot;/&quot;;</code>。</li>
</ol>
<p><strong>只要解决DNS服务器配置就可以达到动态集群的效果，关于如何搭建DNS服务器集群，请移步另一篇文章：<a href="https://roc-wong.github.io/blog/2018/11/Centos%E6%90%AD%E5%BB%BADNS%E4%B8%BB%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%9B%86%E7%BE%A4.html">CentOS 搭建DNS主从服务器集群</a>，文中详细介绍了如何在区域配置文件中配置TXT记录，本文不在赘述。</strong></p>
<h4 id="1-DNS-区域文件配置TXT记录"><a href="#1-DNS-区域文件配置TXT记录" class="headerlink" title="1.DNS 区域文件配置TXT记录"></a>1.DNS 区域文件配置TXT记录</h4><p><a href="https://roc-wong.github.io/blog/2018/11/Centos%E6%90%AD%E5%BB%BADNS%E4%B8%BB%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%9B%86%E7%BE%A4.html#a-%E5%88%9B%E5%BB%BA%E8%BD%AC%E5%8F%91%E5%9F%9F">zts.local.zone</a>区域配置文件中有关eureka的配置：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">; <span class="selector-tag">eureka</span> <span class="selector-tag">cluster</span>配置</div><div class="line"><span class="selector-tag">txt</span><span class="selector-class">.shanghai</span> <span class="selector-tag">IN</span> <span class="selector-tag">TXT</span> "<span class="selector-tag">defaultZone</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>"</div><div class="line"><span class="selector-tag">txt</span><span class="selector-class">.defaultZone</span> <span class="selector-tag">IN</span> <span class="selector-tag">TXT</span> "10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.56</span>" "10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.57</span>" "10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.58</span>" "10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.60</span>"</div><div class="line"></div><div class="line">;通过查看<span class="selector-tag">Eureka</span>的源码，它的实现是通过寻找<span class="selector-tag">txt</span><span class="selector-class">.beijing-a</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>（<span class="selector-tag">txt</span><span class="selector-class">.region</span><span class="selector-class">.eureka-server-d-n-s-name</span>）获取"<span class="selector-tag">beijing-a</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>" "<span class="selector-tag">beijing-b</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>"的<span class="selector-tag">zone</span>：<span class="selector-tag">beijing-a</span>和<span class="selector-tag">beijing-b</span>，</div><div class="line">;然后再去获取<span class="selector-tag">txt</span><span class="selector-class">.beijing-a</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>和<span class="selector-tag">txt</span><span class="selector-class">.beijing-b</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>中对应的<span class="selector-tag">ServiceUrls</span>的数据，也就是<span class="selector-tag">IP</span>地址: "10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.61</span>" "10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.62</span>"</div><div class="line">;这样服务间就可以获取到固定端口下的不同<span class="selector-tag">IP</span>的机器的注册中心服务地址，并相互注册</div><div class="line"><span class="selector-tag">txt</span><span class="selector-class">.beijing</span> <span class="selector-tag">IN</span> <span class="selector-tag">TXT</span> "<span class="selector-tag">beijing-a</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>" "<span class="selector-tag">beijing-b</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>"</div><div class="line"><span class="selector-tag">txt</span><span class="selector-class">.beijing-a</span> <span class="selector-tag">IN</span> <span class="selector-tag">TXT</span> "10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.61</span>" "10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.62</span>"</div><div class="line"><span class="selector-tag">txt</span><span class="selector-class">.beijing-b</span> <span class="selector-tag">IN</span> <span class="selector-tag">TXT</span> "10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.63</span>" "10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.64</span>"</div></pre></td></tr></table></figure>
<h4 id="2-Eureka-Server-Client端配置"><a href="#2-Eureka-Server-Client端配置" class="headerlink" title="2.Eureka Server/Client端配置"></a>2.Eureka Server/Client端配置</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> eureka-server</div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8081</span></div><div class="line"><span class="attr">eureka:</span></div><div class="line"><span class="attr">  server:</span></div><div class="line"><span class="attr">    enable-self-preservation:</span> <span class="literal">false</span></div><div class="line"><span class="attr">  instance:</span></div><div class="line"><span class="attr">    prefer-ip-address:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    instance-id:</span> $&#123;spring.cloud.client.ip-address&#125;:$&#123;spring.application.name&#125;:$&#123;server.port&#125;</div><div class="line"><span class="attr">  client:</span></div><div class="line">    <span class="comment">## 是否将自己注册到eureka</span></div><div class="line"><span class="attr">    register-with-eureka:</span> <span class="literal">true</span></div><div class="line">    <span class="comment">## 是否获取注册信息到本地</span></div><div class="line"><span class="attr">    fetch-registry:</span> <span class="literal">true</span></div><div class="line">    <span class="comment">## 开启DNS方式获取serviceUrl,默认为false</span></div><div class="line"><span class="attr">    use-dns-for-fetching-service-urls:</span> <span class="literal">true</span></div><div class="line">    <span class="comment">## DNS域名,获取其他信息将以该域名为根域名</span></div><div class="line"><span class="attr">    eureka-server-d-n-s-name:</span> zts.local</div><div class="line">    <span class="comment">## 当前应用所在区域,默认为us-east-1</span></div><div class="line"><span class="attr">    region:</span> beijing</div><div class="line">    <span class="comment">## 配置中心的eureka目录</span></div><div class="line"><span class="attr">    eureka-server-u-r-l-context:</span> eureka</div><div class="line">    <span class="comment">## 映射其他eurekaServer的端口，这里注意采用这种方式 server.port和这个端口最好一致</span></div><div class="line">    <span class="comment">## 因为dns是控制地址的变化，端口不变，所以不像前面的哪些配置方式可以自己定义url和port。</span></div><div class="line">    <span class="comment">## 所以每个IP都是用的相同的port进行注册中心服务的部署</span></div><div class="line"><span class="attr">    eureka-server-port:</span> <span class="number">8081</span></div><div class="line">    <span class="comment">## 获取serviceUrl时候是否优先获取相同zone的列表(如果获取为空则获取所在region第一个zone),如果为false则优先获取不在相同zone的列表</span></div><div class="line"><span class="attr">    prefer-same-zone-eureka:</span> <span class="literal">true</span></div></pre></td></tr></table></figure>
<h4 id="3-测试"><a href="#3-测试" class="headerlink" title="3.测试"></a>3.测试</h4><blockquote>
<p>修改客户端DNS服务器配置为10.29.181.61，DNS服务器的域名为zts.local</p>
</blockquote>
<p>依次启动4台Eureka Server服务器，查看启动日志（删减版的日志），：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">14.962</span>  INFO <span class="number">49750</span> --- [           main] c<span class="selector-class">.n</span><span class="selector-class">.d</span><span class="selector-class">.s</span><span class="selector-class">.r</span><span class="selector-class">.aws</span><span class="selector-class">.ConfigClusterResolver</span>      : Resolving eureka endpoints via DNS: txt<span class="selector-class">.beijing</span><span class="selector-class">.zts</span><span class="selector-class">.local</span> (&lt;------注意这里)</div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">15.012</span>  INFO <span class="number">49750</span> --- [           main] com<span class="selector-class">.netflix</span><span class="selector-class">.discovery</span><span class="selector-class">.DiscoveryClient</span>    : Disable delta property : false</div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">15.262</span>  INFO <span class="number">49750</span> --- [           main] com<span class="selector-class">.netflix</span><span class="selector-class">.discovery</span><span class="selector-class">.DiscoveryClient</span>    : Discovery Client initialized at timestamp <span class="number">1542701835260</span> with <span class="attribute">initial</span> instances count: <span class="number">5</span></div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">15.326</span>  INFO <span class="number">49750</span> --- [           main] c<span class="selector-class">.n</span><span class="selector-class">.eureka</span><span class="selector-class">.DefaultEurekaServerContext</span>    : Initializing ...</div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">15.559</span>  INFO <span class="number">49750</span> --- [           main] c<span class="selector-class">.n</span><span class="selector-class">.eureka</span><span class="selector-class">.cluster</span><span class="selector-class">.PeerEurekaNodes</span>       : Replica node URL:  http:<span class="comment">//10.29.181.62:8081/eureka/</span></div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">15.560</span>  INFO <span class="number">49750</span> --- [           main] c<span class="selector-class">.n</span><span class="selector-class">.eureka</span><span class="selector-class">.cluster</span><span class="selector-class">.PeerEurekaNodes</span>       : Replica node URL:  http:<span class="comment">//10.29.181.64:8081/eureka/</span></div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">15.560</span>  INFO <span class="number">49750</span> --- [           main] c<span class="selector-class">.n</span><span class="selector-class">.eureka</span><span class="selector-class">.cluster</span><span class="selector-class">.PeerEurekaNodes</span>       : Replica node URL:  http:<span class="comment">//10.29.181.61:8081/eureka/</span></div><div class="line"></div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">16.052</span>  INFO <span class="number">49750</span> --- [      Thread-<span class="number">14</span>] o<span class="selector-class">.s</span><span class="selector-class">.c</span><span class="selector-class">.n</span><span class="selector-class">.e</span><span class="selector-class">.server</span><span class="selector-class">.EurekaServerBootstrap</span>   : isAws returned false</div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">16.053</span>  INFO <span class="number">49750</span> --- [      Thread-<span class="number">14</span>] o<span class="selector-class">.s</span><span class="selector-class">.c</span><span class="selector-class">.n</span><span class="selector-class">.e</span><span class="selector-class">.server</span><span class="selector-class">.EurekaServerBootstrap</span>   : Initialized server context</div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">16.056</span>  INFO <span class="number">49750</span> --- [           main] c<span class="selector-class">.z</span><span class="selector-class">.e</span><span class="selector-class">.server</span><span class="selector-class">.EurekaServerApplication</span>     : Started EurekaServerApplication <span class="keyword">in</span> <span class="number">7.112</span> seconds (JVM running <span class="keyword">for</span> <span class="number">7.625</span>)</div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">16.060</span>  INFO <span class="number">49750</span> --- [      Thread-<span class="number">14</span>] c<span class="selector-class">.n</span><span class="selector-class">.e</span><span class="selector-class">.registry</span><span class="selector-class">.AbstractInstanceRegistry</span>  : Registered instance EUREKA-SERVER/<span class="number">10.29</span>.<span class="number">181.61</span>:eureka-server:<span class="number">8081</span> with status UP (replication=true)</div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">16.061</span>  INFO <span class="number">49750</span> --- [      Thread-<span class="number">14</span>] c<span class="selector-class">.n</span><span class="selector-class">.e</span><span class="selector-class">.registry</span><span class="selector-class">.AbstractInstanceRegistry</span>  : Registered instance EUREKA-SERVER/<span class="number">10.29</span>.<span class="number">181.62</span>:eureka-server:<span class="number">8081</span> with status UP (replication=true)</div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">16.061</span>  INFO <span class="number">49750</span> --- [      Thread-<span class="number">14</span>] c<span class="selector-class">.n</span><span class="selector-class">.e</span><span class="selector-class">.registry</span><span class="selector-class">.AbstractInstanceRegistry</span>  : Registered instance EUREKA-SERVER/<span class="number">10.29</span>.<span class="number">181.64</span>:eureka-server:<span class="number">8081</span> with status UP (replication=true)</div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">16.062</span>  INFO <span class="number">49750</span> --- [      Thread-<span class="number">14</span>] c<span class="selector-class">.n</span><span class="selector-class">.e</span><span class="selector-class">.registry</span><span class="selector-class">.AbstractInstanceRegistry</span>  : Registered instance EUREKA-SERVER/<span class="number">10.29</span>.<span class="number">181.63</span>:eureka-server:<span class="number">8081</span> with status UP (replication=true)</div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">16.062</span>  INFO <span class="number">49750</span> --- [      Thread-<span class="number">14</span>] c<span class="selector-class">.n</span><span class="selector-class">.e</span><span class="selector-class">.registry</span><span class="selector-class">.AbstractInstanceRegistry</span>  : Registered instance ACCOUNT-CENTER/<span class="number">10.25</span>.<span class="number">102.174</span>:account-center:<span class="number">8891</span> with status UP (replication=true)</div><div class="line"></div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">16.062</span>  INFO <span class="number">49750</span> --- [      Thread-<span class="number">14</span>] c<span class="selector-class">.n</span><span class="selector-class">.e</span><span class="selector-class">.r</span><span class="selector-class">.PeerAwareInstanceRegistryImpl</span>    : Got <span class="number">5</span> instances from neighboring DS node</div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">16.062</span>  INFO <span class="number">49750</span> --- [      Thread-<span class="number">14</span>] c<span class="selector-class">.n</span><span class="selector-class">.e</span><span class="selector-class">.r</span><span class="selector-class">.PeerAwareInstanceRegistryImpl</span>    : Renew threshold is: <span class="number">8</span></div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">16.062</span>  INFO <span class="number">49750</span> --- [      Thread-<span class="number">14</span>] c<span class="selector-class">.n</span><span class="selector-class">.e</span><span class="selector-class">.r</span><span class="selector-class">.PeerAwareInstanceRegistryImpl</span>    : Changing status to UP</div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">16.070</span>  INFO <span class="number">49750</span> --- [nfoReplicator-<span class="number">0</span>] com<span class="selector-class">.netflix</span><span class="selector-class">.discovery</span><span class="selector-class">.DiscoveryClient</span>    : DiscoveryClient_EUREKA-SERVER/<span class="number">10.29</span>.<span class="number">181.63</span>:eureka-server:<span class="number">8081</span> - registration status: <span class="number">204</span></div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">16.070</span>  INFO <span class="number">49750</span> --- [      Thread-<span class="number">14</span>] e<span class="selector-class">.s</span><span class="selector-class">.EurekaServerInitializerConfiguration</span> : Started Eureka Server</div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">16.310</span>  INFO <span class="number">49750</span> --- [nio-<span class="number">8081</span>-exec-<span class="number">1</span>] o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.c</span><span class="selector-class">.C</span>.[Tomcat].[localhost].[/]       : Initializing Spring FrameworkServlet <span class="string">'dispatcherServlet'</span></div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">16.310</span>  INFO <span class="number">49750</span> --- [nio-<span class="number">8081</span>-exec-<span class="number">1</span>] o<span class="selector-class">.s</span><span class="selector-class">.web</span><span class="selector-class">.servlet</span><span class="selector-class">.DispatcherServlet</span>        : FrameworkServlet <span class="string">'dispatcherServlet'</span>: initialization started</div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">16.327</span>  INFO <span class="number">49750</span> --- [nio-<span class="number">8081</span>-exec-<span class="number">1</span>] o<span class="selector-class">.s</span><span class="selector-class">.web</span><span class="selector-class">.servlet</span><span class="selector-class">.DispatcherServlet</span>        : FrameworkServlet <span class="string">'dispatcherServlet'</span>: initialization completed <span class="keyword">in</span> <span class="number">17</span> ms</div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">16.578</span>  INFO <span class="number">49750</span> --- [nio-<span class="number">8081</span>-exec-<span class="number">1</span>] c<span class="selector-class">.n</span><span class="selector-class">.e</span><span class="selector-class">.registry</span><span class="selector-class">.AbstractInstanceRegistry</span>  : Registered instance EUREKA-SERVER/<span class="number">10.29</span>.<span class="number">181.63</span>:eureka-server:<span class="number">8081</span> with status UP (replication=true)</div><div class="line"><span class="number">2018</span>-<span class="number">11</span>-<span class="number">20</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">17.457</span>  INFO <span class="number">49750</span> --- [nio-<span class="number">8081</span>-exec-<span class="number">2</span>] c<span class="selector-class">.n</span><span class="selector-class">.e</span><span class="selector-class">.registry</span><span class="selector-class">.AbstractInstanceRegistry</span>  : Registered instance EUREKA-SERVER/<span class="number">10.29</span>.<span class="number">181.63</span>:eureka-server:<span class="number">8081</span> with status UP (replication=true)</div></pre></td></tr></table></figure>
<p><strong>Eureka Client端</strong></p>
<p>Account服务配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="attr">logging:</span></div><div class="line"><span class="attr">  level:</span></div><div class="line">    org.springframework.boot: info</div><div class="line">    org.springframework.cloud: debug</div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> account-center</div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8891</span></div><div class="line"><span class="attr">eureka:</span></div><div class="line"><span class="attr">  server:</span></div><div class="line"><span class="attr">    enable-self-preservation:</span> <span class="literal">false</span></div><div class="line"><span class="attr">  instance:</span></div><div class="line"><span class="attr">    prefer-ip-address:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    instance-id:</span> $&#123;spring.cloud.client.ip-address&#125;:$&#123;spring.application.name&#125;:$&#123;server.port&#125;</div><div class="line"><span class="attr">    metadata-map:</span></div><div class="line"><span class="attr">      configPath:</span> $&#123;server.servlet.context-path&#125;</div><div class="line"><span class="attr">    home-page-url-path:</span> $&#123;server.servlet.context-path&#125;</div><div class="line">    <span class="comment">## 服务过期时间配置,超过这个时间没有接收到心跳EurekaServer就会将这个实例剔除</span></div><div class="line"><span class="attr">    lease-expiration-duration-in-seconds:</span> <span class="number">10</span></div><div class="line">    <span class="comment">## 服务刷新时间配置，每隔这个时间会主动心跳一次</span></div><div class="line"><span class="attr">    lease-renewal-interval-in-seconds:</span> <span class="number">5</span></div><div class="line"><span class="attr">  client:</span></div><div class="line">    <span class="comment">## 是否将自己注册到eureka</span></div><div class="line"><span class="attr">    register-with-eureka:</span> <span class="literal">true</span></div><div class="line">    <span class="comment">## 是否获取注册信息到本地</span></div><div class="line"><span class="attr">    fetch-registry:</span> <span class="literal">true</span></div><div class="line">    <span class="comment">## 开启DNS方式获取serviceUrl,默认为false</span></div><div class="line"><span class="attr">    use-dns-for-fetching-service-urls:</span> <span class="literal">true</span></div><div class="line">    <span class="comment">## DNS域名,获取其他信息将以该域名为根域名</span></div><div class="line"><span class="attr">    eureka-server-d-n-s-name:</span> zts.local</div><div class="line">    <span class="comment">## 当前应用所在区域,默认为us-east-1</span></div><div class="line"><span class="attr">    region:</span> beijing</div><div class="line">    <span class="comment">## 配置中心的eureka目录</span></div><div class="line"><span class="attr">    eureka-server-u-r-l-context:</span> eureka</div><div class="line">    <span class="comment">## 映射其他eurekaServer的端口，这里注意采用这种方式 server.port和这个端口最好一致</span></div><div class="line">    <span class="comment">## 因为dns是控制地址的变化，端口不变，所以不像前面的哪些配置方式可以自己定义url和port。</span></div><div class="line">    <span class="comment">## 所以每个IP都是用的相同的port进行注册中心服务的部署</span></div><div class="line"><span class="attr">    eureka-server-port:</span> <span class="number">8081</span></div><div class="line">    <span class="comment">## 获取serviceUrl时候是否优先获取相同zone的列表(如果获取为空则获取所在region第一个zone),如果为false则优先获取不在相同zone的列表</span></div><div class="line"><span class="attr">    prefer-same-zone-eureka:</span> <span class="literal">true</span></div></pre></td></tr></table></figure>
<p>Account启动日志：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">2018<span class="selector-tag">-11-20</span> 16<span class="selector-pseudo">:11</span><span class="selector-pseudo">:05.373</span>  <span class="selector-tag">INFO</span> 5824 <span class="selector-tag">---</span> <span class="selector-attr">[  restartedMain]</span> <span class="selector-tag">c</span><span class="selector-class">.n</span><span class="selector-class">.d</span><span class="selector-class">.s</span><span class="selector-class">.r</span><span class="selector-class">.aws</span><span class="selector-class">.ConfigClusterResolver</span>      : <span class="selector-tag">Resolving</span> <span class="selector-tag">eureka</span> <span class="selector-tag">endpoints</span> <span class="selector-tag">via</span> <span class="selector-tag">DNS</span>: <span class="selector-tag">txt</span><span class="selector-class">.beijing</span><span class="selector-class">.zts</span><span class="selector-class">.local</span> (&lt;<span class="selector-tag">------</span>看这里)</div><div class="line">2018<span class="selector-tag">-11-20</span> 16<span class="selector-pseudo">:11</span><span class="selector-pseudo">:05.529</span>  <span class="selector-tag">INFO</span> 5824 <span class="selector-tag">---</span> <span class="selector-attr">[  restartedMain]</span> <span class="selector-tag">com</span><span class="selector-class">.netflix</span><span class="selector-class">.discovery</span><span class="selector-class">.DiscoveryClient</span>    : <span class="selector-tag">Disable</span> <span class="selector-tag">delta</span> <span class="selector-tag">property</span> : <span class="selector-tag">false</span></div><div class="line">2018<span class="selector-tag">-11-20</span> 16<span class="selector-pseudo">:11</span><span class="selector-pseudo">:05.529</span>  <span class="selector-tag">INFO</span> 5824 <span class="selector-tag">---</span> <span class="selector-attr">[  restartedMain]</span> <span class="selector-tag">com</span><span class="selector-class">.netflix</span><span class="selector-class">.discovery</span><span class="selector-class">.DiscoveryClient</span>    : <span class="selector-tag">Single</span> <span class="selector-tag">vip</span> <span class="selector-tag">registry</span> <span class="selector-tag">refresh</span> <span class="selector-tag">property</span> : <span class="selector-tag">null</span></div><div class="line">2018<span class="selector-tag">-11-20</span> 16<span class="selector-pseudo">:11</span><span class="selector-pseudo">:05.529</span>  <span class="selector-tag">INFO</span> 5824 <span class="selector-tag">---</span> <span class="selector-attr">[  restartedMain]</span> <span class="selector-tag">com</span><span class="selector-class">.netflix</span><span class="selector-class">.discovery</span><span class="selector-class">.DiscoveryClient</span>    : <span class="selector-tag">Force</span> <span class="selector-tag">full</span> <span class="selector-tag">registry</span> <span class="selector-tag">fetch</span> : <span class="selector-tag">false</span></div><div class="line">2018<span class="selector-tag">-11-20</span> 16<span class="selector-pseudo">:11</span><span class="selector-pseudo">:05.529</span>  <span class="selector-tag">INFO</span> 5824 <span class="selector-tag">---</span> <span class="selector-attr">[  restartedMain]</span> <span class="selector-tag">com</span><span class="selector-class">.netflix</span><span class="selector-class">.discovery</span><span class="selector-class">.DiscoveryClient</span>    : <span class="selector-tag">Application</span> <span class="selector-tag">is</span> <span class="selector-tag">null</span> : <span class="selector-tag">false</span></div><div class="line">201</div></pre></td></tr></table></figure>
<p>打开Eureka console，查看注册效果：<br><img src="https://raw.githubusercontent.com/roc-wong/images/master/eureka/eureka%E9%9B%86%E7%BE%A4%E5%90%AF%E5%8A%A8%E6%95%88%E6%9E%9C.png" alt="查看效果"></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><h3 id="1-com-netflix-discovery-endpoint-EndpointUtils-getServiceUrlsFromDNS"><a href="#1-com-netflix-discovery-endpoint-EndpointUtils-getServiceUrlsFromDNS" class="headerlink" title="1.com.netflix.discovery.endpoint.EndpointUtils.getServiceUrlsFromDNS"></a>1.com.netflix.discovery.endpoint.EndpointUtils.getServiceUrlsFromDNS</h3><p>版本：eureka-client:1.9.3 </p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Get the list of all eureka service urls for the eureka client to talk to.</div><div class="line">    *</div><div class="line">    * @param clientConfig the clientConfig to use</div><div class="line">    * @param zone the zone in which the client resides</div><div class="line">    * @param randomizer a randomizer to randomized returned urls, if loading from dns</div><div class="line">    *</div><div class="line">    * @return The list of all eureka service urls for the eureka client to talk to.</div><div class="line">    */</div><div class="line">   <span class="keyword">public</span> <span class="keyword">static</span> List&lt;<span class="keyword">String</span>&gt; getDiscoveryServiceUrls(EurekaClientConfig clientConfig, <span class="keyword">String</span> zone, ServiceUrlRandomizer randomizer) &#123;</div><div class="line">       <span class="built_in">boolean</span> shouldUseDns = clientConfig.shouldUseDnsForFetchingServiceUrls();</div><div class="line">       <span class="keyword">if</span> (shouldUseDns) &#123;</div><div class="line">           <span class="keyword">return</span> getServiceUrlsFromDNS(clientConfig, zone, clientConfig.shouldPreferSameZoneEureka(), randomizer);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> getServiceUrlsFromConfig(clientConfig, zone, clientConfig.shouldPreferSameZoneEureka());</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * Get the list of all eureka service urls from DNS for the eureka client to</div><div class="line">    * talk to. The client picks up the service url from its zone and then fails over to</div><div class="line">    * other zones randomly. If there are multiple servers in the same zone, the client once</div><div class="line">    * again picks one randomly. This way the traffic will be distributed in the case of failures.</div><div class="line">    *</div><div class="line">    * @param clientConfig the clientConfig to use</div><div class="line">    * @param instanceZone The zone in which the client resides.</div><div class="line">    * @param preferSameZone true if we have to prefer the same zone as the client, false otherwise.</div><div class="line">    * @param randomizer a randomizer to randomized returned urls</div><div class="line">    *</div><div class="line">    * @return The list of all eureka service urls for the eureka client to talk to.</div><div class="line">    */</div><div class="line">   <span class="keyword">public</span> <span class="keyword">static</span> List&lt;<span class="keyword">String</span>&gt; getServiceUrlsFromDNS(EurekaClientConfig clientConfig, <span class="keyword">String</span> instanceZone, <span class="built_in">boolean</span> preferSameZone, ServiceUrlRandomizer randomizer) &#123;</div><div class="line">       <span class="keyword">String</span> region = getRegion(clientConfig);</div><div class="line">       <span class="comment">// Get zone-specific DNS names for the given region so that we can get a</span></div><div class="line">       <span class="comment">// list of available zones</span></div><div class="line">       Map&lt;<span class="keyword">String</span>, List&lt;<span class="keyword">String</span>&gt;&gt; zoneDnsNamesMap = getZoneBasedDiscoveryUrlsFromRegion(clientConfig, region);</div><div class="line">       Set&lt;<span class="keyword">String</span>&gt; availableZones = zoneDnsNamesMap.keySet();</div><div class="line">       List&lt;<span class="keyword">String</span>&gt; zones = <span class="keyword">new</span> ArrayList&lt;<span class="keyword">String</span>&gt;(availableZones);</div><div class="line">       <span class="keyword">if</span> (zones.isEmpty()) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No available zones configured for the instanceZone "</span> + instanceZone);</div><div class="line">       &#125;</div><div class="line">       <span class="built_in">int</span> zoneIndex = <span class="number">0</span>;</div><div class="line">       <span class="built_in">boolean</span> zoneFound = <span class="keyword">false</span>;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">String</span> zone : zones) &#123;</div><div class="line">           logger.debug(<span class="string">"Checking if the instance zone &#123;&#125; is the same as the zone from DNS &#123;&#125;"</span>, instanceZone, zone);</div><div class="line">           <span class="keyword">if</span> (preferSameZone) &#123;</div><div class="line">               <span class="keyword">if</span> (instanceZone.equalsIgnoreCase(zone)) &#123;</div><div class="line">                   zoneFound = <span class="keyword">true</span>;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="keyword">if</span> (!instanceZone.equalsIgnoreCase(zone)) &#123;</div><div class="line">                   zoneFound = <span class="keyword">true</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (zoneFound) &#123;</div><div class="line">               logger.debug(<span class="string">"The zone index from the list &#123;&#125; that matches the instance zone &#123;&#125; is &#123;&#125;"</span>,</div><div class="line">                       zones, instanceZone, zoneIndex);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">           zoneIndex++;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (zoneIndex &gt;= zones.<span class="built_in">size</span>()) &#123;</div><div class="line">           <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</div><div class="line">               logger.warn(<span class="string">"No match for the zone &#123;&#125; in the list of available zones &#123;&#125;"</span>,</div><div class="line">                       instanceZone, zones.toArray());</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">// Rearrange the zones with the instance zone first</span></div><div class="line">           <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; zoneIndex; i++) &#123;</div><div class="line">               <span class="keyword">String</span> zone = zones.remove(<span class="number">0</span>);</div><div class="line">               zones.<span class="built_in">add</span>(zone);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// Now get the eureka urls for all the zones in the order and return it</span></div><div class="line">       List&lt;<span class="keyword">String</span>&gt; serviceUrls = <span class="keyword">new</span> ArrayList&lt;<span class="keyword">String</span>&gt;();</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">String</span> zone : zones) &#123;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">String</span> zoneCname : zoneDnsNamesMap.<span class="built_in">get</span>(zone)) &#123;</div><div class="line">               List&lt;<span class="keyword">String</span>&gt; ec2Urls = <span class="keyword">new</span> ArrayList&lt;<span class="keyword">String</span>&gt;(getEC2DiscoveryUrlsFromZone(zoneCname, DiscoveryUrlType.CNAME));</div><div class="line">               <span class="comment">// Rearrange the list to distribute the load in case of multiple servers</span></div><div class="line">               <span class="keyword">if</span> (ec2Urls.<span class="built_in">size</span>() &gt; <span class="number">1</span>) &#123;</div><div class="line">                   randomizer.randomize(ec2Urls);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">String</span> ec2Url : ec2Urls) &#123;</div><div class="line">                   StringBuilder sb = <span class="keyword">new</span> StringBuilder()</div><div class="line">                           .<span class="built_in">append</span>(<span class="string">"http://"</span>)</div><div class="line">                           .<span class="built_in">append</span>(ec2Url)</div><div class="line">                           .<span class="built_in">append</span>(<span class="string">":"</span>)</div><div class="line">                           .<span class="built_in">append</span>(clientConfig.getEurekaServerPort());</div><div class="line">                   <span class="keyword">if</span> (clientConfig.getEurekaServerURLContext() != <span class="keyword">null</span>) &#123;</div><div class="line">                       <span class="keyword">if</span> (!clientConfig.getEurekaServerURLContext().startsWith(<span class="string">"/"</span>)) &#123;</div><div class="line">                           sb.<span class="built_in">append</span>(<span class="string">"/"</span>);</div><div class="line">                       &#125;</div><div class="line">                       sb.<span class="built_in">append</span>(clientConfig.getEurekaServerURLContext());</div><div class="line">                       <span class="keyword">if</span> (!clientConfig.getEurekaServerURLContext().endsWith(<span class="string">"/"</span>)) &#123;</div><div class="line">                           sb.<span class="built_in">append</span>(<span class="string">"/"</span>);</div><div class="line">                       &#125;</div><div class="line">                   &#125; <span class="keyword">else</span> &#123;</div><div class="line">                       sb.<span class="built_in">append</span>(<span class="string">"/"</span>);</div><div class="line">                   &#125;</div><div class="line">                   <span class="keyword">String</span> serviceUrl = sb.toString();</div><div class="line">                   logger.debug(<span class="string">"The EC2 url is &#123;&#125;"</span>, serviceUrl);</div><div class="line">                   serviceUrls.<span class="built_in">add</span>(serviceUrl);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// Rearrange the fail over server list to distribute the load</span></div><div class="line">       <span class="keyword">String</span> primaryServiceUrl = serviceUrls.remove(<span class="number">0</span>);</div><div class="line">       randomizer.randomize(serviceUrls);</div><div class="line">       serviceUrls.<span class="built_in">add</span>(<span class="number">0</span>, primaryServiceUrl);</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">           logger.debug(<span class="string">"This client will talk to the following serviceUrls in order : &#123;&#125; "</span>,</div><div class="line">                   (<span class="keyword">Object</span>) serviceUrls.toArray());</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> serviceUrls;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h3 id="2-dns-config配置参考文章"><a href="#2-dns-config配置参考文章" class="headerlink" title="2. dns config配置参考文章"></a>2. dns config配置参考文章</h3><ul>
<li><a href="https://www.todaysoftmag.com/article/1429/micro-service-discovery-using-netflix-eureka" target="_blank" rel="external">micro-service-discovery-using-netflix-eureka</a></li>
<li><a href="http://www.cnblogs.com/relinson/p/eureka_ha_use_dns.html" target="_blank" rel="external">eureka集群基于DNS配置方式</a> (给予我了不少灵感)</li>
<li><a href="https://blog.csdn.net/ankeway/article/details/79745810" target="_blank" rel="external">Spring Cloud Eureka 集群使用DNS方式进行服务分区</a>(– 简单介绍了windows dns搭建)</li>
</ul>
]]></content>
    
    <summary type="html">
    
      基于DNS服务器搭建Eureka动态集群，由DNS服务器负责维护Eureka serverUrl，弹性伸缩对eureka client端无影响。
    
    </summary>
    
      <category term="SpringCloud" scheme="https://roc-wong.github.io/categories/SpringCloud/"/>
    
      <category term="MicroServices" scheme="https://roc-wong.github.io/categories/SpringCloud/MicroServices/"/>
    
    
      <category term="SpringCloud" scheme="https://roc-wong.github.io/tags/SpringCloud/"/>
    
      <category term="Eureka" scheme="https://roc-wong.github.io/tags/Eureka/"/>
    
  </entry>
  
  <entry>
    <title>CentOS 搭建DNS主从服务器集群</title>
    <link href="https://roc-wong.github.io/blog/2018/11/Centos%E6%90%AD%E5%BB%BADNS%E4%B8%BB%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%9B%86%E7%BE%A4.html"/>
    <id>https://roc-wong.github.io/blog/2018/11/Centos搭建DNS主从服务器集群.html</id>
    <published>2018-11-19T13:32:17.000Z</published>
    <updated>2018-11-21T02:18:25.558Z</updated>
    
    <content type="html"><![CDATA[<p>BIND（Berkeley internet Name Daemon)也叫做NAMED，是现今互联网上使用最为广泛的DNS 服务器程序。这篇文章将要讲述如何在 chroot 监牢中运行 BIND，这样它就无法访问文件系统中除“监牢”以外的其它部分。</p>
<p>在这篇文章中，我会将BIND的运行根目录改为 /var/named/chroot/。当然，对于BIND来说，这个目录就是 /（根目录）。 “jail”（监牢，下同）是一个软件机制，其功能是使得某个程序无法访问规定区域之外的资源，同样也为了增强安全性（LCTT 译注：chroot “监牢”，所谓“监牢”就是指通过chroot机制来更改某个进程所能看到的根目录，即将某进程限制在指定目录中，保证该进程只能对该目录及其子目录的文件进行操作，从而保证整个服务器的安全）。Bind Chroot DNS 服务器的默认“监牢”为 /var/named/chroot。</p>
<h2 id="基本环境"><a href="#基本环境" class="headerlink" title="基本环境"></a>基本环境</h2><p>10.29.181.61 Master DNS服务器<br>10.29.181.62 Slave  DNS服务器</p>
<p>DNS服务器的合法域名：zts.local</p>
<p><strong>要求</strong></p>
<p>允许所有来源的主机对改域名进行解析，内网其他主机访问外网时候走ISP的DNS，只解析内网IP主机的请求进行转发，不会对外网主机的解析请求进行转发。</p>
<h2 id="搭建主从DNS服务器集群"><a href="#搭建主从DNS服务器集群" class="headerlink" title="搭建主从DNS服务器集群"></a>搭建主从DNS服务器集群</h2><h3 id="1、安装Bind-Chroot-DNS-服务器"><a href="#1、安装Bind-Chroot-DNS-服务器" class="headerlink" title="1、安装Bind Chroot DNS 服务器"></a>1、安装Bind Chroot DNS 服务器</h3><figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nrozntgbd2 ~]# yum install <span class="keyword">bind</span>-chroot <span class="keyword">bind</span> <span class="keyword">bind</span>-utils dig -y</div></pre></td></tr></table></figure>
<h3 id="2、拷贝bind相关文件-准备bind-chroot-环境"><a href="#2、拷贝bind相关文件-准备bind-chroot-环境" class="headerlink" title="2、拷贝bind相关文件,准备bind chroot 环境"></a>2、拷贝bind相关文件,准备bind chroot 环境</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nrozntgbd2 ~]# cp -R <span class="regexp">/usr/</span>share<span class="regexp">/doc/</span>bind-*<span class="regexp">/sample/</span>var<span class="regexp">/named/</span>* <span class="regexp">/var/</span>named<span class="regexp">/chroot/</span>var<span class="regexp">/named/</span></div></pre></td></tr></table></figure>
<h3 id="3、在bind-chroot-的目录中创建相关文件"><a href="#3、在bind-chroot-的目录中创建相关文件" class="headerlink" title="3、在bind chroot 的目录中创建相关文件"></a>3、在bind chroot 的目录中创建相关文件</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[<span class="symbol">root@</span>nrozntgbd2 ~]# touch /<span class="keyword">var</span>/named/chroot/<span class="keyword">var</span>/named/<span class="keyword">data</span>/cache_dump.db</div><div class="line">[<span class="symbol">root@</span>nrozntgbd2 ~]# touch /<span class="keyword">var</span>/named/chroot/<span class="keyword">var</span>/named/<span class="keyword">data</span>/named_stats.txt</div><div class="line">[<span class="symbol">root@</span>nrozntgbd2 ~]# touch /<span class="keyword">var</span>/named/chroot/<span class="keyword">var</span>/named/<span class="keyword">data</span>/named_mem_stats.txt</div><div class="line">[<span class="symbol">root@</span>nrozntgbd2 ~]# touch /<span class="keyword">var</span>/named/chroot/<span class="keyword">var</span>/named/<span class="keyword">data</span>/named.run</div><div class="line">[<span class="symbol">root@</span>nrozntgbd2 ~]# mkdir /<span class="keyword">var</span>/named/chroot/<span class="keyword">var</span>/named/<span class="keyword">dynamic</span></div><div class="line">[<span class="symbol">root@</span>nrozntgbd2 ~]# touch /<span class="keyword">var</span>/named/chroot/<span class="keyword">var</span>/named/<span class="keyword">dynamic</span>/managed-keys.bind</div></pre></td></tr></table></figure>
<h3 id="4、-将-Bind-锁定文件设置为可写"><a href="#4、-将-Bind-锁定文件设置为可写" class="headerlink" title="4、 将 Bind 锁定文件设置为可写"></a>4、 将 Bind 锁定文件设置为可写</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[<span class="symbol">root@</span>nrozntgbd2 ~]# chmod -R <span class="number">777</span> /<span class="keyword">var</span>/named/chroot/<span class="keyword">var</span>/named/<span class="keyword">data</span></div><div class="line">[<span class="symbol">root@</span>nrozntgbd2 ~]# chmod -R <span class="number">777</span> /<span class="keyword">var</span>/named/chroot/<span class="keyword">var</span>/named/<span class="keyword">dynamic</span></div></pre></td></tr></table></figure>
<h3 id="5、-将-etc-named-conf-拷贝到-bind-chroot目录"><a href="#5、-将-etc-named-conf-拷贝到-bind-chroot目录" class="headerlink" title="5、 将 /etc/named.conf 拷贝到 bind chroot目录"></a>5、 将 /etc/named.conf 拷贝到 bind chroot目录</h3><figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nrozntgbd2 ~]# cp -p /etc/<span class="keyword">named</span>.conf /var/<span class="keyword">named</span>/chroot/etc/<span class="keyword">named</span>.conf</div></pre></td></tr></table></figure>
<h3 id="6、-在-etc-named-conf中对-bind-进行配置"><a href="#6、-在-etc-named-conf中对-bind-进行配置" class="headerlink" title="6、 在/etc/named.conf中对 bind 进行配置"></a>6、 在/etc/named.conf中对 bind 进行配置</h3><p>在 named.conf 文件尾添加 zts.local 域信息， 创建转发域（Forward Zone）与反向域（Reverse Zone）（LCTT 译注：这里zts.local 并非一个真实有效的互联网域名，而是通常用于本地测试的一个域名；如果你需要做权威 DNS 解析，你可以将你拥有的域名如这里所示配置解析。）：</p>
<p>[root@nrozntgbd2 ~]# vi /var/named/chroot/etc/named.conf</p>
<p>a. 编辑配置文件/etc/named.conf，找到listen-on这一行，改为：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">listen-<span class="keyword">on</span> port <span class="number">53</span> &#123; any; &#125;; <span class="comment">#any是匹配所有的意思</span></div></pre></td></tr></table></figure>
<p>b. 找到allow-query这一行，改为：</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">allow-query     &#123; any<span class="comment">; &#125;;</span></div></pre></td></tr></table></figure>
<p>c. 添加要解析的域</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//正向解析</span></div><div class="line">zone <span class="string">"zts.local"</span> &#123;</div><div class="line">    <span class="keyword">type</span> master;</div><div class="line">    <span class="keyword">file</span> <span class="string">"zts.local.zone"</span>;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//反向解析</span></div><div class="line">zone <span class="string">"181.29.10.in-addr.arpa"</span> <span class="keyword">IN</span> &#123;</div><div class="line">        <span class="keyword">type</span> master;</div><div class="line">        <span class="keyword">file</span> <span class="string">"10.29.181.zone"</span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>d. 对DNS配置文件进行一下语法检查：<code>named-checkconf /var/named/chroot/etc/named.conf</code></p>
<p><strong>named.conf 完全配置如下：</strong></p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// named.conf</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// 由Red Hat提供，将 ISC BIND named(8) DNS服务器 </span></div><div class="line"><span class="comment">// 配置为暂存域名服务器 (用来做本地DNS解析).</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// See /usr/share/doc/bind*/sample/ for example named configuration files.</span></div><div class="line"><span class="comment">//</span></div><div class="line"></div><div class="line">options &#123;</div><div class="line">        listen-<span class="keyword">on</span> port 53 &#123; any; &#125;;</div><div class="line">        listen-<span class="keyword">on</span>-v6 port 53 &#123; ::1; &#125;;</div><div class="line">        directory       <span class="string">"/var/named"</span>;</div><div class="line">        dump-<span class="keyword">file</span>       <span class="string">"/var/named/data/cache_dump.db"</span>;</div><div class="line">        statistics-<span class="keyword">file</span> <span class="string">"/var/named/data/named_stats.txt"</span>;</div><div class="line">        memstatistics-<span class="keyword">file</span> <span class="string">"/var/named/data/named_mem_stats.txt"</span>;</div><div class="line">        allow-<span class="keyword">query</span>     &#123; any; &#125;;</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         - 如果你要建立一个 授权域名服务器 服务器, 那么不要开启 recursion（递归） 功能。</div><div class="line">         - 如果你要建立一个 递归 DNS 服务器, 那么需要开启recursion 功能。</div><div class="line">         - 如果你的递归DNS服务器有公网IP地址, 你必须开启访问控制功能，</div><div class="line">           只有那些合法用户才可以发询问. 如果不这么做的话，那么你的服</div><div class="line">           服务就会受到DNS 放大攻击。实现BCP38将有效抵御这类攻击。</div><div class="line">        */</div><div class="line">        recursion yes;</div><div class="line"></div><div class="line">        dnssec-enable yes;</div><div class="line">        dnssec-validation yes;</div><div class="line">        dnssec-lookaside auto;</div><div class="line"></div><div class="line">        <span class="comment">/* Path to ISC DLV key */</span></div><div class="line">        bindkeys-<span class="keyword">file</span> <span class="string">"/etc/named.iscdlv.key"</span>;</div><div class="line"></div><div class="line">        managed-keys-directory <span class="string">"/var/named/dynamic"</span>;</div><div class="line"></div><div class="line">        pid-<span class="keyword">file</span> <span class="string">"/run/named/named.pid"</span>;</div><div class="line">        session-keyfile <span class="string">"/run/named/session.key"</span>;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">logging &#123;</div><div class="line">        channel default_debug &#123;</div><div class="line">                <span class="keyword">file</span> <span class="string">"data/named.run"</span>;</div><div class="line">                severity dynamic;</div><div class="line">        &#125;;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">zone <span class="string">"."</span> <span class="keyword">IN</span> &#123;</div><div class="line">        <span class="keyword">type</span> hint;</div><div class="line">        <span class="keyword">file</span> <span class="string">"named.ca"</span>;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">zone <span class="string">"zts.local"</span> &#123;</div><div class="line">    <span class="keyword">type</span> master;</div><div class="line">    <span class="keyword">file</span> <span class="string">"zts.local.zone"</span>;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">zone <span class="string">"181.29.10.in-addr.arpa"</span> <span class="keyword">IN</span> &#123;</div><div class="line">        <span class="keyword">type</span> master;</div><div class="line">        <span class="keyword">file</span> <span class="string">"10.29.181.zone"</span>;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">include</span> <span class="string">"/etc/named.rfc1912.zones"</span>;</div><div class="line"><span class="keyword">include</span> <span class="string">"/etc/named.root.key"</span>;</div></pre></td></tr></table></figure>
<h3 id="7、-为-zts-local-域名创建转发域与反向域文件"><a href="#7、-为-zts-local-域名创建转发域与反向域文件" class="headerlink" title="7、 为 zts.local 域名创建转发域与反向域文件"></a>7、 为 zts.local 域名创建转发域与反向域文件</h3><h4 id="a-创建转发域"><a href="#a-创建转发域" class="headerlink" title="a)创建转发域"></a>a)创建转发域</h4><p><code>[root@nrozntgbd2 ~]# vi /var/named/chroot/var/named/zts.local.zone</code></p>
<p>添加如下内容并保存：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">$<span class="keyword">ORIGIN </span>zts.local.</div><div class="line">$TTL <span class="number">86400</span></div><div class="line"><span class="comment">;</span></div><div class="line"><span class="comment">;在zone的配置文件中，它是以分号来作为批注语句标识符的。</span></div><div class="line"><span class="comment">;修改这个配置文件时，要注意，名称最后面没有加句点的是主机名，最后面加了句点的是FQDN（除了$ORIGIN那里）。</span></div><div class="line"><span class="comment">;$ORIGIN那里填域名。下面的@符号会引用这里填写的值。如果不填，则会引用主配置文件中zone语句后面的值。</span></div><div class="line"><span class="comment">;$TTL表示timeto live值，表示当其它DNS查询到本zone的DNS记录时，这个记录能在它的DNS缓存中存在多久，单位为秒。</span></div><div class="line">@ IN SOA dns1.zts.local. roc.fly.qq.com.  (</div><div class="line">        <span class="number">2018111901</span></div><div class="line">        <span class="number">1</span>H</div><div class="line">        <span class="number">5</span>m</div><div class="line">        <span class="number">2</span>D</div><div class="line">        <span class="number">6</span>H )</div><div class="line"><span class="comment">;</span></div><div class="line"><span class="comment">;SOA后面的两个参数分别是主DNS服务器主机名和管理者邮箱(xie@zts.local)。因为@符号有特殊含义，所以写成这样。</span></div><div class="line"><span class="comment">;括号内的第一个参数是序号，代表本配置文档的新旧，序号越大，表示越新。每次修改本文档后，都要将这个值改大。</span></div><div class="line"><span class="comment">;第二个参数是刷新频率，表示slave隔多久会跟master比对一次配置档案，单位为秒。</span></div><div class="line"><span class="comment">;第三个参数是失败重新尝试时间，单位为秒</span></div><div class="line"><span class="comment">;第四个参数是失效时间，单位为秒。</span></div><div class="line"><span class="comment">;在BIND9中，第五个参数表示其它DNS服务器能缓存negative answers的时间，单位为秒。</span></div><div class="line"><span class="comment">;</span></div><div class="line"></div><div class="line"></div><div class="line">@ IN NS dns1.zts.local.</div><div class="line">  IN NS dns2.zts.local.</div><div class="line">dns1  IN  A  <span class="number">10</span>.<span class="number">29</span>.<span class="number">181</span>.<span class="number">61</span></div><div class="line">dns2  IN  A  <span class="number">10</span>.<span class="number">29</span>.<span class="number">181</span>.<span class="number">62</span></div><div class="line"><span class="comment">;</span></div><div class="line"><span class="comment">;类型NS定义指定域的DNS服务器主机名(如dns1.zts.local)，不管是主DNS还是从DNS。</span></div><div class="line"><span class="comment">;类型A定义指定主机(如dns1)的IP地址。如果是使用的IPv6地址，则需使用类型AAAA。</span></div><div class="line"><span class="comment">;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">;@  IN  MX  10  mail1.zts.local.</span></div><div class="line"><span class="comment">;   IN  MX  20  mail2.zts.local.</span></div><div class="line"><span class="comment">;mail1  IN  A  10.29.181.61</span></div><div class="line"><span class="comment">;mail2  IN  A  10.29.181.62</span></div><div class="line"><span class="comment">;</span></div><div class="line"><span class="comment">;类型MX定义指定域的邮件服务器主机名(如mail1.zts.local)。</span></div><div class="line"><span class="comment">;MX后面的数字为优先级，越小越优先。同样的优先级值则可以在多台邮件服务器之间进行负载分担。</span></div><div class="line"><span class="comment">;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">;www  IN  CNAME  servs.zts.local.</span></div><div class="line"><span class="comment">;ftp  IN  CNAME  servs.zts.local.</span></div><div class="line"><span class="comment">;servs  IN  A  10.29.181.6</span></div><div class="line"><span class="comment">;</span></div><div class="line"><span class="comment">;类型CNAME用于定义别名。通常用于同一台主机提供多个服务的情况。</span></div><div class="line"><span class="comment">;以这里的设定为例，当要解析ftp.zts.local的IP时，它会解析成主机servs.zts.local的IP。</span></div><div class="line"><span class="comment">;</span></div><div class="line"></div><div class="line"></div><div class="line">forum  IN  A   <span class="number">10</span>.<span class="number">29</span>.<span class="number">181</span>.<span class="number">61</span></div><div class="line"><span class="comment">;travel IN  A   10.29.181.8</span></div><div class="line"><span class="comment">;       IN  A   10.29.181.9</span></div><div class="line"><span class="comment">;</span></div><div class="line"><span class="comment">;如上面所示，也可以直接设定某一台主机(如forum.zts.local)的IP。</span></div><div class="line"><span class="comment">;同一台主机(如travel.zts.local)也可以设定多个IP。</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">; eureka cluster配置</span></div><div class="line">txt.<span class="keyword">shanghai </span>IN TXT <span class="string">"defaultZone.zts.local"</span></div><div class="line">txt.defaultZone IN TXT <span class="string">"10.29.181.56"</span> <span class="string">"10.29.181.57"</span> <span class="string">"10.29.181.58"</span> <span class="string">"10.29.181.60"</span></div><div class="line"></div><div class="line"><span class="comment">;通过查看Eureka的源码，它的实现是通过寻找txt.beijing-a.zts.local（txt.region.eureka-server-d-n-s-name）获取"beijing-a.zts.local" "beijing-b.zts.local"的zone：beijing-a和beijing-b，</span></div><div class="line"><span class="comment">;然后再去获取txt.beijing-a.zts.local和txt.beijing-b.zts.local中对应的ServiceUrls的数据，也就是IP地址: "10.29.181.61" "10.29.181.62"</span></div><div class="line"><span class="comment">;这样服务间就可以获取到固定端口下的不同IP的机器的注册中心服务地址，并相互注册</span></div><div class="line">txt.<span class="keyword">beijing </span>IN TXT <span class="string">"beijing-a.zts.local"</span> <span class="string">"beijing-b.zts.local"</span></div><div class="line">txt.<span class="keyword">beijing-a </span>IN TXT <span class="string">"10.29.181.61"</span> <span class="string">"10.29.181.62"</span></div><div class="line">txt.<span class="keyword">beijing-b </span>IN TXT <span class="string">"10.29.181.63"</span> <span class="string">"10.29.181.64"</span></div></pre></td></tr></table></figure></p>
<p>对区域文件进行有效性检查：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">named-checkzone</span> 181<span class="selector-class">.29</span><span class="selector-class">.10</span><span class="selector-class">.in-addr</span><span class="selector-class">.arpa</span> 10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.zone</span></div></pre></td></tr></table></figure></p>
<h4 id="b-创建反向域"><a href="#b-创建反向域" class="headerlink" title="b)创建反向域"></a>b)创建反向域</h4><p><code>[root@nrozntgbd2 ~]# vi /var/named/chroot/var/named/10.29.181.zone</code></p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">$ORIGIN <span class="number">181.29</span><span class="number">.10</span>.<span class="keyword">in</span><span class="params">-addr.arpa.</span></div><div class="line">$TTL <span class="number">86400</span></div><div class="line">;</div><div class="line">;在zone的配置文件中，它是以分号来作为批注语句标识符的。</div><div class="line">;修改这个配置文件时，要注意，名称最后面没有加句点的是主机名，最后面加了句点的是FQDN（除了$ORIGIN那里）。</div><div class="line">;$ORIGIN那里填域名。下面的@符号会引用这里填写的值。如果不填，则会引用主配置文件中zone语句后面的值。</div><div class="line">;$TTL表示timeto live值，表示当其它DNS查询到本zone的DNS记录时，这个记录能在它的DNS缓存中存在多久，单位为秒。</div><div class="line">@ <span class="keyword">IN</span> SOA dns1.zts.<span class="built_in">local</span>. roc.fly.qq.com. (</div><div class="line">        <span class="number">2018111902</span></div><div class="line">        <span class="number">1</span>H</div><div class="line">        <span class="number">5</span>m</div><div class="line">        <span class="number">2</span>D</div><div class="line">        <span class="number">6</span>H )</div><div class="line">;</div><div class="line">;SOA后面的两个参数分别是主DNS服务器主机名和管理者邮箱(xie@zts.<span class="built_in">local</span>)。因为@符号有特殊含义，所以写成这样。</div><div class="line">;括号内的第一个参数是序号，代表本配置文档的新旧，序号越大，表示越新。每次修改本文档后，都要将这个值改大。</div><div class="line">;第二个参数是刷新频率，表示slave隔多久会跟master比对一次配置档案，单位为秒。</div><div class="line">;第三个参数是失败重新尝试时间，单位为秒</div><div class="line">;第四个参数是失效时间，单位为秒。</div><div class="line">;在BIND9中，第五个参数表示其它DNS服务器能缓存negative answers的时间，单位为秒。</div><div class="line">;</div><div class="line"></div><div class="line">;<span class="number">61.181</span><span class="number">.29</span><span class="number">.10</span>.<span class="keyword">in</span><span class="params">-addr.arpa.</span> <span class="keyword">IN</span> PTR dns1.zts.<span class="built_in">local</span>.</div><div class="line">;<span class="number">62.181</span><span class="number">.29</span><span class="number">.10</span>.<span class="keyword">in</span><span class="params">-addr.arpa.</span> <span class="keyword">IN</span> PTR dns2.zts.<span class="built_in">local</span>.</div><div class="line">@  <span class="keyword">IN</span> NS  dns1.zts.<span class="built_in">local</span>.</div><div class="line">   <span class="keyword">IN</span> NS  dns2.zts.<span class="built_in">local</span>.</div><div class="line"><span class="number">61</span> <span class="keyword">IN</span> PTR dns1.zts.<span class="built_in">local</span>.</div><div class="line"><span class="number">62</span> <span class="keyword">IN</span> PTR dns2.zts.<span class="built_in">local</span>.</div></pre></td></tr></table></figure>
<p>对区域文件进行有效性检查：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">named-checkzone zts<span class="selector-class">.local</span> /var/named/chroot/var/named/zts<span class="selector-class">.local</span><span class="selector-class">.zone</span></div></pre></td></tr></table></figure></p>
<h3 id="8、启动-bind-chroot-服务"><a href="#8、启动-bind-chroot-服务" class="headerlink" title="8、启动 bind-chroot 服务"></a>8、启动 bind-chroot 服务</h3><p>启动named，日志可以在<code>/var/log/messages</code>下查看<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@nrozntgbd2 <span class="keyword">named</span>]# service <span class="keyword">named</span> restart</div><div class="line">Stopping <span class="keyword">named</span>: .                                          [  OK  ]</div><div class="line">Starting <span class="keyword">named</span>:                                            [  OK  ]</div><div class="line">[root@nrozntgbd2 <span class="keyword">named</span>]# vim /var/<span class="built_in">log</span>/messages</div></pre></td></tr></table></figure></p>
<p><strong>设置开机启动</strong><br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># centos 6</span></div><div class="line">chkconfig named <span class="keyword">on</span></div></pre></td></tr></table></figure></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># centos 7</span></div><div class="line">[root<span class="symbol">@nrozntgbd2</span> ~]<span class="meta"># /usr/libexec/setup-named-chroot.sh /var/named/chroot on</span></div><div class="line">[root<span class="symbol">@nrozntgbd2</span> ~]<span class="meta"># systemctl stop named</span></div><div class="line">[root<span class="symbol">@nrozntgbd2</span> ~]<span class="meta"># systemctl disable named</span></div><div class="line">[root<span class="symbol">@nrozntgbd2</span> ~]<span class="meta"># systemctl start named-chroot</span></div><div class="line">[root<span class="symbol">@nrozntgbd2</span> ~]<span class="meta"># systemctl enable named-chroot</span></div><div class="line">ln -s <span class="string">'/usr/lib/systemd/system/named-chroot.service'</span> <span class="string">'/etc/systemd/system/multi-user.target.wants/named-chroot.service'</span></div></pre></td></tr></table></figure>
<h3 id="9、搭建从DNS服务器"><a href="#9、搭建从DNS服务器" class="headerlink" title="9、搭建从DNS服务器"></a>9、搭建从DNS服务器</h3><h4 id="a-安装从DNS服务器"><a href="#a-安装从DNS服务器" class="headerlink" title="a)安装从DNS服务器"></a>a)安装从DNS服务器</h4><ul>
<li><p>1.<strong>重复步骤1-5</strong></p>
</li>
<li><p>2.编辑配置文件/var/named/chroot/etc/named.conf，找到listen-on这一行，改为：</p>
</li>
</ul>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">listen-<span class="keyword">on</span> port <span class="number">53</span> &#123; any; &#125;; <span class="comment">#any是匹配所有的意思</span></div></pre></td></tr></table></figure>
<ul>
<li>3.找到allow-query这一行，改为：</li>
</ul>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">allow-query     &#123; any<span class="comment">; &#125;;</span></div></pre></td></tr></table></figure>
<ul>
<li><p>4.在/var/named/chroot/etc/named.conf中增加区域配置</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">zone <span class="string">"zts.local"</span> &#123;</div><div class="line">    type slave;</div><div class="line">    file <span class="string">"zts.local.zone"</span>; ###将同步后的文件放置在哪里，这里是/var/named/</div><div class="line">    masters &#123; <span class="number">10.29</span><span class="number">.181</span><span class="number">.61</span>; &#125;;         ###指定主服务器的ip地址</div><div class="line">&#125;;</div><div class="line"></div><div class="line">zone <span class="string">"181.29.10.in-addr.arpa"</span> IN &#123;</div><div class="line">        type slave;</div><div class="line">        file <span class="string">"10.29.181.zone"</span>;</div><div class="line">        masters &#123; <span class="number">10.29</span><span class="number">.181</span><span class="number">.61</span>; &#125;;         ###指定主服务器的ip地址</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
</li>
<li><p>5.修改权限(建议同时修改主、从DNS服务器)</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chown <span class="keyword">named</span>:<span class="keyword">named</span> /var/<span class="keyword">named</span>/chroot/var/<span class="keyword">named</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="b-修改主DNS服务器配置"><a href="#b-修改主DNS服务器配置" class="headerlink" title="b)修改主DNS服务器配置"></a>b)修改主DNS服务器配置</h4><p>修改<code>/var/named/chroot/etc/named.conf</code>，并验证：<code>named-checkconf named.conf</code></p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">zone <span class="string">"zts.local"</span> &#123;</div><div class="line">    type master;</div><div class="line">    file <span class="string">"zts.local.zone"</span>;</div><div class="line">    allow-transfer &#123; <span class="number">10.29</span><span class="number">.181</span><span class="number">.62</span>; &#125;;               <span class="comment">//指定这个域的从DNS服务器的IP</span></div><div class="line">    allow-query &#123; any; &#125;;                           <span class="comment">//允许来自任意IP对这个域的解析请求</span></div><div class="line">    notify yes;</div><div class="line">    also-notify  &#123; <span class="number">10.29</span><span class="number">.181</span><span class="number">.62</span>; &#125;;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">zone <span class="string">"181.29.10.in-addr.arpa"</span> IN &#123;</div><div class="line">        type master;</div><div class="line">        file <span class="string">"10.29.181.zone"</span>;</div><div class="line">        allow-transfer &#123; <span class="number">10.29</span><span class="number">.181</span><span class="number">.62</span>; &#125;;              <span class="comment">//指定这个域的从DNS服务器的IP</span></div><div class="line">        allow-query &#123; any; &#125;;                           <span class="comment">//允许来自任意IP对这个域的解析请求</span></div><div class="line">        notify yes;</div><div class="line">        also-notify  &#123; <span class="number">10.29</span><span class="number">.181</span><span class="number">.62</span>; &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="c-重启主、从DNS服务器"><a href="#c-重启主、从DNS服务器" class="headerlink" title="c)重启主、从DNS服务器"></a>c)重启主、从DNS服务器</h4><ul>
<li>1.重启主服务器：<code>service named restart</code></li>
<li>2.重启从服务器：<code>service named restart</code></li>
<li>3.若报错，可检查日志文件<code>vim /var/log/messages</code>，这里我们检查下从服务器同步日志</li>
</ul>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: adjusted limit on open files from <span class="number">100000</span> to <span class="number">1048576</span></div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: found <span class="number">8</span> CPUs, using <span class="number">8</span> worker threads</div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: using <span class="meta">up</span> to <span class="number">4096</span> sockets</div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: loading configuration from <span class="string">'/etc/named.conf'</span></div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: reading built-<span class="keyword">in</span> trusted keys from file <span class="string">'/etc/named.iscdlv.key'</span></div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: using <span class="meta">default</span> UDP/IPv4 port range: [<span class="number">1024</span>, <span class="number">65535</span>]</div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: using <span class="meta">default</span> UDP/IPv6 port range: [<span class="number">1024</span>, <span class="number">65535</span>]</div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: listening on IPv4 interface lo, <span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>#<span class="number">53</span></div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: listening on IPv4 interface eth3, <span class="number">10.29</span><span class="meta">.181</span><span class="meta">.62</span>#<span class="number">53</span></div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: listening on IPv6 interface lo, ::<span class="number">1</span>#<span class="number">53</span></div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: generating session key for dynamic DNS</div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: sizing zone task pool based on <span class="number">7</span> zones</div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: set <span class="meta">up</span> managed keys zone for view _<span class="meta">default</span>, file <span class="string">'/var/named/dynamic/managed-keys.bind'</span></div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: Warning: <span class="string">'empty-zones-enable/disable-empty-zone'</span> <span class="keyword">not</span> set: disabling RFC <span class="number">1918</span> empty zones</div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: automatic empty zone: <span class="number">127.</span><span class="keyword">IN</span>-ADDR.ARPA</div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: automatic empty zone: <span class="number">254.169</span>.IN-ADDR.ARPA</div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: automatic empty zone: <span class="number">2.0</span><span class="meta">.192</span>.IN-ADDR.ARPA</div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: automatic empty zone: <span class="number">100.51</span><span class="meta">.198</span>.IN-ADDR.ARPA</div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: automatic empty zone: <span class="number">113.0</span><span class="meta">.203</span>.IN-ADDR.ARPA</div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: automatic empty zone: <span class="number">255.255</span><span class="meta">.255</span><span class="meta">.255</span>.IN-ADDR.ARPA</div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: automatic empty zone: <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span>.IP6.ARPA</div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: automatic empty zone: D.F.IP6.ARPA</div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: automatic empty zone: <span class="number">8.</span>E.F.IP6.ARPA</div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: automatic empty zone: <span class="number">9.</span>E.F.IP6.ARPA</div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: automatic empty zone: A.E.F.IP6.ARPA</div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: automatic empty zone: B.E.F.IP6.ARPA</div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: automatic empty zone: <span class="number">8.</span>B.D<span class="meta">.0</span><span class="meta">.1</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.2</span>.IP6.ARPA</div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: command channel listening on <span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>#<span class="number">953</span></div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: command channel listening on ::<span class="number">1</span>#<span class="number">953</span></div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: zone <span class="number">0.</span><span class="keyword">in</span>-addr.arpa/<span class="keyword">IN</span>: loaded serial <span class="number">0</span></div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: zone <span class="number">1.0</span><span class="meta">.0</span><span class="meta">.127</span>.in-addr.arpa/<span class="keyword">IN</span>: loaded serial <span class="number">0</span></div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: zone <span class="number">1.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span><span class="meta">.0</span>.ip6.arpa/<span class="keyword">IN</span>: loaded serial <span class="number">0</span></div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: zone zts.local/<span class="keyword">IN</span>: loaded serial <span class="number">2018111901</span></div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: zone localhost.localdomain/<span class="keyword">IN</span>: loaded serial <span class="number">0</span></div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: zone localhost/<span class="keyword">IN</span>: loaded serial <span class="number">0</span></div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: managed-keys-zone ./<span class="keyword">IN</span>: loaded serial <span class="number">2</span></div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: running</div><div class="line">Nov <span class="number">19</span> <span class="number">21</span>:<span class="number">06</span>:<span class="number">40</span> nrozntgbd3 named[<span class="number">90312</span>]: zone zts.local/<span class="keyword">IN</span>: sending notifies (serial <span class="number">2018111901</span>)</div></pre></td></tr></table></figure>
<ul>
<li>4.检查从服务器<code>/var/named/chroot/var/named/zts.local.zone</code>、<code>/var/named/chroot/var/named/10.29.181.zone</code>文件是否生成。</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="selector-attr">[root@nrozntgbd3 named]</span># <span class="selector-tag">ls</span> <span class="selector-tag">-alh</span></div><div class="line"><span class="selector-tag">total</span> 48<span class="selector-tag">K</span></div><div class="line"><span class="selector-tag">drwxr-xr-x</span> 5 <span class="selector-tag">named</span> <span class="selector-tag">named</span> 4<span class="selector-class">.0K</span> <span class="selector-tag">Nov</span> 19 21<span class="selector-pseudo">:06</span> .</div><div class="line"><span class="selector-tag">drwxr-x---</span> 6 <span class="selector-tag">root</span>  <span class="selector-tag">named</span> 4<span class="selector-class">.0K</span> <span class="selector-tag">Nov</span> 19 20<span class="selector-pseudo">:48</span> ..</div><div class="line"><span class="selector-tag">drwxrwxrwx</span> 2 <span class="selector-tag">root</span>  <span class="selector-tag">root</span>  4<span class="selector-class">.0K</span> <span class="selector-tag">Nov</span> 19 20<span class="selector-pseudo">:48</span> <span class="selector-tag">data</span></div><div class="line"><span class="selector-tag">drwxrwxrwx</span> 2 <span class="selector-tag">root</span>  <span class="selector-tag">root</span>  4<span class="selector-class">.0K</span> <span class="selector-tag">Nov</span> 19 20<span class="selector-pseudo">:58</span> <span class="selector-tag">dynamic</span></div><div class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">root</span>  <span class="selector-tag">root</span>    56 <span class="selector-tag">Nov</span> 19 20<span class="selector-pseudo">:48</span> <span class="selector-tag">my</span><span class="selector-class">.external</span><span class="selector-class">.zone</span><span class="selector-class">.db</span></div><div class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">root</span>  <span class="selector-tag">root</span>    56 <span class="selector-tag">Nov</span> 19 20<span class="selector-pseudo">:48</span> <span class="selector-tag">my</span><span class="selector-class">.internal</span><span class="selector-class">.zone</span><span class="selector-class">.db</span></div><div class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">root</span>  <span class="selector-tag">root</span>  3<span class="selector-class">.3K</span> <span class="selector-tag">Nov</span> 19 20<span class="selector-pseudo">:48</span> <span class="selector-tag">named</span><span class="selector-class">.ca</span></div><div class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">root</span>  <span class="selector-tag">root</span>   152 <span class="selector-tag">Nov</span> 19 20<span class="selector-pseudo">:48</span> <span class="selector-tag">named</span><span class="selector-class">.empty</span></div><div class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">root</span>  <span class="selector-tag">root</span>   152 <span class="selector-tag">Nov</span> 19 20<span class="selector-pseudo">:48</span> <span class="selector-tag">named</span><span class="selector-class">.localhost</span></div><div class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">root</span>  <span class="selector-tag">root</span>   168 <span class="selector-tag">Nov</span> 19 20<span class="selector-pseudo">:48</span> <span class="selector-tag">named</span><span class="selector-class">.loopback</span></div><div class="line"><span class="selector-tag">drwxr-xr-x</span> 2 <span class="selector-tag">root</span>  <span class="selector-tag">root</span>  4<span class="selector-class">.0K</span> <span class="selector-tag">Nov</span> 19 20<span class="selector-pseudo">:48</span> <span class="selector-tag">slaves</span></div><div class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">named</span> <span class="selector-tag">named</span>  660 <span class="selector-tag">Nov</span> 19 21<span class="selector-pseudo">:12</span> <span class="selector-tag">zts</span><span class="selector-class">.local</span><span class="selector-class">.zone</span> (&lt;<span class="selector-tag">------</span>看，已经自动生成了)</div></pre></td></tr></table></figure>
<h3 id="9、测试"><a href="#9、测试" class="headerlink" title="9、测试"></a>9、测试</h3><p>登录10.29.181.62，修改DNS服务器地址<code>vim /etc/resolv.conf</code>(这种方式是临时的，重启网卡后，就刷新掉了)：</p>
<p><code>[root@nrozntgbd3 roc]# vim /etc/resolv.conf</code></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="selector-id">#search</span> <span class="selector-tag">xx</span><span class="selector-class">.zts</span><span class="selector-class">.com</span></div><div class="line"><span class="selector-tag">nameserver</span>      10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.61</span></div></pre></td></tr></table></figure>
<blockquote>
<p>建议使用修改网卡的dns的方式：vim /etc/sysconfig/network-scripts/ifcfg-eth0，这种方式会永久设定dns</p>
</blockquote>
<p><strong>使用dig测试</strong></p>
<p>注意查看<code>;; ANSWER SECTION:</code>输出</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="selector-attr">[root@nrozntgbd3 roc]</span># <span class="selector-tag">dig</span> <span class="selector-tag">-t</span> <span class="selector-tag">A</span> <span class="selector-tag">forum</span><span class="selector-class">.zts</span><span class="selector-class">.local</span> @<span class="keyword">10</span>.<span class="keyword">29</span>.<span class="keyword">181</span>.<span class="keyword">61</span></div><div class="line"></div><div class="line">; &lt;&lt;&gt;&gt; <span class="selector-tag">DiG</span> 9<span class="selector-class">.8</span><span class="selector-class">.2rc1-RedHat-9</span><span class="selector-class">.8</span><span class="selector-class">.2-0</span><span class="selector-class">.68</span><span class="selector-class">.rc1</span><span class="selector-class">.el6_10</span><span class="selector-class">.1</span> &lt;&lt;&gt;&gt; <span class="selector-tag">-t</span> <span class="selector-tag">A</span> <span class="selector-tag">forum</span><span class="selector-class">.zts</span><span class="selector-class">.local</span> @<span class="keyword">10</span>.<span class="keyword">29</span>.<span class="keyword">181</span>.<span class="keyword">61</span></div><div class="line">;; <span class="selector-tag">global</span> <span class="selector-tag">options</span>: +<span class="selector-tag">cmd</span></div><div class="line">;; <span class="selector-tag">Got</span> <span class="selector-tag">answer</span>:</div><div class="line">;; <span class="selector-tag">-</span>&gt;&gt;<span class="selector-tag">HEADER</span>&lt;&lt;<span class="selector-tag">-</span> <span class="selector-tag">opcode</span>: <span class="selector-tag">QUERY</span>, <span class="selector-tag">status</span>: <span class="selector-tag">NOERROR</span>, <span class="selector-tag">id</span>: 35607</div><div class="line">;; <span class="selector-tag">flags</span>: <span class="selector-tag">qr</span> <span class="selector-tag">aa</span> <span class="selector-tag">rd</span> <span class="selector-tag">ra</span>; <span class="selector-tag">QUERY</span>: 1, <span class="selector-tag">ANSWER</span>: 1, <span class="selector-tag">AUTHORITY</span>: 2, <span class="selector-tag">ADDITIONAL</span>: 2</div><div class="line"></div><div class="line">;; <span class="selector-tag">QUESTION</span> <span class="selector-tag">SECTION</span>:</div><div class="line">;<span class="selector-tag">forum</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>.		<span class="selector-tag">IN</span>	<span class="selector-tag">A</span></div><div class="line"></div><div class="line">;; <span class="selector-tag">ANSWER</span> <span class="selector-tag">SECTION</span>:</div><div class="line"><span class="selector-tag">forum</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>.	86400	<span class="selector-tag">IN</span>	<span class="selector-tag">A</span>	10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.61</span> (&lt;<span class="selector-tag">-------</span>看这个输出)</div><div class="line"></div><div class="line">;; <span class="selector-tag">AUTHORITY</span> <span class="selector-tag">SECTION</span>:</div><div class="line"><span class="selector-tag">zts</span><span class="selector-class">.local</span>.		86400	<span class="selector-tag">IN</span>	<span class="selector-tag">NS</span>	<span class="selector-tag">dns1</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>.</div><div class="line"><span class="selector-tag">zts</span><span class="selector-class">.local</span>.		86400	<span class="selector-tag">IN</span>	<span class="selector-tag">NS</span>	<span class="selector-tag">dns2</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>.</div><div class="line"></div><div class="line">;; <span class="selector-tag">ADDITIONAL</span> <span class="selector-tag">SECTION</span>:</div><div class="line"><span class="selector-tag">dns1</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>.		86400	<span class="selector-tag">IN</span>	<span class="selector-tag">A</span>	10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.61</span></div><div class="line"><span class="selector-tag">dns2</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>.		86400	<span class="selector-tag">IN</span>	<span class="selector-tag">A</span>	10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.62</span></div><div class="line"></div><div class="line">;; <span class="selector-tag">Query</span> <span class="selector-tag">time</span>: 0 <span class="selector-tag">msec</span></div><div class="line">;; <span class="selector-tag">SERVER</span>: 10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.61</span><span class="selector-id">#53</span>(10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.61</span>)</div><div class="line">;; <span class="selector-tag">WHEN</span>: <span class="selector-tag">Mon</span> <span class="selector-tag">Nov</span> 19 20<span class="selector-pseudo">:24</span><span class="selector-pseudo">:11</span> 2018</div><div class="line">;; <span class="selector-tag">MSG</span> <span class="selector-tag">SIZE</span>  <span class="selector-tag">rcvd</span>: 119</div><div class="line"></div><div class="line"><span class="selector-attr">[root@nrozntgbd3 roc]</span># <span class="selector-tag">dig</span> <span class="selector-tag">-t</span> <span class="selector-tag">TXT</span> <span class="selector-tag">txt</span><span class="selector-class">.shanghai</span><span class="selector-class">.zts</span><span class="selector-class">.local</span></div><div class="line"></div><div class="line">; &lt;&lt;&gt;&gt; <span class="selector-tag">DiG</span> 9<span class="selector-class">.8</span><span class="selector-class">.2rc1-RedHat-9</span><span class="selector-class">.8</span><span class="selector-class">.2-0</span><span class="selector-class">.68</span><span class="selector-class">.rc1</span><span class="selector-class">.el6_10</span><span class="selector-class">.1</span> &lt;&lt;&gt;&gt; <span class="selector-tag">-t</span> <span class="selector-tag">TXT</span> <span class="selector-tag">txt</span><span class="selector-class">.shanghai</span><span class="selector-class">.zts</span><span class="selector-class">.local</span></div><div class="line">;; <span class="selector-tag">global</span> <span class="selector-tag">options</span>: +<span class="selector-tag">cmd</span></div><div class="line">;; <span class="selector-tag">Got</span> <span class="selector-tag">answer</span>:</div><div class="line">;; <span class="selector-tag">-</span>&gt;&gt;<span class="selector-tag">HEADER</span>&lt;&lt;<span class="selector-tag">-</span> <span class="selector-tag">opcode</span>: <span class="selector-tag">QUERY</span>, <span class="selector-tag">status</span>: <span class="selector-tag">NOERROR</span>, <span class="selector-tag">id</span>: 19185</div><div class="line">;; <span class="selector-tag">flags</span>: <span class="selector-tag">qr</span> <span class="selector-tag">aa</span> <span class="selector-tag">rd</span> <span class="selector-tag">ra</span>; <span class="selector-tag">QUERY</span>: 1, <span class="selector-tag">ANSWER</span>: 1, <span class="selector-tag">AUTHORITY</span>: 2, <span class="selector-tag">ADDITIONAL</span>: 2</div><div class="line"></div><div class="line">;; <span class="selector-tag">QUESTION</span> <span class="selector-tag">SECTION</span>:</div><div class="line">;<span class="selector-tag">txt</span><span class="selector-class">.shanghai</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>.		<span class="selector-tag">IN</span>	<span class="selector-tag">TXT</span></div><div class="line"></div><div class="line">;; <span class="selector-tag">ANSWER</span> <span class="selector-tag">SECTION</span>:</div><div class="line"><span class="selector-tag">txt</span><span class="selector-class">.shanghai</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>.	86400	<span class="selector-tag">IN</span>	<span class="selector-tag">TXT</span>	"<span class="selector-tag">defaultZone</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>"  (&lt;<span class="selector-tag">-------</span>看这个输出)</div><div class="line"></div><div class="line">;; <span class="selector-tag">AUTHORITY</span> <span class="selector-tag">SECTION</span>:</div><div class="line"><span class="selector-tag">zts</span><span class="selector-class">.local</span>.		86400	<span class="selector-tag">IN</span>	<span class="selector-tag">NS</span>	<span class="selector-tag">dns2</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>.</div><div class="line"><span class="selector-tag">zts</span><span class="selector-class">.local</span>.		86400	<span class="selector-tag">IN</span>	<span class="selector-tag">NS</span>	<span class="selector-tag">dns1</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>.</div><div class="line"></div><div class="line">;; <span class="selector-tag">ADDITIONAL</span> <span class="selector-tag">SECTION</span>:</div><div class="line"><span class="selector-tag">dns1</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>.		86400	<span class="selector-tag">IN</span>	<span class="selector-tag">A</span>	10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.61</span></div><div class="line"><span class="selector-tag">dns2</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>.		86400	<span class="selector-tag">IN</span>	<span class="selector-tag">A</span>	10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.62</span></div><div class="line"></div><div class="line">;; <span class="selector-tag">Query</span> <span class="selector-tag">time</span>: 0 <span class="selector-tag">msec</span></div><div class="line">;; <span class="selector-tag">SERVER</span>: 10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.61</span><span class="selector-id">#53</span>(10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.61</span>)</div><div class="line">;; <span class="selector-tag">WHEN</span>: <span class="selector-tag">Mon</span> <span class="selector-tag">Nov</span> 19 20<span class="selector-pseudo">:24</span><span class="selector-pseudo">:22</span> 2018</div><div class="line">;; <span class="selector-tag">MSG</span> <span class="selector-tag">SIZE</span>  <span class="selector-tag">rcvd</span>: 144</div></pre></td></tr></table></figure>
<p><strong>使用nslookup测试</strong></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@nrozntgbd3 named]<span class="comment"># nslookup </span></div><div class="line">&gt; <span class="keyword">set</span> queryType=TXT</div><div class="line">&gt; txt.shanghai.zts.<span class="keyword">local</span></div><div class="line">Server:		<span class="number">10.29</span><span class="number">.181</span><span class="number">.61</span></div><div class="line">Address:	<span class="number">10.29</span><span class="number">.181</span><span class="number">.61</span><span class="comment">#53</span></div><div class="line"></div><div class="line">txt.shanghai.zts.<span class="keyword">local</span>	<span class="built_in">text</span> = <span class="string">"defaultZone.zts.local"</span></div><div class="line">&gt; txt.beijing.zts.<span class="keyword">local</span></div><div class="line">Server:		<span class="number">10.29</span><span class="number">.181</span><span class="number">.61</span></div><div class="line">Address:	<span class="number">10.29</span><span class="number">.181</span><span class="number">.61</span><span class="comment">#53</span></div><div class="line"></div><div class="line">txt.beijing.zts.<span class="keyword">local</span>	<span class="built_in">text</span> = <span class="string">"beijing-a.zts.local"</span> <span class="string">"beijing-b.zts.local"</span></div></pre></td></tr></table></figure>
<p><strong>测试反向代理</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="selector-attr">[root@nrozntgbd3 roc]</span># <span class="selector-tag">dig</span> <span class="selector-tag">-x</span> 10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.61</span> @<span class="keyword">10</span>.<span class="keyword">29</span>.<span class="keyword">181</span>.<span class="keyword">61</span></div><div class="line"></div><div class="line">; &lt;&lt;&gt;&gt; <span class="selector-tag">DiG</span> 9<span class="selector-class">.8</span><span class="selector-class">.2rc1-RedHat-9</span><span class="selector-class">.8</span><span class="selector-class">.2-0</span><span class="selector-class">.68</span><span class="selector-class">.rc1</span><span class="selector-class">.el6_10</span><span class="selector-class">.1</span> &lt;&lt;&gt;&gt; <span class="selector-tag">-x</span> 10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.61</span> @<span class="keyword">10</span>.<span class="keyword">29</span>.<span class="keyword">181</span>.<span class="keyword">61</span></div><div class="line">;; <span class="selector-tag">global</span> <span class="selector-tag">options</span>: +<span class="selector-tag">cmd</span></div><div class="line">;; <span class="selector-tag">Got</span> <span class="selector-tag">answer</span>:</div><div class="line">;; <span class="selector-tag">-</span>&gt;&gt;<span class="selector-tag">HEADER</span>&lt;&lt;<span class="selector-tag">-</span> <span class="selector-tag">opcode</span>: <span class="selector-tag">QUERY</span>, <span class="selector-tag">status</span>: <span class="selector-tag">NOERROR</span>, <span class="selector-tag">id</span>: 55778</div><div class="line">;; <span class="selector-tag">flags</span>: <span class="selector-tag">qr</span> <span class="selector-tag">aa</span> <span class="selector-tag">rd</span> <span class="selector-tag">ra</span>; <span class="selector-tag">QUERY</span>: 1, <span class="selector-tag">ANSWER</span>: 1, <span class="selector-tag">AUTHORITY</span>: 2, <span class="selector-tag">ADDITIONAL</span>: 2</div><div class="line"></div><div class="line">;; <span class="selector-tag">QUESTION</span> <span class="selector-tag">SECTION</span>:</div><div class="line">;61<span class="selector-class">.181</span><span class="selector-class">.29</span><span class="selector-class">.10</span><span class="selector-class">.in-addr</span><span class="selector-class">.arpa</span>.	<span class="selector-tag">IN</span>	<span class="selector-tag">PTR</span></div><div class="line"></div><div class="line">;; <span class="selector-tag">ANSWER</span> <span class="selector-tag">SECTION</span>:</div><div class="line">61<span class="selector-class">.181</span><span class="selector-class">.29</span><span class="selector-class">.10</span><span class="selector-class">.in-addr</span><span class="selector-class">.arpa</span>. 86400 <span class="selector-tag">IN</span>	<span class="selector-tag">PTR</span>	<span class="selector-tag">dns1</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>.</div><div class="line"></div><div class="line">;; <span class="selector-tag">AUTHORITY</span> <span class="selector-tag">SECTION</span>:</div><div class="line">181<span class="selector-class">.29</span><span class="selector-class">.10</span><span class="selector-class">.in-addr</span><span class="selector-class">.arpa</span>.	86400	<span class="selector-tag">IN</span>	<span class="selector-tag">NS</span>	<span class="selector-tag">dns1</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>.</div><div class="line">181<span class="selector-class">.29</span><span class="selector-class">.10</span><span class="selector-class">.in-addr</span><span class="selector-class">.arpa</span>.	86400	<span class="selector-tag">IN</span>	<span class="selector-tag">NS</span>	<span class="selector-tag">dns2</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>.</div><div class="line"></div><div class="line">;; <span class="selector-tag">ADDITIONAL</span> <span class="selector-tag">SECTION</span>:</div><div class="line"><span class="selector-tag">dns1</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>.		86400	<span class="selector-tag">IN</span>	<span class="selector-tag">A</span>	10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.61</span></div><div class="line"><span class="selector-tag">dns2</span><span class="selector-class">.zts</span><span class="selector-class">.local</span>.		86400	<span class="selector-tag">IN</span>	<span class="selector-tag">A</span>	10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.62</span></div><div class="line"></div><div class="line">;; <span class="selector-tag">Query</span> <span class="selector-tag">time</span>: 0 <span class="selector-tag">msec</span></div><div class="line">;; <span class="selector-tag">SERVER</span>: 10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.61</span><span class="selector-id">#53</span>(10<span class="selector-class">.29</span><span class="selector-class">.181</span><span class="selector-class">.61</span>)</div><div class="line">;; <span class="selector-tag">WHEN</span>: <span class="selector-tag">Mon</span> <span class="selector-tag">Nov</span> 19 20<span class="selector-pseudo">:27</span><span class="selector-pseudo">:42</span> 2018</div><div class="line">;; <span class="selector-tag">MSG</span> <span class="selector-tag">SIZE</span>  <span class="selector-tag">rcvd</span>: 136</div></pre></td></tr></table></figure>
<p><strong>解析内部、外部域名</strong></p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[root@nrozntgbd3 roc]<span class="meta"># nslookup forum.zts.local </span></div><div class="line"><span class="symbol">Server:</span>		<span class="number">10.29</span><span class="number">.181</span><span class="number">.61</span></div><div class="line"><span class="symbol">Address:</span>	<span class="number">10.29</span><span class="number">.181</span><span class="number">.61</span><span class="meta">#53</span></div><div class="line"></div><div class="line"><span class="symbol">Name:</span>	forum.zts.local</div><div class="line"><span class="symbol">Address:</span> <span class="number">10.29</span><span class="number">.181</span><span class="number">.61</span></div><div class="line"></div><div class="line">[root@nrozntgbd3 roc]<span class="meta"># nslookup www.baidu.com</span></div><div class="line"><span class="symbol">Server:</span>		<span class="number">10.29</span><span class="number">.181</span><span class="number">.61</span></div><div class="line"><span class="symbol">Address:</span>	<span class="number">10.29</span><span class="number">.181</span><span class="number">.61</span><span class="meta">#53</span></div><div class="line"></div><div class="line">Non-authoritative answer:</div><div class="line">www.baidu.com	canonical name = www.a.shifen.com.</div><div class="line"><span class="symbol">Name:</span>	www.a.shifen.com</div><div class="line"><span class="symbol">Address:</span> <span class="number">115.239</span><span class="number">.211</span><span class="number">.112</span></div><div class="line"><span class="symbol">Name:</span>	www.a.shifen.com</div><div class="line"><span class="symbol">Address:</span> <span class="number">115.239</span><span class="number">.210</span><span class="number">.27</span></div></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://www.linuxprobe.com/centos7-chroot-bind-dns.html://www.linuxprobe.com/centos7-chroot-bind-dns.html" target="_blank" rel="external">在 CentOS7.0 上搭建DNS服务器</a></li>
<li><a href="https://www.liuliya.com/archive/761.html" target="_blank" rel="external">Centos7上搭建DNS服务</a></li>
<li><a href="https://blog.csdn.net/huluedeai/article/details/50674286" target="_blank" rel="external">Linux命令学习之nslookup</a></li>
<li><a href="http://blog.51cto.com/vinsent/1967876" target="_blank" rel="external">搭建一个互联网DNS服务器架构</a></li>
<li><a href="https://blog.csdn.net/yelllowcong/article/details/78823520" target="_blank" rel="external">CentOS之DNS服务器安装-yellowcong</a></li>
<li><a href="https://blog.csdn.net/xiaoyuanfannao/article/details/82885120" target="_blank" rel="external">centos7搭建主从DNS服务器</a></li>
<li><a href="https://blog.csdn.net/weixin_41004350/article/details/79107732" target="_blank" rel="external">Centos7 搭建DNS服务器与原理配置详解</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      DNS（Domain Name Server，域名服务器）是进行域名(domain name)和与之相对应的IP地址 (IP address)转换的服务器。DNS中保存了一张域名(domain name)和与之相对应的IP地址 (IP address)的表，以解析消息的域名。 域名是Internet上某一台计算机或计算机组的名称，用于在数据传输时标识计算机的电子方位（有时也指地理位置）。域名是由一串用点分隔的名字组成的，通常包含组织名，而且始终包括两到三个字母的后缀，以指明组织的类型或该域所在的国家或地区。
    
    </summary>
    
      <category term="Linux" scheme="https://roc-wong.github.io/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://roc-wong.github.io/tags/Linux/"/>
    
      <category term="Shell" scheme="https://roc-wong.github.io/tags/Shell/"/>
    
  </entry>
  
  <entry>
    <title>bash-support.vim-Bash-IDE</title>
    <link href="https://roc-wong.github.io/blog/2018/02/bash-support-vim-Bash-IDE.html"/>
    <id>https://roc-wong.github.io/blog/2018/02/bash-support-vim-Bash-IDE.html</id>
    <published>2018-02-12T07:10:46.000Z</published>
    <updated>2018-11-21T02:18:25.563Z</updated>
    
    <content type="html"><![CDATA[<p>IDE（集成开发环境）就是这样一个软件，它为了最大化程序员生产效率，提供了很多编程所需的设施和组件。 IDE 将所有开发工作集中到一个程序中，使得程序员可以编写、修改、编译、部署以及调试程序。</p>
<p>在这篇文章中，我们会介绍如何通过使用 bash-support vim 插件将 Vim 编辑器安装和配置 为一个编写 Bash 脚本的 IDE。</p>
<a id="more"></a>
<p>一键安装Bash-support脚本：</p>
<blockquote>
<ul>
<li><a href="https://github.com/roc-wong/shell-tools/blob/master/xpress_install/bash_support.sh" target="_blank" rel="external">https://github.com/roc-wong/shell-tools/blob/master/xpress_install/bash_support.sh</a></li>
</ul>
</blockquote>
<p>本篇博客整理自Linux中国：</p>
<blockquote>
<ul>
<li><a href="https://linux.cn/article-8467-1.html" target="_blank" rel="external">如何用bash-support插件将Vim编辑器打造成编写Bash脚本的IDE</a></li>
</ul>
</blockquote>
<h2 id="什么是-bash-support-vim-插件"><a href="#什么是-bash-support-vim-插件" class="headerlink" title="什么是 bash-support.vim 插件"></a>什么是 bash-support.vim 插件</h2><p>bash-support 是一个高度定制化的 vim 插件，它允许你插入：文件头、补全语句、注释、函数、以及代码块。它也使你可以进行语法检查、使脚本可执行、一键启动调试器；而完成所有的这些而不需要关闭编辑器。</p>
<p>它使用快捷键（映射），通过有组织地、一致的文件内容编写/插入，使得 bash 脚本编程变得有趣和愉快。</p>
<p>插件当前版本是 4.3，4.0 版本 重写了之前的 3.12.1 版本，4.0 及之后的版本基于一个全新的、更强大的、和之前版本模板语法不同的模板系统。</p>
<h2 id="如何在-Linux-中安装-Bash-support-插件"><a href="#如何在-Linux-中安装-Bash-support-插件" class="headerlink" title="如何在 Linux 中安装 Bash-support 插件"></a>如何在 Linux 中安装 Bash-support 插件</h2><p>用下面的命令下载最新版本的 bash-support 插件：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>cd Downloads</div><div class="line"><span class="variable">$ </span>curl <span class="symbol">http:</span>/<span class="regexp">/www.vim.org/scripts</span><span class="regexp">/download_script.php?src_id=24452 &gt;bash-support.zip</span></div></pre></td></tr></table></figure>
<p>按照如下步骤安装；在你的主目录创建 .vim 目录（如果它不存在的话），进入该目录并提取 bash-support.zip 内容：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ mkdir ~/<span class="selector-class">.vim</span></div><div class="line">$ cd <span class="selector-class">.vim</span></div><div class="line">$ unzip ~/Downloads/bash-support.zip</div></pre></td></tr></table></figure>
<p>下一步，在 .vimrc 文件中激活它：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>vi ~<span class="regexp">/.vimrc</span></div></pre></td></tr></table></figure>
<p>并插入下面一行：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">filetype plug-<span class="keyword">in</span> <span class="keyword">on</span>   </div><div class="line"><span class="keyword">set</span> <span class="built_in">number</span>   <span class="comment"># 可选，增加这行以在 vim 中显示行号</span></div></pre></td></tr></table></figure>
<h2 id="如何在-Vim-编辑器中使用-Bash-support-插件"><a href="#如何在-Vim-编辑器中使用-Bash-support-插件" class="headerlink" title="如何在 Vim 编辑器中使用 Bash-support 插件"></a>如何在 Vim 编辑器中使用 Bash-support 插件</h2><p>为了简化使用，通常使用的结构和特定操作可以分别通过键映射来插入/执行。 ~/.vim/doc/bashsupport.txt 和 ~/.vim/bash-support/doc/bash-hotkeys.pdf 或者 ~/.vim/bash-support/doc/bash-hotkeys.tex 文件中介绍了映射。</p>
<p><strong>重要</strong>：</p>
<ol>
<li><strong>所有映射（+字符 组合）都是针对特定文件类型的：为了避免和其它插件的映射冲突，它们只适用于 sh 文件。</strong></li>
<li><strong>使用键映射的时候打字速度也有关系，引导符”\”和后面字符的组合要在特定短时间内才能识别出来（很可能少于 3 秒 - 基于假设）。</strong></li>
</ol>
<h2 id="如何为新脚本自动生成文件头"><a href="#如何为新脚本自动生成文件头" class="headerlink" title="如何为新脚本自动生成文件头"></a>如何为新脚本自动生成文件头</h2><p>下面我们会介绍和学习使用这个插件一些显著的功能。看下面的示例文件头，为了要在你所有的新脚本中自动创建该文件头，请按照以下步骤操作。</p>
<p><img src="https://dn-linuxcn.qbox.me/data/attachment/album/201705/02/005111cw2zxty9yd2ww3ow.png" alt="脚本示例文件头选项"></p>
<p>首先设置你的个人信息（作者名称、作者参考、组织、公司等）。在一个 Bash 缓冲区（像下面这样打开一个测试脚本）中使用映射 \ntw 启动模板设置向导。</p>
<p>选中选项 1 设置个性化文件，然后按回车键。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ vi <span class="keyword">test</span>.<span class="keyword">sh</span></div></pre></td></tr></table></figure>
<p><img src="https://dn-linuxcn.qbox.me/data/attachment/album/201705/02/005111c6kdizyg4ie16k70.png" alt="在脚本文件中设置个性化信息"></p>
<p>之后，再次输入回车键。然后再一次选中选项 1 设置个性化文件的路径并输入回车。</p>
<p><img src="https://dn-linuxcn.qbox.me/data/attachment/album/201705/02/005112cpp9l6w922g0nu9j.png" alt="设置个性化文件路径"></p>
<p>设置向导会把目标文件 .vim/bash-support/rc/personal.templates 拷贝到 .vim/templates/personal.templates，打开并编辑它，在这里你可以输入你的信息。</p>
<p>按 i 键像截图那样在单引号中插入合适的值。</p>
<p><img src="https://dn-linuxcn.qbox.me/data/attachment/album/201705/02/005112x12kbb66z6gnxxgg.png" alt="在脚本文件头添加信息"></p>
<p>一旦你设置了正确的值，输入 :wq 保存并退出文件。关闭 Bash 测试脚本，打开另一个脚本来测试新的配置。现在文件头中应该有和下面截图类似的你的个人信息：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="keyword">vi</span> test2.<span class="keyword">sh</span></div></pre></td></tr></table></figure></p>
<p><img src="https://dn-linuxcn.qbox.me/data/attachment/album/201705/02/005113cv0myl26mbn1h370.png" alt="自动添加文件头到脚本"></p>
<h2 id="添加-Bash-support-插件帮助信息"><a href="#添加-Bash-support-插件帮助信息" class="headerlink" title="添加 Bash-support 插件帮助信息"></a>添加 Bash-support 插件帮助信息</h2><p>为此，在 Vim 命令行输入下面的命令并按回车键，它会创建 .vim/doc/tags 文件：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">:helptags <span class="variable">$HOME</span><span class="regexp">/.vim/</span>doc<span class="regexp">/</span></div></pre></td></tr></table></figure>
<p><img src="https://dn-linuxcn.qbox.me/data/attachment/album/201705/02/005113gixlnxzsxe58i8n8.png" alt="在 Vi 编辑器添加插件帮助"></p>
<h2 id="如何在-Shell-脚本中插入注释"><a href="#如何在-Shell-脚本中插入注释" class="headerlink" title="如何在 Shell 脚本中插入注释"></a>如何在 Shell 脚本中插入注释</h2><p>要插入一个块注释，在普通模式下输入 \cfr：</p>
<p><img src="https://dn-linuxcn.qbox.me/data/attachment/album/201705/02/005113hr1vsvdih7iy7d1s.png" alt="添加注释到脚本"></p>
<h2 id="如何在-Shell-脚本中插入语句"><a href="#如何在-Shell-脚本中插入语句" class="headerlink" title="如何在 Shell 脚本中插入语句"></a>如何在 Shell 脚本中插入语句</h2><p>下面是一些用于插入语句的键映射（n – 普通模式, i – 插入模式，v 可视模式）：</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="string">\sc</span> – <span class="keyword">case</span> <span class="keyword">in</span> … esac （n, i）</div><div class="line"><span class="string">\sei</span> – elif <span class="keyword">then</span> （n, i）</div><div class="line"><span class="string">\sf</span> – <span class="keyword">for</span> <span class="keyword">in</span> <span class="keyword">do</span> done （n, i, v）</div><div class="line"><span class="string">\sfo</span> – <span class="keyword">for</span> ((…)) <span class="keyword">do</span> done （n, i, v）</div><div class="line"><span class="string">\si</span> – <span class="keyword">if</span> <span class="keyword">then</span> fi （n, i, v）</div><div class="line"><span class="string">\sie</span> – <span class="keyword">if</span> <span class="keyword">then</span> <span class="keyword">else</span> fi （n, i, v）</div><div class="line"><span class="string">\ss</span> – select <span class="keyword">in</span> <span class="keyword">do</span> done （n, i, v）</div><div class="line"><span class="string">\su</span> – <span class="keyword">until</span> <span class="keyword">do</span> done （n, i, v）</div><div class="line"><span class="string">\sw</span> – <span class="keyword">while</span> <span class="keyword">do</span> done （n, i, v）</div><div class="line"><span class="string">\sfu</span> – <span class="keyword">function</span> （n, i, v）</div><div class="line"><span class="string">\se</span> – echo -e <span class="string">"…"</span> （n, i, v）</div><div class="line"><span class="string">\sp</span> – printf <span class="string">"…"</span> （n, i, v）</div><div class="line"><span class="string">\sa</span> – 数组元素, $&#123;.[.]&#125; （n, i, v） 和其它更多的数组功能。</div></pre></td></tr></table></figure>
<h2 id="插入一个函数和函数头"><a href="#插入一个函数和函数头" class="headerlink" title="插入一个函数和函数头"></a>插入一个函数和函数头</h2><p>输入 \sfu 添加一个新的空函数，然后添加函数名并按回车键创建它。之后，添加你的函数代码。</p>
<p><img src="https://dn-linuxcn.qbox.me/data/attachment/album/201705/02/005114jz0iplcmz10imi7j.png" alt="在脚本中插入新函数"></p>
<p>为了给上面的函数创建函数头，输入 \cfu，输入函数名称，按回车键并填入合适的值（名称、介绍、参数、返回值）：</p>
<p><img src="https://dn-linuxcn.qbox.me/data/attachment/album/201705/02/005114jz0iplcmz10imi7j.png" alt="在脚本中创建函数头"></p>
<h2 id="更多关于添加-Bash-语句的例子"><a href="#更多关于添加-Bash-语句的例子" class="headerlink" title="更多关于添加 Bash 语句的例子"></a>更多关于添加 Bash 语句的例子</h2><p>下面是一个使用 \si 插入一条 if 语句的例子：</p>
<p><img src="https://dn-linuxcn.qbox.me/data/attachment/album/201705/02/005114bd11zhj3b338ej33.png" alt="在脚本中插入语句"></p>
<p>下面的例子显示使用 \se 添加一条 echo 语句：</p>
<p><img src="https://dn-linuxcn.qbox.me/data/attachment/album/201705/02/005115i2rh71k7rz3c88xh.png" alt="在脚本中添加 echo 语句"></p>
<h2 id="如何在-Vi-编辑器中使用运行操作"><a href="#如何在-Vi-编辑器中使用运行操作" class="headerlink" title="如何在 Vi 编辑器中使用运行操作"></a>如何在 Vi 编辑器中使用运行操作</h2><p>下面是一些运行操作键映射的列表：</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">\rr – 更新文件，运行脚本（<span class="built_in">n</span>, i）</div><div class="line">\ra – 设置脚本命令行参数 （<span class="built_in">n</span>, i）</div><div class="line">\rc – 更新文件，检查语法 （<span class="built_in">n</span>, i）</div><div class="line">\rco – 语法检查选项 （<span class="built_in">n</span>, i）</div><div class="line">\rd – 启动调试器（<span class="built_in">n</span>, i）</div><div class="line">\re – 使脚本可/不可执行(*) （<span class="built_in">n</span>, i）</div></pre></td></tr></table></figure>
<h2 id="使脚本可执行"><a href="#使脚本可执行" class="headerlink" title="使脚本可执行"></a>使脚本可执行</h2><p>编写完脚本后，保存它然后输入 \re 和回车键使它可执行。</p>
<p><img src="https://dn-linuxcn.qbox.me/data/attachment/album/201705/02/005115ezuvseyjvkksyosn.png" alt="使脚本可执行"></p>
<h2 id="如何在-Bash-脚本中使用预定义代码片段"><a href="#如何在-Bash-脚本中使用预定义代码片段" class="headerlink" title="如何在 Bash 脚本中使用预定义代码片段"></a>如何在 Bash 脚本中使用预定义代码片段</h2><p>预定义代码片段是为了特定目的包含了已写好代码的文件。为了添加代码段，输入 \nr 和 \nw 读/写预定义代码段。输入下面的命令列出默认的代码段：</p>
<p>$ ls ~/.vim/bash-support/codesnippets/<br><img src="https://dn-linuxcn.qbox.me/data/attachment/album/201705/02/005115vgjeagjassxxkzk6.png" alt="代码段列表"></p>
<p>为了使用代码段，例如 free-software-comment，输入 \nr 并使用自动补全功能选择它的名称，然后输入回车键：</p>
<p><img src="https://dn-linuxcn.qbox.me/data/attachment/album/201705/02/005116e9ouzri0iyaghr5h.png" alt="添加代码段到脚本"></p>
<h2 id="创建自定义预定义代码段"><a href="#创建自定义预定义代码段" class="headerlink" title="创建自定义预定义代码段"></a>创建自定义预定义代码段</h2><p>可以在  ~/.vim/bash-support/codesnippets/目录下编写你自己的代码段。另外，你还可以从你正常的脚本代码中创建你自己的代码段：</p>
<ol>
<li>选择你想作为代码段的部分代码，然后输入  \nw 并给它一个相近的文件名。</li>
<li>要读入它，只需要输入  \nr 然后使用文件名就可以添加你自定义的代码段。</li>
</ol>
<h2 id="在当前光标处查看内建和命令帮助"><a href="#在当前光标处查看内建和命令帮助" class="headerlink" title="在当前光标处查看内建和命令帮助"></a>在当前光标处查看内建和命令帮助</h2><p>要显示帮助，在普通模式下输入：</p>
<ol>
<li>\hh – 内建帮助</li>
<li>\hm – 命令帮助</li>
</ol>
<p><img src="https://dn-linuxcn.qbox.me/data/attachment/album/201705/02/005116v16e1vnarxovx1x9.png" alt="查看内建命令帮助"></p>
<p>更多参考资料，可以查看文件：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~/.vim<span class="meta-keyword">/doc/</span>bashsupport.txt  <span class="meta">#在线文档的副本</span></div><div class="line">~/.vim<span class="meta-keyword">/doc/</span>tags</div></pre></td></tr></table></figure>
<ul>
<li>访问 Bash-support 插件 GitHub 仓库：<a href="https://github.com/WolfgangMehner/bash-support" target="_blank" rel="external">https://github.com/WolfgangMehner/bash-support</a></li>
<li>在 Vim 网站访问 Bash-support 插件：<a href="http://www.vim.org/scripts/script.php?script_id=365" target="_blank" rel="external">http://www.vim.org/scripts/script.php?script_id=365</a></li>
</ul>
<p>就是这些啦，在这篇文章中，我们介绍了在 Linux 中使用 Bash-support 插件安装和配置 Vim 为一个 Bash-IDE 的步骤。快去发现这个插件其它令人兴奋的功能吧，一定要在评论中和我们分享哦。</p>
<p>作者简介：</p>
<p>Aaron Kili 是一个 Linux 和 F.O.S.S 爱好者、Linux 系统管理员、网络开发人员，现在也是 TecMint 的内容创作者，她喜欢和电脑一起工作，坚信共享知识。</p>
<p>via: <a href="http://www.tecmint.com/use-vim-as-bash-ide-using-bash-support-in-linux/" target="_blank" rel="external">http://www.tecmint.com/use-vim-as-bash-ide-using-bash-support-in-linux/</a></p>
<p>作者：Aaron Kili 译者：ictlyh 校对：wxy</p>
<p>本文由 LCTT 原创编译，Linux中国 荣誉推出</p>
]]></content>
    
    <summary type="html">
    
      bash-support是一个高度定制化的 vim 插件，它允许你插入：文件头、补全语句、注释、函数、以及代码块。它也使你可以进行语法检查、使脚本可执行、一键启动调试器；而完成所有的这些而不需要关闭编辑器。
    
    </summary>
    
      <category term="Linux" scheme="https://roc-wong.github.io/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://roc-wong.github.io/tags/Linux/"/>
    
      <category term="Shell" scheme="https://roc-wong.github.io/tags/Shell/"/>
    
  </entry>
  
  <entry>
    <title>极光推送服务限流方案</title>
    <link href="https://roc-wong.github.io/blog/2018/01/%E6%9C%8D%E5%8A%A1%E9%99%90%E6%B5%81%E6%96%B9%E6%A1%88.html"/>
    <id>https://roc-wong.github.io/blog/2018/01/服务限流方案.html</id>
    <published>2018-01-31T13:41:04.000Z</published>
    <updated>2018-09-12T15:18:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>如何让系统在汹涌澎湃的流量面前谈笑风生？我们的策略是不要让系统超负荷工作。如果现有的系统扛不住业务目标怎么办？加机器！机器不够怎么办？业务降级，服务限流！</p>
<p>正所谓「他强任他强，清风拂山岗；他横任他横，明月照大江」，降级和限流是系统可用性保障中必不可少的神兵利器，丢卒保车，以暂停边缘业务为代价保障核心业务的资源，以系统不被突发流量压挂为第一要务。</p>
<a id="more"></a>
<h2 id="现状"><a href="#现状" class="headerlink" title="现状"></a>现状</h2><h3 id="JPush-API-频率控制"><a href="#JPush-API-频率控制" class="headerlink" title="JPush API 频率控制"></a>JPush API 频率控制</h3><p>JPush API对访问次数，具有频率控制。即一定的时间窗口内，API允许调用的次数是有限制的。免费版：1分钟600次。</p>
<p>超出后：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"error"</span>:&#123;<span class="attr">"code"</span>:<span class="number">2002</span>,<span class="attr">"message"</span>:<span class="string">"Request times of the app_key exceed the limit of current time window"</span>&#125;&#125;</div></pre></td></tr></table></figure></p>
<h3 id="各业务组直接对接极光API"><a href="#各业务组直接对接极光API" class="headerlink" title="各业务组直接对接极光API"></a>各业务组直接对接极光API</h3><p>目前各业务线都在使用极光推送服务，并且是直接调用极光API。水归一源，终汇聚一处。想实现流量管控，只有将调用出口整合到一处，方可达到限流管控的目的。</p>
<p><img src="https://raw.githubusercontent.com/roc-wong/images/master/%E6%9E%81%E5%85%89%E6%8E%A8%E9%80%81%E8%B0%83%E7%94%A8%E7%8E%B0%E7%8A%B6.png" alt="现状"></p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="令牌桶算法"><a href="#令牌桶算法" class="headerlink" title="令牌桶算法"></a>令牌桶算法</h3><p>令牌桶算法是网络流量整形（Traffic Shaping）和速率限制（Rate Limiting）中最常使用的一种算法。典型情况下，令牌桶算法用来控制发送到网络上的数据的数目，并允许突发数据的发送。令牌桶属于控制速率类型的。令牌桶算法最初来源于计算机网络。在网络传输数据时，为了防止网络拥塞，需限制流出网络的流量，使流量以比较均匀的速度向外发送。令牌桶算法就实现了这个功能，可控制发送到网络上数据的数目，并允许突发数据的发送。</p>
<p>在 Wikipedia 上，令牌桶算法是这么描述的：</p>
<ol>
<li>每秒会有 r 个令牌放入桶中，或者说，每过 1/r 秒桶中增加一个令牌。</li>
<li>桶中最多存放 b 个令牌，如果桶满了，新放入的令牌会被丢弃。</li>
<li>当一个 n 字节的数据包到达时，消耗 n 个令牌，然后发送该数据包。</li>
<li>如果桶中可用令牌小于 n，则该数据包将被缓存或丢弃。</li>
</ol>
<p><img src="http://xiaobaoqiu.github.io/images/guava/token_bucket.JPG" alt="令牌桶"></p>
<p>大小固定的令牌桶可自行以恒定的速率源源不断地产生令牌。如果令牌不被消耗，或者被消耗的速度小于产生的速度，令牌就会不断地增多，直到把桶填满。后面再产生的令牌就会从桶中溢出。最后桶中可以保存的最大令牌数永远不会超过桶的大小。传送到令牌桶的数据包需要消耗令牌。不同大小的数据包，消耗的令牌数量不一样。</p>
<p>令牌桶这种控制机制基于令牌桶中是否存在令牌来指示什么时候可以发送流量。令牌桶中的每一个令牌都代表一个字节。如果令牌桶中存在令牌，则允许发送流量；而如果令牌桶中不存在令牌，则不允许发送流量。因此，如果突发门限被合理地配置并且令牌桶中有足够的令牌，那么流量就可以以峰值速率发送。</p>
<p>基于令牌桶算法改造消息中心，流程图如下：</p>
<p><img src="https://raw.githubusercontent.com/roc-wong/images/master/%E9%99%90%E6%B5%81%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="限流方案"></p>
<h3 id="单机限流"><a href="#单机限流" class="headerlink" title="单机限流"></a>单机限流</h3><p>Google Guava RateLimiter就是令牌桶算法的实现，速率限制器会在可配置的速率下分配许可证。如果必要的话，每个acquire() 会阻塞当前线程直到许可证可用后获取该许可证。一旦获取到许可证，不需要再释放许可证。RateLimiter经常用于限制对一些物理资源或者逻辑资源的访问速率。与Semaphore 相比，Semaphore 限制了并发访问的数量而不是使用速率。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//每秒两个许可</span></div><div class="line"><span class="keyword">final</span> RateLimiter rateLimiter = RateLimiter.create(<span class="number">2.0</span>);</div><div class="line"></div><div class="line"><span class="keyword">void</span> submitTasks(List tasks, Executor executor) &#123;</div><div class="line">    <span class="keyword">for</span> (Runnable <span class="keyword">task</span> : tasks) &#123;</div><div class="line">        rateLimiter.acquire(); <span class="comment">// 拿不到许可就等待</span></div><div class="line">        executor.execute(<span class="keyword">task</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过设置许可证的速率来定义RateLimiter。在默认配置下，许可证会在固定的速率下被分配，速率单位是每秒多少个许可证。为了确保维护配置的速率，许可会被平稳地分配，许可之间的延迟会做调整。可能存在配置一个拥有预热期的RateLimiter的情况，在这段时间内，每秒分配的许可数会稳定地增长直到达到稳定的速率。</p>
<h3 id="分布式限流"><a href="#分布式限流" class="headerlink" title="分布式限流"></a>分布式限流</h3><p>Remote Dictionary Server（Redis）是一个基于 key-value 键值对的持久化数据库存储系统。支持多种数据结构，包括 string (字符串)、list (链表)、set (集合)、zset (sorted set –有序集合)和 hash（哈希类型）。这些数据类型都支持 push/pop、add/remove 及取交集并集和差集及更丰富的操作，而且这些操作都是原子性的。</p>
<p>想实现分布式限流，非Redis莫属。Redis限流的大体思路是设置一个带有过期时间的key，每次申请令牌时，将 key 所储存的值加上增量 increment， 判断key 所存储的值是否达到上限，未达到上限，则获得许可。如有需要，亦可阻塞当前线程直到获得许可。</p>
<p>限流相关的命令：</p>
<p><strong>事务</strong></p>
<p>MULTI、EXEC、DISCARD和WATCH命令是Redis事务功能的基础，Redis事务允许在一次单独的步骤中执行一组命令，并且可以保证如下两个重要事项：</p>
<ul>
<li><p>Redis会将一个事务中的所有命令序列化，然后按顺序执行。</p>
<p>  Redis不可能在一个Redis事务的执行过程中插入执行另一个客户端发出的请求。这样便能保证Redis将这些命令作为一个单独的隔离操作执行。 </p>
</li>
<li><p>在一个Redis事务中，Redis要么执行其中的所有命令，要么什么都不执行。</p>
<p>  因此，Redis事务能够保证原子性。EXEC命令会触发执行事务中的所有命令。因此，当某个客户端正在执行一次事务时，如果它在调用MULTI命令之前就从Redis服务端断开连接，那么就不会执行事务中的任何操作；相反，如果它在调用EXEC命令之后才从Redis服务端断开连接，那么就会执行事务中的所有操作。当Redis使用只增文件（AOF：Append-only File）时，Redis能够确保使用一个单独的write(2)系统调用，这样便能将事务写入磁盘。然而，如果Redis服务器宕机，或者系统管理员以某种方式停止Redis服务进程的运行，那么Redis很有可能只执行了事务中的一部分操作。Redis将会在重新启动时检查上述状态，然后退出运行，并且输出报错信息。使用redis-check-aof工具可以修复上述的只增文件，这个工具将会从上述文件中删除执行不完全的事务，这样Redis服务器才能再次启动。</p>
</li>
</ul>
<p>从2.2版本开始，除了上述两项保证之外，Redis还能够以乐观锁(Watch)的形式提供更多的保证，这种形式非常类似于”检查再设置”（CAS：Check And Set）操作。</p>
<p>从2.6版本开始提供脚本（Lua scripting）能力，一种更灵活的批量命令组织方式用于取代目前的事务机制。脚本提供了更强大和灵活的编程能力，但也是一把双刃剑，由于 Redis 需要保证脚本执行的原子性和隔离性，脚本执行期间会阻塞其他命令的执行，因此建议使用高效的脚本完成业务。</p>
<p><strong>SET</strong></p>
<p>SET key value [EX seconds] [PX milliseconds] [NX|XX]</p>
<p>将字符串值 value 关联到 key 。如果 key 已经持有其他值， SET 就覆写旧值，无视类型。对于某个原本带有生存时间（TTL）的键来说， 当 SET 命令成功在这个键上执行时， 这个键原有的 TTL 将被清除。</p>
<p>从 Redis 2.6.12 版本开始， SET 命令的行为可以通过一系列参数来修改：</p>
<p>EX second ：设置键的过期时间为 second 秒。 SET key value EX second 效果等同于 SETEX key second value 。<br>PX millisecond ：设置键的过期时间为 millisecond 毫秒。 SET key value PX millisecond 效果等同于 PSETEX key millisecond value 。<br>NX ：只在键不存在时，才对键进行设置操作。 SET key value NX 效果等同于 SETNX key value 。<br>XX ：只在键已经存在时，才对键进行设置操作。</p>
<p><strong>INCRBY</strong></p>
<p>将 key 所储存的值加上增量 increment 。如果 key 不存在，那么 key 的值会先被初始化为 0 ，然后再执行 INCRBY 命令。如果值包含错误的类型，或字符串类型的值不能表示为数字，那么返回一个错误。</p>
<p>Redis官方基于上述命令提供的限流代码：<a href="https://redis.io/commands/incr#pattern-rate-limiter-1" target="_blank" rel="external">https://redis.io/commands/incr#pattern-rate-limiter-1</a></p>
<h2 id="代码验证"><a href="#代码验证" class="headerlink" title="代码验证"></a>代码验证</h2><p>使用Jedis client进行限流方案验证：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">package hbec.app.stock.ratelimiter;</div><div class="line"></div><div class="line">/**</div><div class="line"> * @author roc</div><div class="line"> * @<span class="built_in">date</span> <span class="number">2018</span>/<span class="number">01</span>/<span class="number">24</span></div><div class="line"> */</div><div class="line">public interface RateLimiter &#123;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Acquires a permit only <span class="keyword">if</span> one <span class="keyword">is</span> available <span class="keyword">at</span> <span class="keyword">the</span></div><div class="line">     * <span class="built_in">time</span> <span class="keyword">of</span> invocation.</div><div class="line">     *</div><div class="line">     * &lt;p&gt;Acquires a permit, <span class="keyword">if</span> one <span class="keyword">is</span> available <span class="keyword">and</span> returns immediately,</div><div class="line">     * <span class="keyword">with</span> <span class="keyword">the</span> <span class="literal">result</span> &#123;@code LimiterResult<span class="comment">#acquired is true&#125;,</span></div><div class="line">     * reducing <span class="keyword">the</span> <span class="built_in">number</span> <span class="keyword">of</span> available permits <span class="keyword">by</span> one.</div><div class="line">     *</div><div class="line">     * &lt;p&gt;If no permit <span class="keyword">is</span> available <span class="keyword">then</span> this method will <span class="literal">return</span></div><div class="line">     * immediately <span class="keyword">with</span> <span class="keyword">the</span> value &#123;@code <span class="literal">false</span>&#125;.</div><div class="line">     *</div><div class="line">     * @param permits <span class="keyword">the</span> <span class="built_in">number</span> <span class="keyword">of</span> permits <span class="keyword">to</span> acquire</div><div class="line">     * @<span class="literal">return</span> acquire <span class="literal">result</span> &#123;@code <span class="literal">true</span>&#125; <span class="keyword">if</span> a permit was acquired,</div><div class="line">     * <span class="keyword">and</span> &#123;@code <span class="literal">false</span> <span class="keyword">is</span> <span class="literal">false</span>&#125; otherwise</div><div class="line">     */</div><div class="line">    <span class="built_in">boolean</span> tryAcquire(int permits);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Acquires a permit <span class="keyword">from</span> this method, blocking <span class="keyword">until</span> one <span class="keyword">is</span></div><div class="line">     * available, <span class="keyword">or</span> <span class="keyword">the</span> thread <span class="keyword">is</span> &#123;@linkplain Thread<span class="comment">#interrupt interrupted&#125;.</span></div><div class="line">     *</div><div class="line">     * &lt;p&gt;Acquires a permit, <span class="keyword">if</span> one <span class="keyword">is</span> available <span class="keyword">and</span> returns immediately,</div><div class="line">     * reducing <span class="keyword">the</span> <span class="built_in">number</span> <span class="keyword">of</span> available permits <span class="keyword">by</span> one.</div><div class="line">     *</div><div class="line">     * @param permits <span class="keyword">the</span> <span class="built_in">number</span> <span class="keyword">of</span> permits <span class="keyword">to</span> acquire</div><div class="line">     */</div><div class="line">    void acquire(int permits) throws InterruptedException;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> hbec.app.stock.ratelimiter;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.google.common.base.Preconditions;</div><div class="line"><span class="keyword">import</span> hbec.app.stock.commons.redis.JedisTemplate;</div><div class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</div><div class="line"><span class="keyword">import</span> org.slf4j.Logger;</div><div class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</div><div class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</div><div class="line"><span class="keyword">import</span> redis.clients.jedis.Response;</div><div class="line"><span class="keyword">import</span> redis.clients.jedis.Transaction;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Random;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> roc</div><div class="line"> * <span class="doctag">@date</span> 2018/01/23</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisRateLimiter</span> <span class="keyword">implements</span> <span class="title">RateLimiter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(RedisRateLimiter.class);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ZERO = <span class="string">"0"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String NOT_EXISTS = <span class="string">"NX"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String P_EXPIRE = <span class="string">"PX"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NOT_SET = <span class="number">-1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Random TIME_RANDOM = <span class="keyword">new</span> Random();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 限流标识，redis key</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> String rateLimiterName;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 存活时间</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> timeToLive;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 许可上限</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> upperLimitPermits;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> JedisTemplate jedisTemplate;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> permits)</span> </span>&#123;</div><div class="line">        Preconditions.checkArgument(permits &gt; <span class="number">0</span>, <span class="string">"The number of permits must be greater than 0."</span>);</div><div class="line">        <span class="keyword">return</span> acquireSync(permits).isAcquired();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> permits)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        Preconditions.checkArgument(permits &gt; <span class="number">0</span>, <span class="string">"The number of permits must be greater than 0."</span>);</div><div class="line">        LimiterResult limiterResult;</div><div class="line">        do &#123;</div><div class="line">            limiterResult = acquireSync(permits);</div><div class="line">            <span class="keyword">if</span> (!limiterResult.isAcquired()) &#123;</div><div class="line">                <span class="keyword">long</span> sleepTime = limiterResult.getRemainderTTL() + TIME_RANDOM.nextInt(<span class="number">5</span>);</div><div class="line">                Thread.sleep(sleepTime);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">while</span> (!limiterResult.isAcquired());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function">LimiterResult <span class="title">acquireSync</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> permits)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">return</span> jedisTemplate.<span class="title">execute</span><span class="params">(<span class="keyword">new</span> JedisTemplate.JedisAction&lt;LimiterResult&gt;()</span> </span>&#123;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="keyword">public</span> <span class="function">LimiterResult <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line"></div><div class="line">                Transaction transaction = jedis.multi();</div><div class="line">                transaction.set(rateLimiterName, ZERO, NOT_EXISTS, P_EXPIRE, timeToLive);</div><div class="line">                Response&lt;Long&gt; currentQPS = transaction.incrBy(rateLimiterName, permits);</div><div class="line">                Response&lt;Long&gt; keyTTL = transaction.pttl(rateLimiterName);</div><div class="line">                transaction.exec();</div><div class="line"></div><div class="line">                Long currentPermit = currentQPS.get();</div><div class="line">                Long remainderTTL = keyTTL.get();</div><div class="line"></div><div class="line">                <span class="keyword">boolean</span> acquired = currentPermit &lt;= upperLimitPermits;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (!acquired &amp;&amp; remainderTTL == NOT_SET) &#123;</div><div class="line">                    LOGGER.<span class="keyword">error</span>(<span class="string">"Warning! Set ttl false, key=&#123;&#125;, current ttl=&#123;&#125;"</span>, rateLimiterName, remainderTTL);</div><div class="line">                    jedis.expire(rateLimiterName, timeToLive);</div><div class="line">                    remainderTTL = (<span class="keyword">long</span>) timeToLive;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                LOGGER.debug(<span class="string">"rateLimiterName=&#123;&#125;, passed=&#123;&#125;, remainderTTL=&#123;&#125;, time=&#123;&#125;"</span>,</div><div class="line">                        rateLimiterName, acquired ? <span class="string">"true"</span> : <span class="string">"false"</span>,</div><div class="line">                        remainderTTL, currentPermit);</div><div class="line">                <span class="function"><span class="keyword">return</span> LimiterResult.<span class="title">newInstance</span><span class="params">(acquired, remainderTTL)</span></span>;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function">Builder <span class="title">newBuilder</span><span class="params">(JedisTemplate jedisTemplate)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Builder(jedisTemplate);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> JedisTemplate jedisTemplate;</div><div class="line">        <span class="keyword">private</span> String rateLimiterName;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> timeToLive;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> upperLimitPermits;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="title">Builder</span><span class="params">(JedisTemplate jedisTemplate)</span> </span>&#123;</div><div class="line">            Preconditions.checkNotNull(jedisTemplate, <span class="string">"JedisTemplate can't be null."</span>);</div><div class="line">            <span class="keyword">this</span>.jedisTemplate = jedisTemplate;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="function">Builder <span class="title">setRateLimiterName</span><span class="params">(String rateLimiterName)</span> </span>&#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.rateLimiterName = rateLimiterName;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="function">Builder <span class="title">setTimeToLive</span><span class="params">(<span class="keyword">int</span> timeToLive, TimeUnit timeUnit)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.timeToLive = (<span class="keyword">int</span>) timeUnit.toMillis(timeToLive);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="function">Builder <span class="title">setUpperLimitPermits</span><span class="params">(<span class="keyword">int</span> upperLimitPermits)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.upperLimitPermits = upperLimitPermits;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="function">RedisRateLimiter <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">            Preconditions.checkArgument(StringUtils.isNotBlank(rateLimiterName), <span class="string">"RateLimiterName can't be blank."</span>);</div><div class="line">            Preconditions.checkArgument(upperLimitPermits &gt; <span class="number">0</span>, <span class="string">"UpperLimitPermits must be an integer greater than 0."</span>);</div><div class="line">            Preconditions.checkArgument(timeToLive &gt; <span class="number">0</span>, <span class="string">"TimeToLive must be an integer greater than 0."</span>);</div><div class="line"></div><div class="line">            RedisRateLimiter redisRateLimiter = <span class="keyword">new</span> RedisRateLimiter();</div><div class="line">            redisRateLimiter.jedisTemplate = <span class="keyword">this</span>.jedisTemplate;</div><div class="line">            redisRateLimiter.upperLimitPermits = <span class="keyword">this</span>.upperLimitPermits;</div><div class="line">            redisRateLimiter.rateLimiterName = <span class="keyword">this</span>.rateLimiterName;</div><div class="line">            redisRateLimiter.timeToLive = <span class="keyword">this</span>.timeToLive;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> redisRateLimiter;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> hbec.app.stock.ratelimiter;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> roc</div><div class="line"> * <span class="doctag">@date</span> 2018/01/24</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LimiterResult</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> acquired;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Long remainderTTL;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function">LimiterResult <span class="title">newInstance</span><span class="params">(<span class="keyword">boolean</span> acquired, Long remainderTTL)</span> </span>&#123;</div><div class="line">        LimiterResult limiterResult = <span class="keyword">new</span> LimiterResult();</div><div class="line">        limiterResult.setAcquired(acquired);</div><div class="line">        limiterResult.setRemainderTTL(remainderTTL);</div><div class="line">        <span class="keyword">return</span> limiterResult;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">isAcquired</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> acquired;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function">Long <span class="title">getRemainderTTL</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> remainderTTL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">setAcquired</span><span class="params">(<span class="keyword">boolean</span> acquired)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.acquired = acquired;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">setRemainderTTL</span><span class="params">(Long remainderTTL)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.remainderTTL = remainderTTL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function">String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="string">"LimiterResult&#123;"</span>);</div><div class="line">        sb.append(<span class="string">"acquired="</span>).append(acquired);</div><div class="line">        sb.append(<span class="string">", remainderTTL="</span>).append(remainderTTL);</div><div class="line">        sb.append(<span class="string">'&#125;'</span>);</div><div class="line">        <span class="function"><span class="keyword">return</span> sb.<span class="title">toString</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>JedisTemplate.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div><div class="line">562</div><div class="line">563</div><div class="line">564</div><div class="line">565</div><div class="line">566</div><div class="line">567</div><div class="line">568</div><div class="line">569</div><div class="line">570</div><div class="line">571</div><div class="line">572</div><div class="line">573</div><div class="line">574</div><div class="line">575</div><div class="line">576</div><div class="line">577</div><div class="line">578</div><div class="line">579</div><div class="line">580</div><div class="line">581</div><div class="line">582</div><div class="line">583</div><div class="line">584</div><div class="line">585</div><div class="line">586</div><div class="line">587</div><div class="line">588</div><div class="line">589</div><div class="line">590</div><div class="line">591</div><div class="line">592</div><div class="line">593</div><div class="line">594</div><div class="line">595</div><div class="line">596</div><div class="line">597</div><div class="line">598</div><div class="line">599</div><div class="line">600</div><div class="line">601</div><div class="line">602</div><div class="line">603</div><div class="line">604</div><div class="line">605</div><div class="line">606</div><div class="line">607</div><div class="line">608</div><div class="line">609</div><div class="line">610</div><div class="line">611</div><div class="line">612</div><div class="line">613</div><div class="line">614</div><div class="line">615</div><div class="line">616</div><div class="line">617</div><div class="line">618</div><div class="line">619</div><div class="line">620</div><div class="line">621</div><div class="line">622</div><div class="line">623</div><div class="line">624</div><div class="line">625</div><div class="line">626</div><div class="line">627</div><div class="line">628</div><div class="line">629</div><div class="line">630</div><div class="line">631</div><div class="line">632</div><div class="line">633</div><div class="line">634</div><div class="line">635</div><div class="line">636</div><div class="line">637</div><div class="line">638</div><div class="line">639</div><div class="line">640</div><div class="line">641</div><div class="line">642</div><div class="line">643</div><div class="line">644</div><div class="line">645</div><div class="line">646</div><div class="line">647</div><div class="line">648</div><div class="line">649</div><div class="line">650</div><div class="line">651</div><div class="line">652</div><div class="line">653</div><div class="line">654</div><div class="line">655</div><div class="line">656</div><div class="line">657</div><div class="line">658</div><div class="line">659</div><div class="line">660</div><div class="line">661</div><div class="line">662</div><div class="line">663</div><div class="line">664</div><div class="line">665</div><div class="line">666</div><div class="line">667</div><div class="line">668</div><div class="line">669</div><div class="line">670</div><div class="line">671</div><div class="line">672</div><div class="line">673</div><div class="line">674</div><div class="line">675</div><div class="line">676</div><div class="line">677</div><div class="line">678</div><div class="line">679</div><div class="line">680</div><div class="line">681</div><div class="line">682</div><div class="line">683</div><div class="line">684</div><div class="line">685</div><div class="line">686</div><div class="line">687</div><div class="line">688</div><div class="line">689</div><div class="line">690</div><div class="line">691</div><div class="line">692</div><div class="line">693</div><div class="line">694</div><div class="line">695</div><div class="line">696</div><div class="line">697</div><div class="line">698</div><div class="line">699</div><div class="line">700</div><div class="line">701</div><div class="line">702</div><div class="line">703</div><div class="line">704</div><div class="line">705</div><div class="line">706</div><div class="line">707</div><div class="line">708</div><div class="line">709</div><div class="line">710</div><div class="line">711</div><div class="line">712</div><div class="line">713</div><div class="line">714</div><div class="line">715</div><div class="line">716</div><div class="line">717</div><div class="line">718</div><div class="line">719</div><div class="line">720</div><div class="line">721</div><div class="line">722</div><div class="line">723</div><div class="line">724</div><div class="line">725</div><div class="line">726</div><div class="line">727</div><div class="line">728</div><div class="line">729</div><div class="line">730</div><div class="line">731</div><div class="line">732</div><div class="line">733</div><div class="line">734</div><div class="line">735</div><div class="line">736</div><div class="line">737</div><div class="line">738</div><div class="line">739</div><div class="line">740</div><div class="line">741</div><div class="line">742</div><div class="line">743</div><div class="line">744</div><div class="line">745</div><div class="line">746</div><div class="line">747</div><div class="line">748</div><div class="line">749</div><div class="line">750</div><div class="line">751</div><div class="line">752</div><div class="line">753</div><div class="line">754</div><div class="line">755</div><div class="line">756</div><div class="line">757</div><div class="line">758</div><div class="line">759</div><div class="line">760</div><div class="line">761</div><div class="line">762</div><div class="line">763</div><div class="line">764</div><div class="line">765</div><div class="line">766</div><div class="line">767</div><div class="line">768</div><div class="line">769</div><div class="line">770</div><div class="line">771</div><div class="line">772</div><div class="line">773</div><div class="line">774</div><div class="line">775</div><div class="line">776</div><div class="line">777</div><div class="line">778</div><div class="line">779</div><div class="line">780</div><div class="line">781</div><div class="line">782</div><div class="line">783</div><div class="line">784</div><div class="line">785</div><div class="line">786</div><div class="line">787</div><div class="line">788</div><div class="line">789</div><div class="line">790</div><div class="line">791</div><div class="line">792</div><div class="line">793</div><div class="line">794</div><div class="line">795</div><div class="line">796</div><div class="line">797</div><div class="line">798</div><div class="line">799</div><div class="line">800</div><div class="line">801</div><div class="line">802</div><div class="line">803</div><div class="line">804</div><div class="line">805</div><div class="line">806</div><div class="line">807</div><div class="line">808</div><div class="line">809</div><div class="line">810</div><div class="line">811</div><div class="line">812</div><div class="line">813</div><div class="line">814</div><div class="line">815</div><div class="line">816</div><div class="line">817</div><div class="line">818</div><div class="line">819</div><div class="line">820</div><div class="line">821</div><div class="line">822</div><div class="line">823</div><div class="line">824</div><div class="line">825</div><div class="line">826</div><div class="line">827</div><div class="line">828</div><div class="line">829</div><div class="line">830</div><div class="line">831</div><div class="line">832</div><div class="line">833</div><div class="line">834</div><div class="line">835</div><div class="line">836</div><div class="line">837</div><div class="line">838</div><div class="line">839</div><div class="line">840</div><div class="line">841</div><div class="line">842</div><div class="line">843</div><div class="line">844</div><div class="line">845</div><div class="line">846</div><div class="line">847</div><div class="line">848</div><div class="line">849</div><div class="line">850</div><div class="line">851</div><div class="line">852</div><div class="line">853</div><div class="line">854</div><div class="line">855</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> hbec.app.stock.commons.redis;</div><div class="line"></div><div class="line"><span class="keyword">import</span> hbec.app.stock.redis.JedisUtils;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"><span class="keyword">import</span> java.util.Set;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.slf4j.Logger;</div><div class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</div><div class="line"></div><div class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</div><div class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</div><div class="line"><span class="keyword">import</span> redis.clients.jedis.Pipeline;</div><div class="line"><span class="keyword">import</span> redis.clients.jedis.ScanParams;</div><div class="line"><span class="keyword">import</span> redis.clients.jedis.ScanResult;</div><div class="line"><span class="keyword">import</span> redis.clients.jedis.Tuple;</div><div class="line"><span class="keyword">import</span> redis.clients.jedis.exceptions.JedisConnectionException;</div><div class="line"><span class="keyword">import</span> redis.clients.jedis.exceptions.JedisDataException;</div><div class="line"><span class="keyword">import</span> redis.clients.jedis.exceptions.JedisException;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * JedisTemplate 提供了一个template方法，负责对Jedis连接的获取与归还。</div><div class="line"> * JedisAction&lt;T&gt; 和 JedisActionNoResult两种回调接口，适用于有无返回值两种情况。</div><div class="line"> * PipelineAction 与 PipelineActionResult两种接口，适合于pipeline中批量传输命令的情况。</div><div class="line"> * </div><div class="line"> * 同时提供一些JedisOperation中定义的 最常用函数的封装, 如get/set/zadd等。</div><div class="line"> * </div><div class="line"> * <span class="doctag">@author</span> roc</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JedisTemplate</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(JedisTemplate.class);</div><div class="line"></div><div class="line">	<span class="keyword">private</span> JedisPool jedisPool;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">JedisTemplate</span><span class="params">(JedisPool jedisPool)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.jedisPool = jedisPool;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Callback interface for template.</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JedisAction</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">		<span class="function">T <span class="title">action</span><span class="params">(Jedis jedis)</span></span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Callback interface for template without result.</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JedisActionNoResult</span> </span>&#123;</div><div class="line">		<span class="function"><span class="keyword">void</span> <span class="title">action</span><span class="params">(Jedis jedis)</span></span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Callback interface for template.</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PipelineAction</span> </span>&#123;</div><div class="line">		<span class="function">List&lt;Object&gt; <span class="title">action</span><span class="params">(Pipeline Pipeline)</span></span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Callback interface for template without result.</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PipelineActionNoResult</span> </span>&#123;</div><div class="line">		<span class="function"><span class="keyword">void</span> <span class="title">action</span><span class="params">(Pipeline Pipeline)</span></span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Execute with a call back action with result.</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(JedisAction&lt;T&gt; jedisAction)</span> <span class="keyword">throws</span> JedisException </span>&#123;</div><div class="line">		Jedis jedis = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">boolean</span> broken = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			jedis = jedisPool.getResource();</div><div class="line">			<span class="keyword">return</span> jedisAction.action(jedis);</div><div class="line">		&#125; <span class="keyword">catch</span> (JedisException e) &#123;</div><div class="line">			broken = handleJedisException(e);</div><div class="line">			<span class="keyword">throw</span> e;</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			closeResource(jedis, broken);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Execute with a call back action without result.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(JedisActionNoResult jedisAction)</span> <span class="keyword">throws</span> JedisException </span>&#123;</div><div class="line">		Jedis jedis = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">boolean</span> broken = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			jedis = jedisPool.getResource();</div><div class="line">			jedisAction.action(jedis);</div><div class="line">		&#125; <span class="keyword">catch</span> (JedisException e) &#123;</div><div class="line">			broken = handleJedisException(e);</div><div class="line">			<span class="keyword">throw</span> e;</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			closeResource(jedis, broken);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Execute with a call back action with result in pipeline.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">execute</span><span class="params">(PipelineAction pipelineAction)</span> <span class="keyword">throws</span> JedisException </span>&#123;</div><div class="line">		Jedis jedis = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">boolean</span> broken = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			jedis = jedisPool.getResource();</div><div class="line">			Pipeline pipeline = jedis.pipelined();</div><div class="line">			pipelineAction.action(pipeline);</div><div class="line">			<span class="keyword">return</span> pipeline.syncAndReturnAll();</div><div class="line">		&#125; <span class="keyword">catch</span> (JedisException e) &#123;</div><div class="line">			broken = handleJedisException(e);</div><div class="line">			<span class="keyword">throw</span> e;</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			closeResource(jedis, broken);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Execute with a call back action without result in pipeline.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(PipelineActionNoResult pipelineAction)</span> <span class="keyword">throws</span> JedisException </span>&#123;</div><div class="line">		Jedis jedis = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">boolean</span> broken = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			jedis = jedisPool.getResource();</div><div class="line">			Pipeline pipeline = jedis.pipelined();</div><div class="line">			pipelineAction.action(pipeline);</div><div class="line">			pipeline.sync();</div><div class="line">		&#125; <span class="keyword">catch</span> (JedisException e) &#123;</div><div class="line">			broken = handleJedisException(e);</div><div class="line">			<span class="keyword">throw</span> e;</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			closeResource(jedis, broken);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Handle jedisException, write log and return whether the connection is</div><div class="line">	 * broken.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">handleJedisException</span><span class="params">(JedisException jedisException)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (jedisException <span class="keyword">instanceof</span> JedisConnectionException) &#123;</div><div class="line">			logger.error(<span class="string">"Redis connection lost."</span>, jedisException);</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (jedisException <span class="keyword">instanceof</span> JedisDataException) &#123;</div><div class="line">			<span class="keyword">if</span> ((jedisException.getMessage() != <span class="keyword">null</span>) &amp;&amp; (jedisException.getMessage().indexOf(<span class="string">"READONLY"</span>) != -<span class="number">1</span>)) &#123;</div><div class="line">				logger.error(<span class="string">"Redis connection are read-only slave."</span>, jedisException);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// dataException, isBroken=false</span></div><div class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			logger.error(<span class="string">"Jedis exception happen."</span>, jedisException);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Return jedis connection to the pool, call different return methods</div><div class="line">	 * depends on the conectionBroken status.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">closeResource</span><span class="params">(Jedis jedis, <span class="keyword">boolean</span> conectionBroken)</span> </span>&#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="keyword">if</span> (conectionBroken) &#123;</div><div class="line">				jedisPool.returnBrokenResource(jedis);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				jedisPool.returnResource(jedis);</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			logger.error(<span class="string">"return back jedis failed, will fore close the jedis."</span>, e);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// / Common Actions ///</span></div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Remove the specified keys. If a given key does not exist no operation is</div><div class="line">	 * performed for this key.</div><div class="line">	 * </div><div class="line">	 * return false if one of the key is not exist.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> Boolean <span class="title">del</span><span class="params">(<span class="keyword">final</span> String... keys)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Boolean&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Boolean <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.del(keys) == keys.length ? <span class="keyword">true</span> : <span class="keyword">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// / String Actions ///</span></div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Get the value of the specified key. If the key does not exist null is</div><div class="line">	 * returned. If the value stored at key is not a string an error is returned</div><div class="line">	 * because GET can only handle string values.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;String&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> String <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.get(key);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Get the value of the specified key as Long.If the key does not exist null</div><div class="line">	 * is returned.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> Long <span class="title">getAsLong</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">		String result = get(key);</div><div class="line">		<span class="keyword">return</span> result != <span class="keyword">null</span> ? Long.valueOf(result) : <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Get the value of the specified key as Integer.If the key does not exist</div><div class="line">	 * null is returned.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> Integer <span class="title">getAsInt</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">		String result = get(key);</div><div class="line">		<span class="keyword">return</span> result != <span class="keyword">null</span> ? Integer.valueOf(result) : <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Get the value of the specified key as Boolean.If the key does not exist</div><div class="line">	 * null is returned.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> Boolean <span class="title">getAsBoolean</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">		String result = get(key);</div><div class="line">		<span class="keyword">return</span> result != <span class="keyword">null</span> ? Boolean.valueOf(result) : <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Get the values of all the specified keys. If one or more keys dont exist</div><div class="line">	 * or is not of type String, a 'nil' value is returned instead of the value</div><div class="line">	 * of the specified key, but the operation never fails.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">mget</span><span class="params">(<span class="keyword">final</span> String... keys)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;List&lt;String&gt;&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.mget(keys);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Set the string value as value of the key. The string can't be longer than</div><div class="line">	 * 1073741824 bytes (1 GB).</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String value)</span> </span>&#123;</div><div class="line">		execute(<span class="keyword">new</span> JedisActionNoResult() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				jedis.set(key, value);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * The command is exactly equivalent to the following group of commands:</div><div class="line">	 * &#123;<span class="doctag">@link</span> #set(String, String) SET&#125; + &#123;<span class="doctag">@link</span> #expire(String, int) EXPIRE&#125;.</div><div class="line">	 * The operation is atomic.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setex</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String value, <span class="keyword">final</span> <span class="keyword">int</span> seconds)</span> </span>&#123;</div><div class="line">		execute(<span class="keyword">new</span> JedisActionNoResult() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				jedis.setex(key, seconds, value);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * SETNX works exactly like &#123;<span class="doctag">@link</span> #setNX(String, String) SET&#125; with the only</div><div class="line">	 * difference that if the key already exists no operation is performed.</div><div class="line">	 * SETNX actually means "SET if Not eXists".</div><div class="line">	 * </div><div class="line">	 * return true if the key was set.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> Boolean <span class="title">setnx</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String value)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Boolean&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Boolean <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.setnx(key, value) == <span class="number">1</span> ? <span class="keyword">true</span> : <span class="keyword">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * The command is exactly equivalent to the following group of commands:</div><div class="line">	 * &#123;<span class="doctag">@link</span> #setex(String, String, int) SETEX&#125; +</div><div class="line">	 * &#123;<span class="doctag">@link</span> #sexnx(String, String) SETNX&#125;. The operation is atomic.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> Boolean <span class="title">setnxex</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String value, <span class="keyword">final</span> <span class="keyword">int</span> seconds)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Boolean&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Boolean <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				String result = jedis.set(key, value, <span class="string">"NX"</span>, <span class="string">"EX"</span>, seconds);</div><div class="line">				<span class="keyword">return</span> JedisUtils.isStatusOk(result);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * GETSET is an atomic set this value and return the old value command. Set</div><div class="line">	 * key to the string value and return the old value stored at key. The</div><div class="line">	 * string can't be longer than 1073741824 bytes (1 GB).</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getSet</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String value)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;String&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> String <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.getSet(key, value);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Increment the number stored at key by one. If the key does not exist or</div><div class="line">	 * contains a value of a wrong type, set the key to the value of "0" before</div><div class="line">	 * to perform the increment operation.</div><div class="line">	 * &lt;p&gt;</div><div class="line">	 * INCR commands are limited to 64 bit signed integers.</div><div class="line">	 * &lt;p&gt;</div><div class="line">	 * Note: this is actually a string operation, that is, in Redis there are</div><div class="line">	 * not "integer" types. Simply the string stored at the key is parsed as a</div><div class="line">	 * base 10 64 bit signed integer, incremented, and then converted back as a</div><div class="line">	 * string.</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@return</span> Integer reply, this commands will reply with the new value of key</div><div class="line">	 *         after the increment.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> Long <span class="title">incr</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Long&gt;() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Long <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.incr(key);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Long <span class="title">incrBy</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">long</span> increment)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Long&gt;() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Long <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.incrBy(key, increment);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Double <span class="title">incrByFloat</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">double</span> increment)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Double&gt;() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Double <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.incrByFloat(key, increment);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Decrement the number stored at key by one. If the key does not exist or</div><div class="line">	 * contains a value of a wrong type, set the key to the value of "0" before</div><div class="line">	 * to perform the decrement operation.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> Long <span class="title">decr</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Long&gt;() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Long <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.decr(key);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Long <span class="title">decrBy</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">long</span> decrement)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Long&gt;() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Long <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.decrBy(key, decrement);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// / Hash Actions ///</span></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * If key holds a hash, retrieve the value associated to the specified</div><div class="line">	 * field.</div><div class="line">	 * &lt;p&gt;</div><div class="line">	 * If the field is not found or the key does not exist, a special 'nil'</div><div class="line">	 * value is returned.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">hget</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String fieldName)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;String&gt;() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> String <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.hget(key, fieldName);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">hmget</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String... fieldsNames)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;List&lt;String&gt;&gt;() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.hmget(key, fieldsNames);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">hgetAll</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Map&lt;String, String&gt;&gt;() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.hgetAll(key);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hset</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> String value)</span> </span>&#123;</div><div class="line">		execute(<span class="keyword">new</span> JedisActionNoResult() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				jedis.hset(key, fieldName, value);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hmset</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> Map&lt;String, String&gt; map)</span> </span>&#123;</div><div class="line">		execute(<span class="keyword">new</span> JedisActionNoResult() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				jedis.hmset(key, map);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Boolean <span class="title">hsetnx</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> String value)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Boolean&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Boolean <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.hsetnx(key, fieldName, value) == <span class="number">1</span> ? <span class="keyword">true</span> : <span class="keyword">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Long <span class="title">hincrBy</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> <span class="keyword">long</span> increment)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Long&gt;() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Long <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.hincrBy(key, fieldName, increment);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Double <span class="title">hincrByFloat</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> <span class="keyword">double</span> increment)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Double&gt;() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Double <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.hincrByFloat(key, fieldName, increment);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Long <span class="title">hdel</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String... fieldsNames)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Long&gt;() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Long <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.hdel(key, fieldsNames);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Boolean <span class="title">hexists</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String fieldName)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Boolean&gt;() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Boolean <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.hexists(key, fieldName);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">hkeys</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Set&lt;String&gt;&gt;() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.hkeys(key);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Long <span class="title">hlen</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Long&gt;() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Long <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.hlen(key);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// / List Actions ///</span></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Long <span class="title">lpush</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String... values)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Long&gt;() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Long <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.lpush(key, values);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">rpop</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;String&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> String <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.rpop(key);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">brpop</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;String&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> String <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				List&lt;String&gt; nameValuePair = jedis.brpop(key);</div><div class="line">				<span class="keyword">if</span> (nameValuePair != <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="keyword">return</span> nameValuePair.get(<span class="number">1</span>);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">brpop</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> timeout, <span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;String&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> String <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				List&lt;String&gt; nameValuePair = jedis.brpop(timeout, key);</div><div class="line">				<span class="keyword">if</span> (nameValuePair != <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="keyword">return</span> nameValuePair.get(<span class="number">1</span>);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Not support for sharding.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">rpoplpush</span><span class="params">(<span class="keyword">final</span> String sourceKey, <span class="keyword">final</span> String destinationKey)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;String&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> String <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.rpoplpush(sourceKey, destinationKey);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Not support for sharding.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">brpoplpush</span><span class="params">(<span class="keyword">final</span> String source, <span class="keyword">final</span> String destination, <span class="keyword">final</span> <span class="keyword">int</span> timeout)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;String&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> String <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.brpoplpush(source, destination, timeout);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Long <span class="title">llen</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Long&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Long <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.llen(key);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">lindex</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">long</span> index)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;String&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> String <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.lindex(key, index);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">lrange</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">int</span> start, <span class="keyword">final</span> <span class="keyword">int</span> end)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;List&lt;String&gt;&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.lrange(key, start, end);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ltrim</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">int</span> start, <span class="keyword">final</span> <span class="keyword">int</span> end)</span> </span>&#123;</div><div class="line">		execute(<span class="keyword">new</span> JedisActionNoResult() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				jedis.ltrim(key, start, end);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ltrimFromLeft</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">int</span> size)</span> </span>&#123;</div><div class="line">		execute(<span class="keyword">new</span> JedisActionNoResult() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				jedis.ltrim(key, <span class="number">0</span>, size - <span class="number">1</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Boolean <span class="title">lremFirst</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String value)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Boolean&gt;() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Boolean <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				Long count = jedis.lrem(key, <span class="number">1</span>, value);</div><div class="line">				<span class="keyword">return</span> (count == <span class="number">1</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Boolean <span class="title">lremAll</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String value)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Boolean&gt;() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Boolean <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				Long count = jedis.lrem(key, <span class="number">0</span>, value);</div><div class="line">				<span class="keyword">return</span> (count &gt; <span class="number">0</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// / Set Actions ///</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Boolean <span class="title">sadd</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String member)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Boolean&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Boolean <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.sadd(key, member) == <span class="number">1</span> ? <span class="keyword">true</span> : <span class="keyword">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">smembers</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Set&lt;String&gt;&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.smembers(key);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// / Ordered Set Actions ///</span></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * return true for add new element, false for only update the score.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> Boolean <span class="title">zadd</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">double</span> score, <span class="keyword">final</span> String member)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Boolean&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Boolean <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.zadd(key, score, member) == <span class="number">1</span> ? <span class="keyword">true</span> : <span class="keyword">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Double <span class="title">zscore</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String member)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Double&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Double <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.zscore(key, member);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Long <span class="title">zrank</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String member)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Long&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Long <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.zrank(key, member);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Long <span class="title">zrevrank</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String member)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Long&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Long <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.zrevrank(key, member);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Long <span class="title">zcount</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">double</span> min, <span class="keyword">final</span> <span class="keyword">double</span> max)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Long&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Long <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.zcount(key, min, max);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">zrange</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">int</span> start, <span class="keyword">final</span> <span class="keyword">int</span> end)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Set&lt;String&gt;&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.zrange(key, start, end);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Set&lt;Tuple&gt; <span class="title">zrangeWithScores</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">int</span> start, <span class="keyword">final</span> <span class="keyword">int</span> end)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Set&lt;Tuple&gt;&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Set&lt;Tuple&gt; <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.zrangeWithScores(key, start, end);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">zrevrange</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">int</span> start, <span class="keyword">final</span> <span class="keyword">int</span> end)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Set&lt;String&gt;&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.zrevrange(key, start, end);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Set&lt;Tuple&gt; <span class="title">zrevrangeWithScores</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">int</span> start, <span class="keyword">final</span> <span class="keyword">int</span> end)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Set&lt;Tuple&gt;&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Set&lt;Tuple&gt; <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.zrevrangeWithScores(key, start, end);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">zrangeByScore</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">double</span> min, <span class="keyword">final</span> <span class="keyword">double</span> max)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Set&lt;String&gt;&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.zrangeByScore(key, min, max);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Set&lt;Tuple&gt; <span class="title">zrangeByScoreWithScores</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">double</span> min, <span class="keyword">final</span> <span class="keyword">double</span> max)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Set&lt;Tuple&gt;&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Set&lt;Tuple&gt; <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.zrangeByScoreWithScores(key, min, max);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">zrevrangeByScore</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">double</span> max, <span class="keyword">final</span> <span class="keyword">double</span> min)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Set&lt;String&gt;&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.zrevrangeByScore(key, max, min);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Set&lt;Tuple&gt; <span class="title">zrevrangeByScoreWithScores</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">double</span> max, <span class="keyword">final</span> <span class="keyword">double</span> min)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Set&lt;Tuple&gt;&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Set&lt;Tuple&gt; <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.zrevrangeByScoreWithScores(key, max, min);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Boolean <span class="title">zrem</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String member)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Boolean&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Boolean <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.zrem(key, member) == <span class="number">1</span> ? <span class="keyword">true</span> : <span class="keyword">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Long <span class="title">zremByScore</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">double</span> start, <span class="keyword">final</span> <span class="keyword">double</span> end)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Long&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Long <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.zremrangeByScore(key, start, end);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Long <span class="title">zremByRank</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">long</span> start, <span class="keyword">final</span> <span class="keyword">long</span> end)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Long&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Long <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.zremrangeByRank(key, start, end);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Long <span class="title">zcard</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> execute(<span class="keyword">new</span> JedisAction&lt;Long&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Long <span class="title">action</span><span class="params">(Jedis jedis)</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> jedis.zcard(key);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>验证代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> hbec.app.stock.ratelimiter;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">import</span> hbec.app.stock.commons.redis.JedisTemplate;</div><div class="line"><span class="keyword">import</span> org.slf4j.Logger;</div><div class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</div><div class="line"><span class="keyword">import</span> org.testng.annotations.BeforeTest;</div><div class="line"><span class="keyword">import</span> org.testng.annotations.Test;</div><div class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> roc</div><div class="line"> * <span class="doctag">@date</span> 2018/01/26</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisRateLimiterTest</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(RedisRateLimiterTest.class);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> RateLimiter rateLimiter;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> AtomicInteger atomicInteger = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="meta">@BeforeTest</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        JedisPool jedisPool = <span class="keyword">new</span> JedisPool(<span class="string">"10.0.30.66"</span>, <span class="number">6379</span>);</div><div class="line">        JedisTemplate jedisTemplate = <span class="keyword">new</span> JedisTemplate(jedisPool);</div><div class="line">        String rateLimiterName = <span class="string">"rateLimiterROC"</span>;</div><div class="line"></div><div class="line">        rateLimiter = RedisRateLimiter.newBuilder(jedisTemplate).setRateLimiterName(rateLimiterName)</div><div class="line">                .setUpperLimitPermits(<span class="number">10</span>).setTimeToLive(<span class="number">5</span>, TimeUnit.SECONDS).build();</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Test</span>(threadPoolSize = <span class="number">10</span>, invocationCount = <span class="number">20</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTryAcquire</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> acquired = rateLimiter.tryAcquire(<span class="number">1</span>);</div><div class="line">        <span class="keyword">if</span> (acquired) &#123;</div><div class="line">            LOGGER.info(<span class="string">"thread &#123;&#125; acquire the permit &#123;&#125; times."</span>, Thread.currentThread().getId(), atomicInteger.getAndIncrement());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Test</span>(threadPoolSize = <span class="number">10</span>, invocationCount = <span class="number">20</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAcquire</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        rateLimiter.acquire(<span class="number">1</span>);</div><div class="line">        LOGGER.info(<span class="string">"thread &#123;&#125; acquire the permit &#123;&#125; times."</span>, Thread.currentThread().getId(), atomicInteger.getAndIncrement());</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p><strong>测试用例</strong></p>
<p>10个线程20次请求，限制5s内10次请求。</p>
<p><strong>测试结果</strong></p>
<p>10次请求在5s内正常通过，剩下10次请求等待下个时间窗口轮询。</p>
<p><img src="https://raw.githubusercontent.com/roc-wong/images/master/%E9%99%90%E6%B5%81%E6%B5%8B%E8%AF%95.png" alt="测试结果"></p>
]]></content>
    
    <summary type="html">
    
      微服务限流方案，基于edis实现流速控制
    
    </summary>
    
      <category term="架构设计" scheme="https://roc-wong.github.io/categories/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/"/>
    
    
      <category term="java后端" scheme="https://roc-wong.github.io/tags/java%E5%90%8E%E7%AB%AF/"/>
    
  </entry>
  
  <entry>
    <title>极光推送java-sdk-V3.2.15堵塞BUG</title>
    <link href="https://roc-wong.github.io/blog/2018/01/%E6%9E%81%E5%85%89%E6%8E%A8%E9%80%81java-sdk-V3-2-15%E5%A0%B5%E5%A1%9EBUG.html"/>
    <id>https://roc-wong.github.io/blog/2018/01/极光推送java-sdk-V3-2-15堵塞BUG.html</id>
    <published>2018-01-11T01:36:56.000Z</published>
    <updated>2018-11-21T02:18:25.535Z</updated>
    
    <content type="html"><![CDATA[<h2 id="案发现场"><a href="#案发现场" class="headerlink" title="案发现场"></a>案发现场</h2><ul>
<li>从RabbitMQ Server端获取消息的线程运行正常，读到数据后放到本地的BlockQueue中，等待消费者线程消费。</li>
<li>消费者线程堵塞，不再消费本地BlockQueue中的消息。</li>
<li>使用jstack进行Thread Dump分析。由于自定义消费者线程名称，所以直接筛选前缀为MessageConsumer线程，结果如下：</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="string">"MessageConsumer-1"</span> prio=<span class="number">10</span> tid=<span class="number">0</span>x00007f39309f6000 nid=<span class="number">0</span>x1047 waiting on condition [<span class="number">0</span>x00007f39052d3000]</div><div class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: WAITING (parking)</div><div class="line">	at sun<span class="selector-class">.misc</span><span class="selector-class">.Unsafe</span><span class="selector-class">.park</span>(Native Method)</div><div class="line">	- parking to wait <span class="keyword">for</span>  &lt;<span class="number">0</span>x00000000a4b994d0&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.CountDownLatch</span><span class="variable">$Sync</span>)</div><div class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span><span class="selector-class">.LockSupport</span><span class="selector-class">.park</span>(LockSupport<span class="selector-class">.java</span>:<span class="number">186</span>)</div><div class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span><span class="selector-class">.AbstractQueuedSynchronizer</span><span class="selector-class">.parkAndCheckInterrupt</span>(AbstractQueuedSynchronizer<span class="selector-class">.java</span>:<span class="number">834</span>)</div><div class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span><span class="selector-class">.AbstractQueuedSynchronizer</span><span class="selector-class">.doAcquireSharedInterruptibly</span>(AbstractQueuedSynchronizer<span class="selector-class">.java</span>:<span class="number">994</span>)</div><div class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span><span class="selector-class">.AbstractQueuedSynchronizer</span><span class="selector-class">.acquireSharedInterruptibly</span>(AbstractQueuedSynchronizer<span class="selector-class">.java</span>:<span class="number">1303</span>)</div><div class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.CountDownLatch</span><span class="selector-class">.await</span>(CountDownLatch<span class="selector-class">.java</span>:<span class="number">236</span>)</div><div class="line">	at cn<span class="selector-class">.jiguang</span><span class="selector-class">.common</span><span class="selector-class">.connection</span><span class="selector-class">.NettyHttpClient</span><span class="selector-class">.sendHttpRequest</span>(NettyHttpClient<span class="selector-class">.java</span>:<span class="number">193</span>)</div><div class="line">	at cn<span class="selector-class">.jiguang</span><span class="selector-class">.common</span><span class="selector-class">.connection</span><span class="selector-class">.NettyHttpClient</span><span class="selector-class">.sendPost</span>(NettyHttpClient<span class="selector-class">.java</span>:<span class="number">134</span>)</div><div class="line">	at cn<span class="selector-class">.jpush</span><span class="selector-class">.api</span><span class="selector-class">.push</span><span class="selector-class">.PushClient</span><span class="selector-class">.sendPush</span>(PushClient<span class="selector-class">.java</span>:<span class="number">194</span>)</div><div class="line">	at cn<span class="selector-class">.jpush</span><span class="selector-class">.api</span><span class="selector-class">.JPushClient</span><span class="selector-class">.sendPush</span>(JPushClient<span class="selector-class">.java</span>:<span class="number">205</span>)</div><div class="line">	at hbec<span class="selector-class">.app</span><span class="selector-class">.platform</span><span class="selector-class">.push</span><span class="selector-class">.service</span><span class="selector-class">.impl</span><span class="selector-class">.JPushService</span><span class="selector-class">.push</span>(JPushService<span class="selector-class">.java</span>:<span class="number">66</span>)</div><div class="line">	at hbec<span class="selector-class">.app</span><span class="selector-class">.platform</span><span class="selector-class">.push</span><span class="selector-class">.service</span><span class="selector-class">.impl</span><span class="selector-class">.PushFacadeService</span><span class="selector-class">.jpush</span>(PushFacadeService<span class="selector-class">.java</span>:<span class="number">113</span>)</div><div class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.NativeMethodAccessorImpl</span><span class="selector-class">.invoke0</span>(Native Method)</div><div class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.NativeMethodAccessorImpl</span><span class="selector-class">.invoke</span>(NativeMethodAccessorImpl<span class="selector-class">.java</span>:<span class="number">57</span>)</div><div class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.DelegatingMethodAccessorImpl</span><span class="selector-class">.invoke</span>(DelegatingMethodAccessorImpl<span class="selector-class">.java</span>:<span class="number">43</span>)</div><div class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.reflect</span><span class="selector-class">.Method</span><span class="selector-class">.invoke</span>(Method<span class="selector-class">.java</span>:<span class="number">606</span>)</div><div class="line">	at hbec<span class="selector-class">.app</span><span class="selector-class">.mc</span><span class="selector-class">.RpcService</span><span class="selector-class">.send</span>(RpcService<span class="selector-class">.java</span>:<span class="number">38</span>)</div><div class="line">	at hbec<span class="selector-class">.app</span><span class="selector-class">.mc</span><span class="selector-class">.NotifySendService</span><span class="selector-class">.send</span>(NotifySendService<span class="selector-class">.java</span>:<span class="number">40</span>)</div><div class="line">	at hbec<span class="selector-class">.app</span><span class="selector-class">.mc</span><span class="selector-class">.NotifyService</span><span class="selector-class">.notifyPerson</span>(NotifyService<span class="selector-class">.java</span>:<span class="number">151</span>)</div><div class="line">	at hbec<span class="selector-class">.app</span><span class="selector-class">.mc</span><span class="selector-class">.NotifyService</span><span class="selector-class">.notify</span>(NotifyService<span class="selector-class">.java</span>:<span class="number">83</span>)</div><div class="line">	at hbec<span class="selector-class">.app</span><span class="selector-class">.mc</span><span class="selector-class">.rabbitmq</span><span class="selector-class">.RealTimeConsumer</span><span class="selector-class">.onMessage</span>(RealTimeConsumer<span class="selector-class">.java</span>:<span class="number">29</span>)</div><div class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.amqp</span><span class="selector-class">.rabbit</span><span class="selector-class">.listener</span><span class="selector-class">.adapter</span><span class="selector-class">.MessageListenerAdapter</span><span class="selector-class">.onMessage</span>(MessageListenerAdapter<span class="selector-class">.java</span>:<span class="number">273</span>)</div><div class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.amqp</span><span class="selector-class">.rabbit</span><span class="selector-class">.listener</span><span class="selector-class">.AbstractMessageListenerContainer</span><span class="selector-class">.doInvokeListener</span>(AbstractMessageListenerContainer<span class="selector-class">.java</span>:<span class="number">848</span>)</div><div class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.amqp</span><span class="selector-class">.rabbit</span><span class="selector-class">.listener</span><span class="selector-class">.AbstractMessageListenerContainer</span><span class="selector-class">.invokeListener</span>(AbstractMessageListenerContainer<span class="selector-class">.java</span>:<span class="number">771</span>)</div><div class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.amqp</span><span class="selector-class">.rabbit</span><span class="selector-class">.listener</span><span class="selector-class">.SimpleMessageListenerContainer</span><span class="selector-class">.access</span>$<span class="number">001</span>(SimpleMessageListenerContainer<span class="selector-class">.java</span>:<span class="number">102</span>)</div><div class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.amqp</span><span class="selector-class">.rabbit</span><span class="selector-class">.listener</span><span class="selector-class">.SimpleMessageListenerContainer</span>$<span class="number">1</span>.invokeListener(SimpleMessageListenerContainer<span class="selector-class">.java</span>:<span class="number">198</span>)</div><div class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.amqp</span><span class="selector-class">.rabbit</span><span class="selector-class">.listener</span><span class="selector-class">.SimpleMessageListenerContainer</span><span class="selector-class">.invokeListener</span>(SimpleMessageListenerContainer<span class="selector-class">.java</span>:<span class="number">1311</span>)</div><div class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.amqp</span><span class="selector-class">.rabbit</span><span class="selector-class">.listener</span><span class="selector-class">.AbstractMessageListenerContainer</span><span class="selector-class">.executeListener</span>(AbstractMessageListenerContainer<span class="selector-class">.java</span>:<span class="number">752</span>)</div><div class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.amqp</span><span class="selector-class">.rabbit</span><span class="selector-class">.listener</span><span class="selector-class">.SimpleMessageListenerContainer</span><span class="selector-class">.doReceiveAndExecute</span>(SimpleMessageListenerContainer<span class="selector-class">.java</span>:<span class="number">1254</span>)</div><div class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.amqp</span><span class="selector-class">.rabbit</span><span class="selector-class">.listener</span><span class="selector-class">.SimpleMessageListenerContainer</span><span class="selector-class">.receiveAndExecute</span>(SimpleMessageListenerContainer<span class="selector-class">.java</span>:<span class="number">1224</span>)</div><div class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.amqp</span><span class="selector-class">.rabbit</span><span class="selector-class">.listener</span><span class="selector-class">.SimpleMessageListenerContainer</span><span class="selector-class">.access</span>$<span class="number">1600</span>(SimpleMessageListenerContainer<span class="selector-class">.java</span>:<span class="number">102</span>)</div><div class="line">	at org<span class="selector-class">.springframework</span><span class="selector-class">.amqp</span><span class="selector-class">.rabbit</span><span class="selector-class">.listener</span><span class="selector-class">.SimpleMessageListenerContainer</span><span class="variable">$AsyncMessageProcessingConsumer</span>.run(SimpleMessageListenerContainer<span class="selector-class">.java</span>:<span class="number">1470</span>)</div><div class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">745</span>)</div><div class="line"></div><div class="line">   Locked ownable synchronizers:</div><div class="line">	- None</div><div class="line">……</div></pre></td></tr></table></figure>
<p>从上可以发现，消费者线程大都处于WAITING状态，线程阻塞在NettyHttpClient.sendHttpRequest的CountDownLatch.await()方法。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.CountDownLatch</span><span class="selector-class">.await</span>(CountDownLatch<span class="selector-class">.java</span>:<span class="number">236</span>)</div><div class="line">at cn<span class="selector-class">.jiguang</span><span class="selector-class">.common</span><span class="selector-class">.connection</span><span class="selector-class">.NettyHttpClient</span><span class="selector-class">.sendHttpRequest</span>(NettyHttpClient<span class="selector-class">.java</span>:<span class="number">193</span>)</div></pre></td></tr></table></figure></p>
<h2 id="分析推理"><a href="#分析推理" class="headerlink" title="分析推理"></a>分析推理</h2><p>通过对应用中各线程运行的状态情况，推测是极光推送SDK代码BUG导致。深入源码进行问题排查：</p>
<ul>
<li><p>1&gt; cn.jpush.api.JPushClient.java</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function">PushResult <span class="title">sendPush</span><span class="params">(PushPayload pushPayload)</span> <span class="keyword">throws</span> APIConnectionException, APIRequestException </span>&#123;</div><div class="line">	    <span class="function"><span class="keyword">return</span> _pushClient.<span class="title">sendPush</span><span class="params">(pushPayload)</span></span>;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>2&gt; cn.jpush.api.push.PushClient.java</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public PushResult sendPush(PushPayload pushPayload) throws APIConnectionException, APIRequestException &#123;</div><div class="line">        Preconditions.checkArgument(! (null == pushPayload), <span class="string">"pushPayload should not be null"</span>);</div><div class="line">        <span class="keyword">if</span> (<span class="variable">_apnsProduction</span> &gt; <span class="number">0</span>) &#123;</div><div class="line">            pushPayload.resetOptionsApnsProduction(<span class="literal">true</span>);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">_apnsProduction</span> == <span class="number">0</span>) &#123;</div><div class="line">            pushPayload.resetOptionsApnsProduction(<span class="literal">false</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (<span class="variable">_timeToLive</span> &gt;= <span class="number">0</span>) &#123;</div><div class="line">            pushPayload.resetOptionsTimeToLive(<span class="variable">_timeToLive</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//该版本默认使用NettyHttpClient，进入源码</span></div><div class="line">        ResponseWrapper response = <span class="variable">_httpClient</span>.sendPost(<span class="variable">_baseUrl</span> + <span class="variable">_pushPath</span>, pushPayload.<span class="built_in">toString</span>());</div><div class="line">        return BaseResult.fromResponse(response, PushResult.class);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>3&gt; cn.jiguang.common.connection.NettyHttpClient.java</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">    <span class="keyword">public</span> ResponseWrapper sendPost(<span class="keyword">String</span> url, <span class="keyword">String</span> content) throws APIConnectionException, APIRequestException &#123;</div><div class="line">        ResponseWrapper wrapper = <span class="keyword">new</span> <span class="type">ResponseWrapper</span>();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> sendHttpRequest(HttpMethod.POST, url, content);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> wrapper;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> ResponseWrapper sendHttpRequest(HttpMethod method, <span class="keyword">String</span> url, <span class="keyword">String</span> body) throws Exception &#123;</div><div class="line">        <span class="comment">// 此处实例化CountDownLatch并传递给NettyClientInitializer, 继续跟踪  </span></div><div class="line">        CountDownLatch latch = <span class="keyword">new</span> <span class="type">CountDownLatch</span>(<span class="number">1</span>);</div><div class="line">        NettyClientInitializer initializer = <span class="keyword">new</span> <span class="type">NettyClientInitializer</span>(_sslCtx, <span class="literal">null</span>, latch);</div><div class="line">        b.handler(initializer);</div><div class="line">        ResponseWrapper wrapper = <span class="keyword">new</span> <span class="type">ResponseWrapper</span>();</div><div class="line">        URI uri = <span class="keyword">new</span> <span class="type">URI</span>(url);</div><div class="line">        <span class="keyword">String</span> scheme = uri.getScheme() == <span class="literal">null</span> ? <span class="string">"http"</span> : <span class="type">uri</span>.getScheme();</div><div class="line">        <span class="keyword">String</span> host = uri.getHost() == <span class="literal">null</span> ? <span class="string">"127.0.0.1"</span> : <span class="type">uri</span>.getHost();</div><div class="line">        int port = uri.getPort();</div><div class="line">        <span class="keyword">if</span> (port == <span class="number">-1</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="string">"http"</span>.equalsIgnoreCase(scheme)) &#123;</div><div class="line">                port = <span class="number">80</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"https"</span>.equalsIgnoreCase(scheme)) &#123;</div><div class="line">                port = <span class="number">443</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ChannelFuture connect = b.connect(host, port);</div><div class="line">            _channel = connect.sync().channel();</div><div class="line">            FullHttpRequest request;</div><div class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != body) &#123;</div><div class="line">                ByteBuf byteBuf = Unpooled.copiedBuffer(body.getBytes(CharsetUtil.UTF_8));</div><div class="line">                request = <span class="keyword">new</span> <span class="type">DefaultFullHttpRequest</span>(HttpVersion.HTTP_1_1, method, uri.getRawPath(), byteBuf);</div><div class="line">                request.headers().<span class="keyword">set</span>(HttpHeaderNames.CONTENT_LENGTH, (long) byteBuf.readableBytes());</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                request = <span class="keyword">new</span> <span class="type">DefaultFullHttpRequest</span>(HTTP_1_1, method, uri.getRawPath());</div><div class="line">            &#125;</div><div class="line">            request.headers().<span class="keyword">set</span>(HttpHeaderNames.HOST, uri.getHost());</div><div class="line">            request.headers().<span class="keyword">set</span>(HttpHeaderNames.AUTHORIZATION, _authCode);</div><div class="line">            request.headers().<span class="keyword">set</span>(<span class="string">"Content-Type"</span>,<span class="string">"application/json;charset=utf-8"</span>);</div><div class="line">            connect.awaitUninterruptibly();</div><div class="line">            LOG.info(<span class="string">"Sending request. "</span> + request);</div><div class="line">            LOG.info(<span class="string">"Send body: "</span> + body);</div><div class="line">            _channel.writeAndFlush(request);</div><div class="line">            <span class="comment">//调用latch.await()后主线程阻塞，等待netty异步网络调用。如果异步线程执行后不调用countDown()，主线程将永远阻塞，此为问题主要原因。  </span></div><div class="line">            latch.await();</div><div class="line">            wrapper = initializer.getResponse();</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> wrapper;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>4&gt; cn.jiguang.common.connection.NettyClientInitializer.java</p>
</li>
</ul>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       <span class="comment">//使用_latch创建HttpResponseHandler</span></div><div class="line">       <span class="keyword">this</span>._handler = <span class="keyword">new</span> HttpResponseHandler(_callback, _latch);</div><div class="line">       socketChannel.pipeline().addLast(_sslCtx.newHandler(socketChannel.alloc()), <span class="keyword">new</span> HttpClientCodec(), _handler);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ul>
<li>5&gt; cn.jiguang.common.connection.HttpResponseHandler.java<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, HttpObject msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> HttpResponse) &#123;</div><div class="line">           HttpResponse response = (HttpResponse) msg;</div><div class="line">           status = response.status().code();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> HttpContent) &#123;</div><div class="line">           HttpContent content = (HttpContent) msg;</div><div class="line">           LOG.info(content.content().toString());</div><div class="line">           <span class="keyword">if</span> (content <span class="keyword">instanceof</span> LastHttpContent) &#123;</div><div class="line">               <span class="comment">//断点跟踪发现，程序运行到该分支后，直接close，并未调用_latch.countDown(); 此为问题的主要爆发点</span></div><div class="line">               LOG.info(<span class="string">"closing connection"</span>);</div><div class="line">               ctx.close();</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               String responseContent = content.content().toString(CharsetUtil.UTF_8);</div><div class="line">               _wrapper.responseCode = status;</div><div class="line">               _wrapper.responseContent = responseContent;</div><div class="line">               LOG.info(<span class="string">"Got Response code: "</span> + status + <span class="string">" content: "</span> + responseContent);</div><div class="line">               System.err.println(<span class="string">"Got Response code: "</span> + status + <span class="string">" content: "</span> + responseContent);</div><div class="line">               System.err.flush();</div><div class="line">               <span class="keyword">if</span> (<span class="keyword">null</span> != _callback) &#123;</div><div class="line">                   _callback.onSucceed(_wrapper);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">if</span> (<span class="keyword">null</span> != _latch) &#123;</div><div class="line">                   <span class="comment">//正常情况下</span></div><div class="line">                   _latch.countDown();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> </span>&#123;</div><div class="line">       LOG.<span class="keyword">error</span>(<span class="string">"error:"</span>, cause);</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">//模拟网络异常，发现此处也存在bug，未调用_latch.countDown(); 隐藏爆发点</span></div><div class="line">           ctx.close();</div><div class="line">       &#125;<span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line">           LOG.<span class="keyword">error</span>(<span class="string">"close error:"</span>, ex);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>翻阅源码发现HttpResponseHandler.java类内部存在两个隐患：</p>
<ul>
<li>程序运行到if (content instanceof LastHttpContent) {……}分支后，未调用_latch.countDown();</li>
<li>当出现网络异常时，exceptionCaught方法内部也未调用_latch.countDown();</li>
</ul>
<p>只要其中任意一个隐患爆发，主线程就会阻塞，进入WAITING状态。消费者线程就此堵塞，不再消费BlockQueue中的消息。</p>
<h2 id="恢复现场"><a href="#恢复现场" class="headerlink" title="恢复现场"></a>恢复现场</h2><ul>
<li>Maven pom.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></div><div class="line">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sky-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.sky<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jpush-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="comment">&lt;!-- jpush --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.jpush.api<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jpush-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.15<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- utils begin --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.jpush.api<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jiguang-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.6.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.code.gson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="comment">&lt;!-- LOGGING begin --&gt;</span></div><div class="line">        <span class="comment">&lt;!-- slf4j --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="comment">&lt;!-- logback --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="comment">&lt;!-- 代码直接调用log4j会被桥接到slf4j --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-over-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="comment">&lt;!-- 代码直接调用commons-logging会被桥接到slf4j --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jcl-over-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="comment">&lt;!-- 代码直接调用java.util.logging会被桥接到slf4j --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jul-to-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="comment">&lt;!-- log4jdbc --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.googlecode.log4jdbc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- LOGGING end --&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.testng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>testng<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<ul>
<li>测试代码</li>
</ul>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.sky.jpush;</div><div class="line"></div><div class="line"><span class="keyword">import</span> cn.jiguang.common.ClientConfig;</div><div class="line"><span class="keyword">import</span> cn.jiguang.common.resp.APIConnectionException;</div><div class="line"><span class="keyword">import</span> cn.jiguang.common.resp.APIRequestException;</div><div class="line"><span class="keyword">import</span> cn.jpush.api.JPushClient;</div><div class="line"><span class="keyword">import</span> cn.jpush.api.<span class="keyword">push</span>.PushResult;</div><div class="line"><span class="keyword">import</span> cn.jpush.api.<span class="keyword">push</span>.model.<span class="keyword">Options</span>;</div><div class="line"><span class="keyword">import</span> cn.jpush.api.<span class="keyword">push</span>.model.Platform;</div><div class="line"><span class="keyword">import</span> cn.jpush.api.<span class="keyword">push</span>.model.PushPayload;</div><div class="line"><span class="keyword">import</span> cn.jpush.api.<span class="keyword">push</span>.model.audience.Audience;</div><div class="line"><span class="keyword">import</span> cn.jpush.api.<span class="keyword">push</span>.model.audience.AudienceTarget;</div><div class="line"><span class="keyword">import</span> cn.jpush.api.<span class="keyword">push</span>.model.notification.IosAlert;</div><div class="line"><span class="keyword">import</span> cn.jpush.api.<span class="keyword">push</span>.model.notification.IosNotification;</div><div class="line"><span class="keyword">import</span> cn.jpush.api.<span class="keyword">push</span>.model.notification.Notification;</div><div class="line"><span class="keyword">import</span> org.slf4j.Logger;</div><div class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</div><div class="line"><span class="keyword">import</span> org.testng.annotations.Test;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * @author roc</div><div class="line"> * @date 2018/01/09</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> JPushServiceTest &#123;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(JPushServiceTest.<span class="keyword">class</span>);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String APP_KEY = <span class="string">"b11314807507e2bcfdeebe2e"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MASTER_SECRET = <span class="string">"2c88a01e073a0fe4fc7b167c"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String GROUP_MASTER_SECRET = <span class="string">"b11314807507e2bcfdeebe2e"</span>;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String GROUP_PUSH_KEY = <span class="string">"2c88a01e073a0fe4fc7b167c"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ALERT = <span class="string">"JPush Test - alert"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String MSG_CONTENT = <span class="string">"JPush Test - msgContent"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGISTRATION_ID1 = <span class="string">"0900e8d85ef"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGISTRATION_ID2 = <span class="string">"0a04ad7d8b4"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGISTRATION_ID3 = <span class="string">"18071adc030dcba91c0"</span>;</div><div class="line"></div><div class="line">    @Test</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> testNettyClient() &#123;</div><div class="line"></div><div class="line">        ClientConfig clientConfig = ClientConfig.getInstance();</div><div class="line"></div><div class="line">        JPushClient jpushClient = <span class="keyword">new</span> JPushClient(MASTER_SECRET, APP_KEY, <span class="keyword">null</span>, clientConfig);</div><div class="line">        <span class="comment">/*String authCode = ServiceHelper.getBasicAuthorization(APP_KEY, MASTER_SECRET);</span></div><div class="line">        ApacheHttpClient apacheHttpClient = new (authCode, null, clientConfig);</div><div class="line">        jpushClient.getPushClient().setHttpClient(apacheHttpClienApacheHttpClientt);</div><div class="line">        */</div><div class="line">        PushPayload payload = buildTestPayload();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            PushResult result = jpushClient.sendPush(payload);</div><div class="line">            <span class="keyword">int</span> status = result.getResponseCode();</div><div class="line">            LOG.info(<span class="string">"Got result - "</span> + result);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (APIConnectionException e) &#123;</div><div class="line">            LOG.error(<span class="string">"Connection error. Should retry later. "</span>, e);</div><div class="line">            LOG.error(<span class="string">"Sendno: "</span> + payload.getSendno());</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (APIRequestException e) &#123;</div><div class="line">            LOG.error(<span class="string">"Error response from JPush server. Should review and fix it. "</span>, e);</div><div class="line">            LOG.info(<span class="string">"HTTP Status: "</span> + e.getStatus());</div><div class="line">            LOG.info(<span class="string">"Error Code: "</span> + e.getErrorCode());</div><div class="line">            LOG.info(<span class="string">"Error Message: "</span> + e.getErrorMessage());</div><div class="line">            LOG.info(<span class="string">"Msg ID: "</span> + e.getMsgId());</div><div class="line">            LOG.error(<span class="string">"Sendno: "</span> + payload.getSendno());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> PushPayload buildTestPayload() &#123;</div><div class="line">        String title = <span class="string">"hello world, roc"</span>;</div><div class="line">        String subTitle = <span class="string">"低头前行了这么久，我只是在找一个抬头的机会"</span>;</div><div class="line">        String body = <span class="string">"人这一生，浪费了太多的时间在毫无意义的事情上，担忧、抱怨、埋怨、比较……"</span>;</div><div class="line"></div><div class="line">        IosAlert iosAlert = IosAlert.newBuilder()</div><div class="line">                .setTitleAndBody(title, subTitle, body).build();</div><div class="line">        IosNotification iosNotification = IosNotification.newBuilder()</div><div class="line">                .setAlert(iosAlert).incrBadge(<span class="number">1</span>)</div><div class="line">                .setSound(<span class="string">"happy"</span>).build();</div><div class="line">        Notification notification = Notification.newBuilder().addPlatformNotification(iosNotification).build();</div><div class="line"></div><div class="line">        PushPayload pushPayload = PushPayload</div><div class="line">                .newBuilder()</div><div class="line">                .setPlatform(Platform.android_ios())</div><div class="line">                .setAudience(</div><div class="line">                        Audience.newBuilder()</div><div class="line">                                .addAudienceTarget(</div><div class="line">                                        AudienceTarget.alias(<span class="string">"TEST303644"</span>))</div><div class="line">                                .build())</div><div class="line">                .setNotification(notification)</div><div class="line">                .setOptions(<span class="keyword">Options</span>.newBuilder().setApnsProduction(<span class="keyword">true</span>).build())</div><div class="line">                .build();</div><div class="line">        <span class="keyword">return</span> pushPayload;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Thread Dump</li>
</ul>
<p>Debug跟踪，发现程序进入if分支，调用close()关闭连接后，主线程阻塞进入wait状态。使用IDEA生成thread dump：<br><img src="https://raw.githubusercontent.com/roc-wong/images/master/%E7%A8%8B%E5%BA%8F%E6%89%A7%E8%A1%8Cif%E5%88%86%E6%94%AF.png" alt="此处输入图片的描述"><br><img src="https://raw.githubusercontent.com/roc-wong/images/master/get%20thread%20dump.png" alt="此处输入图片的描述"></p>
<ul>
<li>日志输出</li>
</ul>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">2018-01-09</span> <span class="selector-tag">21</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:19.064</span> <span class="selector-attr">[nioEventLoopGroup-2-1]</span> <span class="selector-tag">DEBUG</span> <span class="selector-tag">io</span><span class="selector-class">.netty</span><span class="selector-class">.handler</span><span class="selector-class">.ssl</span><span class="selector-class">.SslHandler</span> <span class="selector-tag">-</span> <span class="selector-attr">[id: 0x6f019129, L:/10.0.31.70:55848 - R:api.jpush.cn/103.40.232.116:443]</span> <span class="selector-tag">HANDSHAKEN</span>: <span class="selector-tag">TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA</span></div><div class="line"><span class="selector-tag">2018-01-09</span> <span class="selector-tag">21</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:29.324</span> <span class="selector-attr">[nioEventLoopGroup-2-1]</span> <span class="selector-tag">INFO</span>  <span class="selector-tag">c</span><span class="selector-class">.j</span><span class="selector-class">.c</span><span class="selector-class">.connection</span><span class="selector-class">.HttpResponseHandler</span> <span class="selector-tag">-</span> <span class="selector-tag">PooledSlicedByteBuf</span>(<span class="attribute">ridx</span>: <span class="number">0</span>, <span class="attribute">widx</span>: <span class="number">44</span>, <span class="attribute">cap</span>: <span class="number">44</span>/<span class="number">44</span>, <span class="attribute">unwrapped</span>: PooledUnsafeDirectByteBuf(<span class="attribute">ridx</span>: <span class="number">324</span>, <span class="attribute">widx</span>: <span class="number">324</span>, <span class="attribute">cap</span>: <span class="number">373</span>))</div><div class="line"><span class="comment">//此为HttpResponseHandler.java类log输出，与源代码吻合</span></div><div class="line"><span class="selector-tag">2018-01-09</span> <span class="selector-tag">21</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:49.010</span> <span class="selector-attr">[nioEventLoopGroup-2-1]</span> <span class="selector-tag">INFO</span>  <span class="selector-tag">c</span><span class="selector-class">.j</span><span class="selector-class">.c</span><span class="selector-class">.connection</span><span class="selector-class">.HttpResponseHandler</span> <span class="selector-tag">-</span> <span class="selector-tag">closing</span> <span class="selector-tag">connection</span></div></pre></td></tr></table></figure>
<p>主线程处于WAIT状态，Netty异步线程已运行完毕，现场恢复成功。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><ol>
<li>升级极光SDK版本，升级后发现最新版已解决该问题。</li>
<li>增加熔断处理，调用外部服务时，使用Guava SimpleTimeLimiter设置超时熔断。</li>
</ol>
]]></content>
    
    <summary type="html">
    
      极光推送java-sdk-V3.2.15 CountDownLatch使用不当导致线程堵塞
    
    </summary>
    
      <category term="java" scheme="https://roc-wong.github.io/categories/java/"/>
    
    
      <category term="java后端" scheme="https://roc-wong.github.io/tags/java%E5%90%8E%E7%AB%AF/"/>
    
  </entry>
  
  <entry>
    <title>Notepad++-regular-expression</title>
    <link href="https://roc-wong.github.io/blog/2017/08/NotePad-regular-expression.html"/>
    <id>https://roc-wong.github.io/blog/2017/08/NotePad-regular-expression.html</id>
    <published>2017-08-04T12:26:41.000Z</published>
    <updated>2018-11-21T02:18:25.567Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>低头前行了这么久，我只是在找一个抬头的机会</p>
</blockquote>
<p>Notepad++ 正则表达式用法归档</p>
<p>注意: 不支持多行表达式 (involving \n, \r, etc).</p>
<a id="more"></a>
<h2 id="基本表达式"><a href="#基本表达式" class="headerlink" title="基本表达式"></a>基本表达式</h2><table>
<thead>
<tr>
<th>符号</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>.</td>
<td>匹配任意字符，除了新一行(\n)。也就是说 “.”可以匹配 \r ，当文件中同时含有\r and \n时，会引起混乱。要匹配所有的字符，使用\s\S。</td>
</tr>
<tr>
<td>(…)</td>
<td>这个匹配一个标签区域. 这个标签可以被访问，通过语法 \1访问第一个标签, \2 访问第二个, 同理 \3 \4 … \9。 这些标签可以用在当前正则表达式中，或则替search和replace中的换字符串。</td>
</tr>
<tr>
<td>\1, \2, etc</td>
<td>在替换中代表1到9的标签区域(\1 to \9)。例如, 查找字符串 Fred([1-9])XXX 并替换为字符串 Sam\1YYY的方法，当在文件中找到Fred2XXX的字符串时，会替换为Sam2YYY。注意: 只有9个区域能使用，所以我们在使用时很安全，像\10\2 表示区域1和文本”0”以及区域2。</td>
</tr>
<tr>
<td>[…]</td>
<td>表示一个字符集合, 例如 [abc]表示任意字符 a, b or c.我们也可以使用范围例如[a-z] 表示所以的小写字母。</td>
</tr>
<tr>
<td>[^…]</td>
<td>表示字符补集. 例如, [^A-Za-z] 表示任意字符除了字母表。</td>
</tr>
<tr>
<td>^</td>
<td>匹配一行的开始(除非在集合中, 如下).</td>
</tr>
<tr>
<td>$</td>
<td>匹配行尾.</td>
</tr>
<tr>
<td>*</td>
<td>匹配0或多次, 例如 Sa*m 匹配 Sm, Sam, Saam, Saaam 等等.</td>
</tr>
<tr>
<td>+</td>
<td>匹配1次或多次,例如 Sa+m 匹配 Sam, Saam, Saaam 等等.</td>
</tr>
<tr>
<td>?</td>
<td>匹配0或者1次, 例如 Sa?m 匹配 Sm, Sam.</td>
</tr>
<tr>
<td>{n}</td>
<td>匹配确定的 n 次.例如, ‘Sa{2}m’ 匹配 Saam.</td>
</tr>
<tr>
<td>{m,n}</td>
<td>匹配至少m次，至多n次(如果n缺失，则任意次数).例如, ‘Sa{2,3}m’ 匹配 Saam or Saaam. ‘Sa{2,}m’ 与 ‘Saa+m’相同</td>
</tr>
<tr>
<td>*?, +?, ??, {n,m}?</td>
<td>非贪心匹配，匹配第一个有效的匹配，通常 ‘&lt;.&gt;’ 会匹配整个 ‘content’字符串 –但 ‘&lt;.?&gt;’ 只匹配 ” .这个标记一个标签区域，这些区域可以用语法\1 \2 等访问多个对应1-9区域。</td>
</tr>
</tbody>
</table>
<h2 id="标记和分组"><a href="#标记和分组" class="headerlink" title="标记和分组"></a>标记和分组</h2><table>
<thead>
<tr>
<th>符号</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>(…)</td>
<td>一组捕获. 可以通过\1 访问第一个组, \2 访问第二个.</td>
</tr>
<tr>
<td>(?:…)</td>
<td>非捕获组.</td>
</tr>
<tr>
<td>(?=…)</td>
<td>非捕获组 – 向前断言. 例如’(.*)(?=ton)’ 表达式，当 遇到’Appleton’字符串时，会匹配为’Apple’.</td>
</tr>
<tr>
<td>(?&lt;=…)</td>
<td>非捕获组 – 向后断言. 例如’(?&lt;=sir) (.*)’ 表示式，当遇到’sir William’ 字符串时，匹配为’ William’.</td>
</tr>
<tr>
<td>(?!…)</td>
<td>非捕获组 – 消极的向前断言. 例如’.(?!e)’ 表达式，当遇到’Apple’时，会找到每个字母除了 ‘l’，因为它紧跟着 ‘e’.</td>
</tr>
<tr>
<td>(?</td>
<td>非捕获组 – 消极向后断言. 例如 ‘(?</td>
</tr>
<tr>
<td>(?P…)</td>
<td>命名所捕获的组. 提交一个名称到组中供后续使用，例如’(?PA[^\s]+)\s(?P=first)’ 会找到 ‘Apple Apple’. 类似的 ‘(A[^\s]+)\s\1’ 使用组名而不是数字.</td>
</tr>
<tr>
<td>(?=name)</td>
<td>匹配名为name的组. (?P…).</td>
</tr>
<tr>
<td>(?#comment)</td>
<td>批注 –括号中的内容在匹配时将被忽略。</td>
</tr>
</tbody>
</table>
<h2 id="特殊符号"><a href="#特殊符号" class="headerlink" title="特殊符号"></a>特殊符号</h2><table>
<thead>
<tr>
<th>符号</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>\s</td>
<td>匹配空格. 注意，会匹配标记的末尾. 使用 [[:blank:]] 来避免匹配新一行。</td>
</tr>
<tr>
<td>\S</td>
<td>匹配非空白</td>
</tr>
<tr>
<td>\w</td>
<td>匹配单词字符</td>
</tr>
<tr>
<td>\W</td>
<td>匹配非单词字符</td>
</tr>
<tr>
<td>\d</td>
<td>匹配数字字符</td>
</tr>
<tr>
<td>\D</td>
<td>匹配非数字字符</td>
</tr>
<tr>
<td>\b</td>
<td>匹配单词边界. ‘\bW\w+’ 找到W开头的单词</td>
</tr>
<tr>
<td>\B</td>
<td>匹配非单词边界. ‘\Be\B+’ – 找到位于单子中间的字母’e’</td>
</tr>
<tr>
<td>\&lt;</td>
<td>This matches the start of a word using Scintilla’s definitions of words.</td>
</tr>
<tr>
<td>&gt;</td>
<td>This matches the end of a word using Scintilla’s definition of words.</td>
</tr>
<tr>
<td>\x</td>
<td>运行用x来表达可能具有其他意思的字符。例如, [ 用来插入到文本中作为[ 而不是作为字符集的开始.</td>
</tr>
</tbody>
</table>
<h2 id="字符类"><a href="#字符类" class="headerlink" title="字符类"></a>字符类</h2><table>
<thead>
<tr>
<th>符号</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>[[:alpha:]]</td>
<td>匹配字母字符: [A-Za-z]</td>
</tr>
<tr>
<td>[[:digit:]]</td>
<td>匹配数字字符: [0-9]</td>
</tr>
<tr>
<td>[[:xdigit:]]</td>
<td>匹配16进制字符: [0-9A-Fa-f]</td>
</tr>
<tr>
<td>[[:alnum:]]</td>
<td>匹配字母数字字符: [0-9A-Za-z]</td>
</tr>
<tr>
<td>[[:lower:]]</td>
<td>匹配小写字符: [a-z]</td>
</tr>
<tr>
<td>[[:upper:]]</td>
<td>匹配大写字符: [A-Z]</td>
</tr>
<tr>
<td>[[:blank:]]</td>
<td>匹配空白 (空格 or tab):[ \t]</td>
</tr>
<tr>
<td>[[:space:]]</td>
<td>匹配空白字符:[ \t\r\n\v\f]</td>
</tr>
<tr>
<td>[[:punct:]]</td>
<td>匹配标点字符: [-!”#$%&amp;’()*+,./:;&lt;=&gt;?@[]_`{</td>
</tr>
<tr>
<td>[[:graph:]]</td>
<td>匹配图形字符: [\x21-\x7E]</td>
</tr>
<tr>
<td>[[:print:]]</td>
<td>匹配可打印的字符 (graphical characters and spaces)</td>
</tr>
<tr>
<td>[[:cntrl:]]</td>
<td>匹配控制字符</td>
</tr>
</tbody>
</table>
<h2 id="替换操作"><a href="#替换操作" class="headerlink" title="替换操作"></a>替换操作</h2><p>使用正则表达式的标记，通过（）来包围想要用的字符，然后用\1 来替换字符串，第一个匹配文本。</p>
<p>例如:</p>
<p>Text body    Search string    Replace string    Result<br>Hi my name is Fred    my name is (.+)    my name is not \1    Hi my name is not Fred<br>The quick brown fox jumped over the fat lazy dog    brown (.+) jumped over the (.+)    brown \2 jumped over the \1    The quick brown fat jumped over the fox lazy dog</p>
<h2 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h2><p>Support for regular expressions in PN2 is currently limited, the supported patterns and syntax are a very small subset of the powerful expressions supported by perl. 最大的限制是正则表达式只能匹配单行，不能用多行匹配表达。可以用Backslash Expressions代替.</p>
<p>准备计划是使用PCRE库 library (used elsewhere in PN2) 来支持文档搜索.</p>
<p>原文：<a href="http://www.pnotepad.org/docs/search/regular_expressions/" target="_blank" rel="external">http://www.pnotepad.org/docs/search/regular_expressions/</a></p>
<h2 id="应用举例"><a href="#应用举例" class="headerlink" title="应用举例"></a>应用举例</h2><h3 id="删除空白行的方法"><a href="#删除空白行的方法" class="headerlink" title="删除空白行的方法"></a>删除空白行的方法</h3><p>选择替换，把查找模式设置为正则表达式，在查找框中输入 ^\s+  ,替换框留空，点“全部替换”，即可(先全选)。</p>
<h3 id="删除所有行s字符开始后面的所有字符"><a href="#删除所有行s字符开始后面的所有字符" class="headerlink" title="删除所有行s字符开始后面的所有字符"></a>删除所有行s字符开始后面的所有字符</h3><p>选择替换，把查找模式设置为正则表达式，在查找框中输入 ^([^:]<em>):.</em>$，替换框填写$1，点“全部替换”，即可(先全选)。</p>
]]></content>
    
    <summary type="html">
    
      Notepad++ regular expression 正则表达式
    
    </summary>
    
      <category term="IDE" scheme="https://roc-wong.github.io/categories/IDE/"/>
    
    
      <category term="Notepad++" scheme="https://roc-wong.github.io/tags/Notepad/"/>
    
  </entry>
  
  <entry>
    <title>svn-sqliteS10-disk-IO-error</title>
    <link href="https://roc-wong.github.io/blog/2017/08/svn-sqliteS10-disk-IO-error.html"/>
    <id>https://roc-wong.github.io/blog/2017/08/svn-sqliteS10-disk-IO-error.html</id>
    <published>2017-08-04T12:23:50.000Z</published>
    <updated>2018-11-21T02:18:25.531Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>低头前行，莫问前程。</p>
</blockquote>
<p>在使用svn提交项目时，遇到报错：svn: E200030: sqlite[S10]: disk I/O error</p>
<a id="more"></a>
<p>在使用svn提交项目时，遇到报错：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="string">svn:</span> <span class="string">E155004:</span> Run <span class="string">'svn cleanup'</span> to remove locks (type <span class="string">'svn help cleanup'</span> <span class="keyword">for</span> details)</div><div class="line"><span class="string">svn:</span> <span class="string">E155004:</span> Failed to lock working copy <span class="string">'F:\workspace-new\idea-workspace\hbec-app-stock-project'</span>.</div><div class="line"><span class="string">svn:</span> <span class="string">E200030:</span> sqlite[S10]: disk I/O error</div><div class="line"><span class="string">svn:</span> <span class="string">E200042:</span> Additional <span class="string">errors:</span></div><div class="line"><span class="string">svn:</span> <span class="string">E200030:</span> sqlite[S10]: disk I/O error</div><div class="line"><span class="string">svn:</span> <span class="string">E200030:</span> sqlite[S1]: no such <span class="string">savepoint:</span> svn</div><div class="line"><span class="string">svn:</span> <span class="string">E200030:</span> sqlite[S1]: no such <span class="string">savepoint:</span> svn</div><div class="line"><span class="string">svn:</span> <span class="string">E200030:</span> sqlite[S1]: no such <span class="string">savepoint:</span> svn</div><div class="line"><span class="string">svn:</span> <span class="string">E200030:</span> sqlite[S1]: no such <span class="string">savepoint:</span> svn</div></pre></td></tr></table></figure>
<p>此时可通过sqlite3工具来修复，具体步骤为：</p>
<ul>
<li>下载sqlite3工具，下载地址为：<a href="http://www.sqlite.org/download.html" target="_blank" rel="external">http://www.sqlite.org/download.html</a></li>
<li>将sqlite3.exe文件解压缩到.svn目录的同级目录</li>
<li>打开命令行工具，切换到.svn的同级目录<br>  执行命令：<br>  sqlite3.exe .svn/wc.db “reindex nodes”<br>  sqlite3.exe .svn/wc.db “reindex pristine”</li>
</ul>
]]></content>
    
    <summary type="html">
    
      svn E200030 sqlite[S10] disk I/O error
    
    </summary>
    
      <category term="SVN" scheme="https://roc-wong.github.io/categories/SVN/"/>
    
    
      <category term="SVN" scheme="https://roc-wong.github.io/tags/SVN/"/>
    
  </entry>
  
  <entry>
    <title>deadlock-found-when-trying-to-get-lock</title>
    <link href="https://roc-wong.github.io/blog/2017/07/deadlock-found-when-trying-to-get-lock.html"/>
    <id>https://roc-wong.github.io/blog/2017/07/deadlock-found-when-trying-to-get-lock.html</id>
    <published>2017-07-24T04:33:22.000Z</published>
    <updated>2018-11-21T02:18:25.572Z</updated>
    
    <content type="html"><![CDATA[<p>mysql锁机制分为表级锁和行级锁：</p>
<p>共享锁又称为读锁，简称S锁，顾名思义，共享锁就是多个事务对于同一数据可以共享一把锁，都能访问到数据，但是只能读不能修改。</p>
<p>排他锁又称为写锁，简称X锁，顾名思义，排他锁就是不能与其他所并存，如一个事务获取了一个数据行的排他锁，其他事务就不能再获取该行的其他锁，包括共享锁和排他锁，但是获取排他锁的事务是可以对数据就行读取和修改。</p>
<a id="more"></a>
<p>对于共享锁大家可能很好理解，就是多个事务只能读数据不能改数据，对于排他锁大家的理解可能就有些差别，我当初就犯了一个错误，以为排他锁锁住一行数据后，其他事务就不能读取和修改该行数据，其实不是这样的。排他锁指的是一个事务在一行数据加上排他锁后，其他事务不能再在其上加其他的锁。mysql InnoDB引擎默认的修改数据语句，update,delete,insert都会自动给涉及到的数据加上排他锁，select语句默认不会加任何锁类型，如果加排他锁可以使用select …for update语句，加共享锁可以使用select … lock in share mode语句。所以加过排他锁的数据行在其他事务种是不能修改数据的，也不能通过for update和lock in share mode锁的方式查询数据，但可以直接通过select …from…查询数据，因为普通查询没有任何锁机制。</p>
<p><img src="https://raw.githubusercontent.com/roc-wong/images/master/mysql-lock.png" alt="死锁"></p>
<h2 id="案发现场"><a href="#案发现场" class="headerlink" title="案发现场"></a>案发现场</h2><p>API网关在30ms内收到6次相同请求，错误日志：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">Jul <span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ23qpg65e4Z api_qianqian1 <span class="number">2017</span>-<span class="number">07</span>-<span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50.754</span> [http-apr-<span class="number">8080</span>-exec-<span class="number">1379</span>] INFO  h<span class="selector-class">.a</span><span class="selector-class">.a</span><span class="selector-class">.f</span><span class="selector-class">.AppPlatformRateLimiterFilter</span> - parameter=_appCrypt_=VDzT76Hdrp9QAO4lSbQuJeIaKnQ8VZnqljK+YmN2W1tyBSv1JqIhTrDHrBlWM9K8yg3kcLOUmENr1OUc+<span class="number">6</span>xWSL13Z2jaBhCJDrMYWad/H971ilDd4eQMrakZP84dCbXC&amp;_t_=HBStockWarningIos_3.<span class="number">6.4</span>&amp;ticket=<span class="number">7</span>.BdzpPOeP2_7JV6IYArPBIOC36NO2PoCMhVPHiISIEM_tAo7-unTlp_baBhZ79TZskD-HBIBmSnk-<span class="number">7</span>y_tv24wD2IiSgTHlj7x5DTHEV7CacwVdw9jmTCuVdePd4mUaM11k5XGRSsPzqzQmomKMu7aGm8R48Nq-ECE7WpSNtQmExU&amp;</div><div class="line">Jul <span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ23qpg65e4Z api_qianqian1 <span class="number">2017</span>-<span class="number">07</span>-<span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50.756</span> [http-apr-<span class="number">8080</span>-exec-<span class="number">1379</span>] INFO  sky<span class="selector-class">.app</span><span class="selector-class">.api</span><span class="selector-class">.filter</span><span class="selector-class">.RateLimiter</span> - userId:<span class="number">3245964</span>, 在 <span class="number">5s</span> 内第<span class="number">1</span>次 执行操作 http:<span class="comment">//api.*.com/followStockService.follow, 通过流速控制器, 阀值(5s最高40次)</span></div><div class="line"></div><div class="line"></div><div class="line">Jul <span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ23qpg65e4Z api_qianqian1 <span class="number">2017</span>-<span class="number">07</span>-<span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50.756</span> [http-apr-<span class="number">8080</span>-exec-<span class="number">1319</span>] INFO  sky<span class="selector-class">.app</span><span class="selector-class">.api</span><span class="selector-class">.filter</span><span class="selector-class">.RateLimiter</span> - userId:<span class="number">3245964</span>, 在 <span class="number">5s</span> 内第<span class="number">2</span>次 执行操作 http:<span class="comment">//api.*.com/followStockService.follow, 通过流速控制器, 阀值(5s最高40次)</span></div><div class="line">Jul <span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ23qpg65e4Z api_qianqian1 <span class="number">2017</span>-<span class="number">07</span>-<span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50.757</span> [http-apr-<span class="number">8080</span>-exec-<span class="number">1319</span>] DEBUG h<span class="selector-class">.p</span><span class="selector-class">.commons</span><span class="selector-class">.web</span><span class="selector-class">.HbecApiHandleAdapter</span> - param-sha1 : null, appCrypt&lt;<span class="number">1</span>&gt; : VDzT76Hdrp9QAO4lSbQuJeIaKnQ8VZnqljK+YmN2W1tyBSv1JqIhTrDHrBlWM9K8yg3kcLOUmENr1OUc+<span class="number">6</span>xWSL13Z2jaBhCJDrMYWad/H971ilDd4eQMrakZP84dCbXC, dataKey=l7g19q1<span class="variable">$g</span>#*o9v-<span class="number">1</span></div><div class="line"></div><div class="line"></div><div class="line">Jul <span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ23qpg65e4Z api_qianqian1 <span class="number">2017</span>-<span class="number">07</span>-<span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50.755</span> [http-apr-<span class="number">8080</span>-exec-<span class="number">1414</span>] INFO  h<span class="selector-class">.a</span><span class="selector-class">.a</span><span class="selector-class">.f</span><span class="selector-class">.AppPlatformRateLimiterFilter</span> - http request=http:<span class="comment">//api.*.com/followStockService.follow</span></div><div class="line">Jul <span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ23qpg65e4Z api_qianqian1 <span class="number">2017</span>-<span class="number">07</span>-<span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50.755</span> [http-apr-<span class="number">8080</span>-exec-<span class="number">1414</span>] INFO  h<span class="selector-class">.a</span><span class="selector-class">.a</span><span class="selector-class">.f</span><span class="selector-class">.AppPlatformRateLimiterFilter</span> - </div><div class="line">Jul <span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ23qpg65e4Z api_qianqian1 <span class="number">2017</span>-<span class="number">07</span>-<span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50.757</span> [http-apr-<span class="number">8080</span>-exec-<span class="number">1414</span>] INFO  sky<span class="selector-class">.app</span><span class="selector-class">.api</span><span class="selector-class">.filter</span><span class="selector-class">.RateLimiter</span> - userId:<span class="number">3245964</span>, 在 <span class="number">5s</span> 内第<span class="number">3</span>次 执行操作 http:<span class="comment">//api.*.com/followStockService.follow, 通过流速控制器, 阀值(5s最高40次)</span></div><div class="line"></div><div class="line">Jul <span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ23qpg65e4Z api_qianqian1 <span class="number">2017</span>-<span class="number">07</span>-<span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50.756</span> [http-apr-<span class="number">8080</span>-exec-<span class="number">1457</span>] INFO  h<span class="selector-class">.a</span><span class="selector-class">.a</span><span class="selector-class">.f</span><span class="selector-class">.AppPlatformRateLimiterFilter</span> - http request=http:<span class="comment">//api.*.com/followStockService.follow</span></div><div class="line">Jul <span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ23qpg65e4Z api_qianqian1 <span class="number">2017</span>-<span class="number">07</span>-<span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50.756</span> [http-apr-<span class="number">8080</span>-exec-<span class="number">1457</span>] INFO  h<span class="selector-class">.a</span><span class="selector-class">.a</span><span class="selector-class">.f</span><span class="selector-class">.AppPlatformRateLimiterFilter</span> - </div><div class="line">Jul <span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ23qpg65e4Z api_qianqian1 <span class="number">2017</span>-<span class="number">07</span>-<span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50.757</span> [http-apr-<span class="number">8080</span>-exec-<span class="number">1457</span>] INFO  sky<span class="selector-class">.app</span><span class="selector-class">.api</span><span class="selector-class">.filter</span><span class="selector-class">.RateLimiter</span> - userId:<span class="number">3245964</span>, 在 <span class="number">5s</span> 内第<span class="number">4</span>次 执行操作 http:<span class="comment">//api.*.com/followStockService.follow, 通过流速控制器, 阀值(5s最高40次)</span></div><div class="line"></div><div class="line">Jul <span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ23qpg65e4Z api_qianqian1 <span class="number">2017</span>-<span class="number">07</span>-<span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50.757</span> [http-apr-<span class="number">8080</span>-exec-<span class="number">1334</span>] INFO  h<span class="selector-class">.a</span><span class="selector-class">.a</span><span class="selector-class">.f</span><span class="selector-class">.AppPlatformRateLimiterFilter</span> - http request=http:<span class="comment">//api.*.com/followStockService.follow</span></div><div class="line">Jul <span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ23qpg65e4Z api_qianqian1 <span class="number">2017</span>-<span class="number">07</span>-<span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50.757</span> [http-apr-<span class="number">8080</span>-exec-<span class="number">1334</span>] INFO  h<span class="selector-class">.a</span><span class="selector-class">.a</span><span class="selector-class">.f</span><span class="selector-class">.AppPlatformRateLimiterFilter</span> - parameter=_appCrypt_=VDzT76Hdrp9QAO4lSbQuJeIaKnQ8VZnqljK+YmN2W1tyBSv1JqIhTrDHrBlWM9K8yg3kcLOUmENr1OUc+<span class="number">6</span>xWSL13Z2jaBhCJDrMYWad/H971ilDd4eQMrakZP84dCbXC&amp;_t_=HBStockWarningIos_3.<span class="number">6.4</span>&amp;ticket=<span class="number">7</span>.BdzpPOeP2_7JV6IYArPBIOC36NO2PoCMhVPHiISIEM_tAo7-unTlp_baBhZ79TZskD-HBIBmSnk-<span class="number">7</span>y_tv24wD2IiSgTHlj7x5DTHEV7CacwVdw9jmTCuVdePd4mUaM11k5XGRSsPzqzQmomKMu7aGm8R48Nq-ECE7WpSNtQmExU&amp;</div><div class="line">Jul <span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ23qpg65e4Z api_qianqian1 <span class="number">2017</span>-<span class="number">07</span>-<span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50.759</span> [http-apr-<span class="number">8080</span>-exec-<span class="number">1334</span>] INFO  sky<span class="selector-class">.app</span><span class="selector-class">.api</span><span class="selector-class">.filter</span><span class="selector-class">.RateLimiter</span> - userId:<span class="number">3245964</span>, 在 <span class="number">5s</span> 内第<span class="number">5</span>次 执行操作 http:<span class="comment">//api.*.com/followStockService.follow, 通过流速控制器, 阀值(5s最高40次)</span></div></pre></td></tr></table></figure>
<p>业务日志</p>
<p>追踪到业务节点后，发现mysql出现死锁问题：Deadlock found when trying to get lock; try restarting transaction</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 <span class="number">17</span>-07-23 <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span>.<span class="number">779</span> ERROR[DubboServerHandler-10.<span class="number">253</span>.<span class="number">17</span>.<span class="number">105</span>:<span class="number">20880</span>-thread-193 DbService.execute:<span class="number">1247</span>] &#123;&#125;</div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 sky.platform.commons.exceptions.HbecDbServiceException: service=db,message=sky.platform.commons.exceptions.HbecDbServiceException: service=db,message=</div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 <span class="comment">### Error updating database.  Cause: com.mysql.jdbc.exceptions.jdbc4.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 <span class="comment">### The error may involve WarnFollowMapper.follow-Inline</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 <span class="comment">### The error occurred while setting parameters</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 <span class="comment">### SQL: insert into test_follow (user_id, security_type, stock_code, exchange, stock_name, sub_fund_type, sort)         values (?, ?,  ?,                 ?,?, ?,                 (select max(IFNULL(t1.sort,0)) + 1 from test_FOLLOW t1 where t1.user_id = ?) )         on duplicate key update sort= (select max(IFNULL(t2.sort,0)) + 1 from test_follow t2 where t2.user_id= ?)</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 <span class="comment">### Cause: com.mysql.jdbc.exceptions.jdbc4.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> sky.platform.runtime.DbServiceInterceptor$<span class="number">1</span>.execute(DbServiceInterceptor.<span class="keyword">java:39) </span>~[hbec-platform-commons-0.<span class="number">0</span>.<span class="number">32</span>-SNAPSHOT.<span class="keyword">jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> sky.platform.runtime.DbService.execute(DbService.<span class="keyword">java:1242) </span>~[hbec-platform-commons-0.<span class="number">0</span>.<span class="number">32</span>-SNAPSHOT.<span class="keyword">jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> sky.platform.runtime.DbServiceInterceptor.intercept(DbServiceInterceptor.<span class="keyword">java:33) </span>[hbec-platform-commons-0.<span class="number">0</span>.<span class="number">32</span>-SNAPSHOT.<span class="keyword">jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> sky.app.stock.follow.service.impl.WarnFollowServiceImpl$$EnhancerByCGLIB$$<span class="number">41</span>e28e09.follow(&lt;generated&gt;) [spring-core-4.<span class="number">0</span>.<span class="number">2</span>.RELEASE.<span class="keyword">jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> sky.app.stock.follow.controller.impl.FollowStockControllerImpl.follow(FollowStockControllerImpl.<span class="keyword">java:304) </span>[hbec-app-stock-follow-1.<span class="number">0</span>.<span class="number">2</span>-SNAPSHOT.<span class="keyword">jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.common.<span class="keyword">bytecode.Wrapper94.invokeMethod(Wrapper94.java) </span>[na:<span class="number">2</span>.<span class="number">5</span>.<span class="number">3</span>]</div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.rpc.proxy.<span class="keyword">javassist.JavassistProxyFactory$1.doInvoke(JavassistProxyFactory.java:46) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.rpc.proxy.AbstractProxyInvoker.invoke(AbstractProxyInvoker.<span class="keyword">java:72) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.rpc.protocol.InvokerWrapper.invoke(InvokerWrapper.<span class="keyword">java:53) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.rpc.filter.ExceptionFilter.invoke(ExceptionFilter.<span class="keyword">java:64) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.rpc.protocol.ProtocolFilterWrapper$<span class="number">1</span>.invoke(ProtocolFilterWrapper.<span class="keyword">java:91) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.rpc.filter.TimeoutFilter.invoke(TimeoutFilter.<span class="keyword">java:42) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.rpc.protocol.ProtocolFilterWrapper$<span class="number">1</span>.invoke(ProtocolFilterWrapper.<span class="keyword">java:91) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.monitor.support.MonitorFilter.invoke(MonitorFilter.<span class="keyword">java:75) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.rpc.protocol.ProtocolFilterWrapper$<span class="number">1</span>.invoke(ProtocolFilterWrapper.<span class="keyword">java:91) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.rpc.protocol.dubbo.filter.TraceFilter.invoke(TraceFilter.<span class="keyword">java:78) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.rpc.protocol.ProtocolFilterWrapper$<span class="number">1</span>.invoke(ProtocolFilterWrapper.<span class="keyword">java:91) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> sky.app.eagleeye.dubbo.EagleeyeFilter.invoke(EagleeyeFilter.<span class="keyword">java:155) </span>[hbec-platform-runtime-app-0.<span class="number">0</span>.<span class="number">32</span>-SNAPSHOT.<span class="keyword">jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.rpc.protocol.ProtocolFilterWrapper$<span class="number">1</span>.invoke(ProtocolFilterWrapper.<span class="keyword">java:91) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.rpc.filter.ContextFilter.invoke(ContextFilter.<span class="keyword">java:60) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.rpc.protocol.ProtocolFilterWrapper$<span class="number">1</span>.invoke(ProtocolFilterWrapper.<span class="keyword">java:91) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.rpc.filter.GenericFilter.invoke(GenericFilter.<span class="keyword">java:112) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.rpc.protocol.ProtocolFilterWrapper$<span class="number">1</span>.invoke(ProtocolFilterWrapper.<span class="keyword">java:91) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.rpc.filter.ClassLoaderFilter.invoke(ClassLoaderFilter.<span class="keyword">java:38) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.rpc.protocol.ProtocolFilterWrapper$<span class="number">1</span>.invoke(ProtocolFilterWrapper.<span class="keyword">java:91) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.rpc.filter.EchoFilter.invoke(EchoFilter.<span class="keyword">java:38) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.rpc.protocol.ProtocolFilterWrapper$<span class="number">1</span>.invoke(ProtocolFilterWrapper.<span class="keyword">java:91) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.rpc.protocol.dubbo.DubboProtocol$<span class="number">1</span>.reply(DubboProtocol.<span class="keyword">java:108) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.remoting.exchange.support.header.HeaderExchangeHandler.handleRequest(HeaderExchangeHandler.<span class="keyword">java:84) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.remoting.exchange.support.header.HeaderExchangeHandler.received(HeaderExchangeHandler.<span class="keyword">java:170) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.remoting.transport.DecodeHandler.received(DecodeHandler.<span class="keyword">java:52) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.alibaba.dubbo.remoting.transport.<span class="keyword">dispatcher.ChannelEventRunnable.run(ChannelEventRunnable.java:82) </span>[dubbo-2.<span class="number">5</span>.<span class="number">3</span>.<span class="keyword">jar:2.5.3]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> <span class="keyword">java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) </span>[na:<span class="number">1</span>.<span class="number">7</span>.<span class="number">0</span>_55]</div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> <span class="keyword">java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) </span>[na:<span class="number">1</span>.<span class="number">7</span>.<span class="number">0</span>_55]</div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> <span class="keyword">java.lang.Thread.run(Thread.java:745) </span>[na:<span class="number">1</span>.<span class="number">7</span>.<span class="number">0</span>_55]</div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 Caused <span class="keyword">by: </span><span class="keyword">java.lang.RuntimeException: </span>sky.platform.commons.exceptions.HbecDbServiceException: service=db,message=</div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 <span class="comment">### Error updating database.  Cause: com.mysql.jdbc.exceptions.jdbc4.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 <span class="comment">### The error may involve WarnFollowMapper.follow-Inline</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 <span class="comment">### The error occurred while setting parameters</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 <span class="comment">### SQL: insert into test_follow (user_id, security_type, stock_code, exchange, stock_name, sub_fund_type, sort)         values (?, ?,  ?,                 ?,?, ?,                 (select max(IFNULL(t1.sort,0)) + 1 from test_FOLLOW t1 where t1.user_id = ?) )         on duplicate key update sort= (select max(IFNULL(t2.sort,0)) + 1 from test_follow t2 where t2.user_id= ?)</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 <span class="comment">### Cause: com.mysql.jdbc.exceptions.jdbc4.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> sky.app.stock.follow.repository.impl.WarnFollowRepository.follow(WarnFollowRepository.<span class="keyword">java:238) </span>~[hbec-app-stock-follow-1.<span class="number">0</span>.<span class="number">2</span>-SNAPSHOT.<span class="keyword">jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> sky.app.stock.follow.service.impl.WarnFollowServiceImpl.follow(WarnFollowServiceImpl.<span class="keyword">java:87) </span>~[hbec-app-stock-follow-1.<span class="number">0</span>.<span class="number">2</span>-SNAPSHOT.<span class="keyword">jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> sky.app.stock.follow.service.impl.WarnFollowServiceImpl$$EnhancerByCGLIB$$<span class="number">41</span>e28e09.CGLIB$follow$<span class="number">0</span>(&lt;generated&gt;) [spring-core-4.<span class="number">0</span>.<span class="number">2</span>.RELEASE.<span class="keyword">jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> sky.app.stock.follow.service.impl.WarnFollowServiceImpl$$EnhancerByCGLIB$$<span class="number">41</span>e28e09$$FastClassByCGLIB$$cf<span class="number">1f</span>7d<span class="number">1b</span>.invoke(&lt;generated&gt;) ~[spring-core-4.<span class="number">0</span>.<span class="number">2</span>.RELEASE.<span class="keyword">jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> <span class="keyword">org.springframework.cglib.proxy.MethodProxy.invokeSuper(MethodProxy.java:228) </span>~[spring-core-4.<span class="number">0</span>.<span class="number">2</span>.RELEASE.<span class="keyword">jar:4.0.2.RELEASE]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> sky.platform.runtime.DbServiceInterceptor$<span class="number">1</span>.execute(DbServiceInterceptor.<span class="keyword">java:37) </span>~[hbec-platform-commons-0.<span class="number">0</span>.<span class="number">32</span>-SNAPSHOT.<span class="keyword">jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	... <span class="number">34</span> common frames omitted</div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 Caused <span class="keyword">by: </span>sky.platform.commons.exceptions.HbecDbServiceException: service=db,message=</div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 <span class="comment">### Error updating database.  Cause: com.mysql.jdbc.exceptions.jdbc4.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 <span class="comment">### The error may involve WarnFollowMapper.follow-Inline</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 <span class="comment">### The error occurred while setting parameters</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 <span class="comment">### SQL: insert into test_follow (user_id, security_type, stock_code, exchange, stock_name, sub_fund_type, sort)         values (?, ?,  ?,                 ?,?, ?,                 (select max(IFNULL(t1.sort,0)) + 1 from test_FOLLOW t1 where t1.user_id = ?) )         on duplicate key update sort= (select max(IFNULL(t2.sort,0)) + 1 from test_follow t2 where t2.user_id= ?)</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 <span class="comment">### Cause: com.mysql.jdbc.exceptions.jdbc4.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> sky.platform.runtime.DbService.myInsert(DbService.<span class="keyword">java:2345) </span>~[hbec-platform-commons-0.<span class="number">0</span>.<span class="number">32</span>-SNAPSHOT.<span class="keyword">jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> sky.app.stock.follow.repository.impl.WarnFollowRepository.follow(WarnFollowRepository.<span class="keyword">java:236) </span>~[hbec-app-stock-follow-1.<span class="number">0</span>.<span class="number">2</span>-SNAPSHOT.<span class="keyword">jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	... <span class="number">39</span> common frames omitted</div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 Caused <span class="keyword">by: </span><span class="keyword">org.apache.ibatis.exceptions.PersistenceException: </span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 <span class="comment">### Error updating database.  Cause: com.mysql.jdbc.exceptions.jdbc4.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 <span class="comment">### The error may involve WarnFollowMapper.follow-Inline</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 <span class="comment">### The error occurred while setting parameters</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 <span class="comment">### SQL: insert into test_follow (user_id, security_type, stock_code, exchange, stock_name, sub_fund_type, sort)         values (?, ?,  ?,                 ?,?, ?,                 (select max(IFNULL(t1.sort,0)) + 1 from test_FOLLOW t1 where t1.user_id = ?) )         on duplicate key update sort= (select max(IFNULL(t2.sort,0)) + 1 from test_follow t2 where t2.user_id= ?)</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 <span class="comment">### Cause: com.mysql.jdbc.exceptions.jdbc4.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> <span class="keyword">org.apache.ibatis.exceptions.ExceptionFactory.wrapException(ExceptionFactory.java:26) </span>~[mybatis-3.<span class="number">2</span>.<span class="number">8</span>.<span class="keyword">jar:3.2.8]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> <span class="keyword">org.apache.ibatis.session.defaults.DefaultSqlSession.update(DefaultSqlSession.java:154) </span>~[mybatis-3.<span class="number">2</span>.<span class="number">8</span>.<span class="keyword">jar:3.2.8]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> <span class="keyword">org.apache.ibatis.session.defaults.DefaultSqlSession.insert(DefaultSqlSession.java:141) </span>~[mybatis-3.<span class="number">2</span>.<span class="number">8</span>.<span class="keyword">jar:3.2.8]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> sky.platform.runtime.DbService.myInsert(DbService.<span class="keyword">java:2331) </span>~[hbec-platform-commons-0.<span class="number">0</span>.<span class="number">32</span>-SNAPSHOT.<span class="keyword">jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	... <span class="number">40</span> common frames omitted</div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 Caused <span class="keyword">by: </span>com.mysql.<span class="keyword">jdbc.exceptions.jdbc4.MySQLTransactionRollbackException: </span>Deadlock found when trying to get lock<span class="comment">; try restarting transaction</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method) ~[na:<span class="number">1</span>.<span class="number">7</span>.<span class="number">0</span>_55]</div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.<span class="keyword">java:57) </span>~[na:<span class="number">1</span>.<span class="number">7</span>.<span class="number">0</span>_55]</div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.<span class="keyword">java:45) </span>~[na:<span class="number">1</span>.<span class="number">7</span>.<span class="number">0</span>_55]</div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> <span class="keyword">java.lang.reflect.Constructor.newInstance(Constructor.java:526) </span>~[na:<span class="number">1</span>.<span class="number">7</span>.<span class="number">0</span>_55]</div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.mysql.<span class="keyword">jdbc.Util.handleNewInstance(Util.java:411) </span>~[mysql-connector-<span class="keyword">java-5.1.28.jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.mysql.<span class="keyword">jdbc.Util.getInstance(Util.java:386) </span>~[mysql-connector-<span class="keyword">java-5.1.28.jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.mysql.<span class="keyword">jdbc.SQLError.createSQLException(SQLError.java:1066) </span>~[mysql-connector-<span class="keyword">java-5.1.28.jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.mysql.<span class="keyword">jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:4237) </span>~[mysql-connector-<span class="keyword">java-5.1.28.jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.mysql.<span class="keyword">jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:4169) </span>~[mysql-connector-<span class="keyword">java-5.1.28.jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.mysql.<span class="keyword">jdbc.MysqlIO.sendCommand(MysqlIO.java:2617) </span>~[mysql-connector-<span class="keyword">java-5.1.28.jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.mysql.<span class="keyword">jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:2778) </span>~[mysql-connector-<span class="keyword">java-5.1.28.jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.mysql.<span class="keyword">jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2825) </span>~[mysql-connector-<span class="keyword">java-5.1.28.jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.mysql.<span class="keyword">jdbc.PreparedStatement.executeInternal(PreparedStatement.java:2156) </span>~[mysql-connector-<span class="keyword">java-5.1.28.jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.mysql.<span class="keyword">jdbc.PreparedStatement.execute(PreparedStatement.java:1379) </span>~[mysql-connector-<span class="keyword">java-5.1.28.jar:na]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> sun.reflect.GeneratedMethodAccessor199.invoke(Unknown Source) ~[na:na]</div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.<span class="keyword">java:43) </span>~[na:<span class="number">1</span>.<span class="number">7</span>.<span class="number">0</span>_55]</div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> <span class="keyword">java.lang.reflect.Method.invoke(Method.java:606) </span>~[na:<span class="number">1</span>.<span class="number">7</span>.<span class="number">0</span>_55]</div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> <span class="keyword">org.apache.ibatis.logging.jdbc.PreparedStatementLogger.invoke(PreparedStatementLogger.java:62) </span>~[mybatis-3.<span class="number">2</span>.<span class="number">8</span>.<span class="keyword">jar:3.2.8]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> com.sun.proxy.$Proxy28.execute(Unknown Source) ~[na:na]</div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> <span class="keyword">org.apache.ibatis.executor.statement.PreparedStatementHandler.update(PreparedStatementHandler.java:44) </span>~[mybatis-3.<span class="number">2</span>.<span class="number">8</span>.<span class="keyword">jar:3.2.8]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> <span class="keyword">org.apache.ibatis.executor.statement.RoutingStatementHandler.update(RoutingStatementHandler.java:69) </span>~[mybatis-3.<span class="number">2</span>.<span class="number">8</span>.<span class="keyword">jar:3.2.8]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> <span class="keyword">org.apache.ibatis.executor.SimpleExecutor.doUpdate(SimpleExecutor.java:48) </span>~[mybatis-3.<span class="number">2</span>.<span class="number">8</span>.<span class="keyword">jar:3.2.8]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> <span class="keyword">org.apache.ibatis.executor.BaseExecutor.update(BaseExecutor.java:105) </span>~[mybatis-3.<span class="number">2</span>.<span class="number">8</span>.<span class="keyword">jar:3.2.8]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> <span class="keyword">org.apache.ibatis.executor.CachingExecutor.update(CachingExecutor.java:71) </span>~[mybatis-3.<span class="number">2</span>.<span class="number">8</span>.<span class="keyword">jar:3.2.8]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	<span class="built_in">at</span> <span class="keyword">org.apache.ibatis.session.defaults.DefaultSqlSession.update(DefaultSqlSession.java:152) </span>~[mybatis-3.<span class="number">2</span>.<span class="number">8</span>.<span class="keyword">jar:3.2.8]</span></div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 	... <span class="number">42</span> common frames omitted</div><div class="line"><span class="keyword">Jul </span><span class="number">23</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span> iZ2360o6lpyZ warn1 <span class="number">17</span>-07-23 <span class="number">17</span>:<span class="number">12</span>:<span class="number">50</span>.<span class="number">780</span> <span class="built_in">DEBUG</span>[DubboServerHandler-10.<span class="number">253</span>.<span class="number">17</span>.<span class="number">105</span>:<span class="number">20880</span>-thread-192 follow.debug:<span class="number">139</span>]MYBATIS &lt;==    Updates: <span class="number">2</span></div></pre></td></tr></table></figure>
<p>查看数据库引擎状态</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">show</span> <span class="keyword">engine</span> <span class="keyword">innodb</span> <span class="keyword">status</span></div></pre></td></tr></table></figure>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">------------------------</div><div class="line">LATEST DETECTED DEADLOCK</div><div class="line">------------------------</div><div class="line"><span class="number">2017</span>-<span class="number">07</span>-<span class="number">23</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">58</span> <span class="number">2</span>afc664c2700</div><div class="line">*** (<span class="number">1</span>) TRANSACTION:</div><div class="line">TRANSACTION <span class="number">730441984</span>, ACTIVE <span class="number">0.003</span> sec inserting</div><div class="line">mysql tables <span class="keyword">in</span> use <span class="number">3</span>, <span class="keyword">locked</span> <span class="number">3</span></div><div class="line">LOCK WAIT <span class="number">8</span> lock struct(s), heap size <span class="number">2936</span>, <span class="number">37</span> row lock(s), undo log entries <span class="number">1</span></div><div class="line">LOCK BLOCKING MySQL thread id: <span class="number">12246957</span> <span class="keyword">block</span> <span class="number">12256080</span></div><div class="line">MySQL thread id <span class="number">12256080</span>, OS thread handle <span class="number">0</span>x2afc48c40700, query id <span class="number">3543571324</span> <span class="number">10.253</span>.<span class="number">17.105</span> test_app Sending data</div><div class="line">insert <span class="keyword">into</span> test_follow (user_id, security_type, stock_code, exchange, stock_name, sub_fund_type, sort)</div><div class="line">        values (<span class="number">3245964</span>, <span class="number">4</span>,  <span class="string">'601318'</span>,</div><div class="line">                <span class="string">'SH'</span>,<span class="string">'中国平安'</span>, null,</div><div class="line">                (<span class="keyword">select</span> max(IFNULL(t1.sort,<span class="number">0</span>)) + <span class="number">1</span> <span class="keyword">from</span> test_FOLLOW t1 <span class="keyword">where</span> t1.user_id = <span class="number">3245964</span>) )</div><div class="line">        <span class="keyword">on</span> duplicate key update sort= (<span class="keyword">select</span> max(IFNULL(t2.sort,<span class="number">0</span>)) + <span class="number">1</span> <span class="keyword">from</span> test_follow t2 <span class="keyword">where</span> t2.user_id= <span class="number">3245964</span>)</div><div class="line">*** (<span class="number">1</span>) WAITING <span class="keyword">FOR</span> THIS LOCK <span class="keyword">TO</span> BE GRANTED:</div><div class="line"><span class="keyword">RECORD</span> LOCKS space id <span class="number">1198</span> page no <span class="number">842</span> n bits <span class="number">696</span> <span class="keyword">index</span> `unique_index` <span class="keyword">of</span> table `wndb`.`test_follow` trx id <span class="number">730441984</span> lock_mode X waiting</div><div class="line"><span class="keyword">Record</span> lock, heap no <span class="number">624</span> PHYSICAL <span class="keyword">RECORD</span>: n_fields <span class="number">4</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: len <span class="number">4</span>; hex <span class="number">8031878</span>c; <span class="keyword">asc</span>  <span class="number">1</span>  ;;</div><div class="line"> <span class="number">1</span>: len <span class="number">1</span>; hex <span class="number">84</span>; <span class="keyword">asc</span>  ;;</div><div class="line"> <span class="number">2</span>: len <span class="number">6</span>; hex <span class="number">363031333138</span>; <span class="keyword">asc</span> <span class="number">601318</span>;;</div><div class="line"> <span class="number">3</span>: len <span class="number">4</span>; hex <span class="number">800399</span>cb; <span class="keyword">asc</span>     ;;</div><div class="line"></div><div class="line">*** (<span class="number">2</span>) TRANSACTION:</div><div class="line">TRANSACTION <span class="number">730441985</span>, ACTIVE <span class="number">0.001</span> sec inserting</div><div class="line">mysql tables <span class="keyword">in</span> use <span class="number">3</span>, <span class="keyword">locked</span> <span class="number">3</span></div><div class="line"><span class="number">8</span> lock struct(s), heap size <span class="number">2936</span>, <span class="number">37</span> row lock(s), undo log entries <span class="number">1</span></div><div class="line">MySQL thread id <span class="number">12246957</span>, OS thread handle <span class="number">0</span>x2afc664c2700, query id <span class="number">3543571329</span> <span class="number">10.253</span>.<span class="number">17.105</span> test_app Sending data</div><div class="line">insert <span class="keyword">into</span> test_follow (user_id, security_type, stock_code, exchange, stock_name, sub_fund_type, sort)</div><div class="line">        values (<span class="number">3245964</span>, <span class="number">4</span>,  <span class="string">'601318'</span>,</div><div class="line">                <span class="string">'SH'</span>,<span class="string">'中国平安'</span>, null,</div><div class="line">                (<span class="keyword">select</span> max(IFNULL(t1.sort,<span class="number">0</span>)) + <span class="number">1</span> <span class="keyword">from</span> test_FOLLOW t1 <span class="keyword">where</span> t1.user_id = <span class="number">3245964</span>) )</div><div class="line">        <span class="keyword">on</span> duplicate key update sort= (<span class="keyword">select</span> max(IFNULL(t2.sort,<span class="number">0</span>)) + <span class="number">1</span> <span class="keyword">from</span> test_follow t2 <span class="keyword">where</span> t2.user_id= <span class="number">3245964</span>)</div><div class="line">*** (<span class="number">2</span>) HOLDS THE LOCK(S):</div><div class="line"><span class="keyword">RECORD</span> LOCKS space id <span class="number">1198</span> page no <span class="number">842</span> n bits <span class="number">696</span> <span class="keyword">index</span> `unique_index` <span class="keyword">of</span> table `wndb`.`test_follow` trx id <span class="number">730441985</span> lock mode S locks rec but <span class="keyword">not</span> gap</div><div class="line"><span class="keyword">Record</span> lock, heap no <span class="number">624</span> PHYSICAL <span class="keyword">RECORD</span>: n_fields <span class="number">4</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: len <span class="number">4</span>; hex <span class="number">8031878</span>c; <span class="keyword">asc</span>  <span class="number">1</span>  ;;</div><div class="line"> <span class="number">1</span>: len <span class="number">1</span>; hex <span class="number">84</span>; <span class="keyword">asc</span>  ;;</div><div class="line"> <span class="number">2</span>: len <span class="number">6</span>; hex <span class="number">363031333138</span>; <span class="keyword">asc</span> <span class="number">601318</span>;;</div><div class="line"> <span class="number">3</span>: len <span class="number">4</span>; hex <span class="number">800399</span>cb; <span class="keyword">asc</span>     ;;</div><div class="line"></div><div class="line">*** (<span class="number">2</span>) WAITING <span class="keyword">FOR</span> THIS LOCK <span class="keyword">TO</span> BE GRANTED:</div><div class="line"><span class="keyword">RECORD</span> LOCKS space id <span class="number">1198</span> page no <span class="number">842</span> n bits <span class="number">696</span> <span class="keyword">index</span> `unique_index` <span class="keyword">of</span> table `wndb`.`test_follow` trx id <span class="number">730441985</span> lock_mode X waiting</div><div class="line"><span class="keyword">Record</span> lock, heap no <span class="number">624</span> PHYSICAL <span class="keyword">RECORD</span>: n_fields <span class="number">4</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: len <span class="number">4</span>; hex <span class="number">8031878</span>c; <span class="keyword">asc</span>  <span class="number">1</span>  ;;</div><div class="line"> <span class="number">1</span>: len <span class="number">1</span>; hex <span class="number">84</span>; <span class="keyword">asc</span>  ;;</div><div class="line"> <span class="number">2</span>: len <span class="number">6</span>; hex <span class="number">363031333138</span>; <span class="keyword">asc</span> <span class="number">601318</span>;;</div><div class="line"> <span class="number">3</span>: len <span class="number">4</span>; hex <span class="number">800399</span>cb; <span class="keyword">asc</span>     ;;</div><div class="line"></div><div class="line">*** WE ROLL BACK TRANSACTION (<span class="number">2</span>)</div></pre></td></tr></table></figure>
<p>从中可以看到两个事务在等待X锁<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">WAITING FOR THIS <span class="keyword">LOCK</span> <span class="keyword">TO</span> BE GRANTED:</div><div class="line"><span class="built_in">RECORD</span> LOCKS <span class="keyword">space</span> <span class="keyword">id</span> <span class="number">1198</span> page <span class="keyword">no</span> <span class="number">842</span> n bits <span class="number">696</span> <span class="keyword">index</span> <span class="string">`unique_index`</span> <span class="keyword">of</span> <span class="keyword">table</span> <span class="string">`wndb`</span>.<span class="string">`test_follow`</span> trx <span class="keyword">id</span> <span class="number">730441984</span> lock_mode X waiting</div><div class="line"><span class="built_in">Record</span> <span class="keyword">lock</span></div><div class="line"></div><div class="line">(<span class="number">2</span>) HOLDS THE <span class="keyword">LOCK</span>(S):</div><div class="line"><span class="built_in">RECORD</span> LOCKS <span class="keyword">space</span> <span class="keyword">id</span> <span class="number">1198</span> page <span class="keyword">no</span> <span class="number">842</span> n bits <span class="number">696</span> <span class="keyword">index</span> <span class="string">`unique_index`</span> <span class="keyword">of</span> <span class="keyword">table</span> <span class="string">`wndb`</span>.<span class="string">`test_follow`</span> trx <span class="keyword">id</span> <span class="number">730441985</span> <span class="keyword">lock</span> <span class="keyword">mode</span> S locks rec but <span class="keyword">not</span> gap</div><div class="line"><span class="built_in">Record</span> <span class="keyword">lock</span>, <span class="keyword">heap</span> <span class="keyword">no</span> <span class="number">624</span> <span class="keyword">PHYSICAL</span> <span class="built_in">RECORD</span></div><div class="line"></div><div class="line">(<span class="number">2</span>) WAITING <span class="keyword">FOR</span> THIS <span class="keyword">LOCK</span> <span class="keyword">TO</span> BE GRANTED:</div><div class="line"><span class="built_in">RECORD</span> LOCKS <span class="keyword">space</span> <span class="keyword">id</span> <span class="number">1198</span> page <span class="keyword">no</span> <span class="number">842</span> n bits <span class="number">696</span> <span class="keyword">index</span> <span class="string">`unique_index`</span> <span class="keyword">of</span> <span class="keyword">table</span> <span class="string">`wndb`</span>.<span class="string">`test_follow`</span> trx <span class="keyword">id</span> <span class="number">730441985</span> lock_mode X waiting</div><div class="line"><span class="built_in">Record</span> <span class="keyword">lock</span>, <span class="keyword">heap</span> <span class="keyword">no</span> <span class="number">624</span> <span class="keyword">PHYSICAL</span> <span class="built_in">RECORD</span></div></pre></td></tr></table></figure></p>
<h2 id="重现"><a href="#重现" class="headerlink" title="重现"></a>重现</h2><h3 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1.准备工作"></a>1.准备工作</h3><ul>
<li>同时开启三个command prompt，远程连接mysql服务器：mysql -uroc -proc -h10.0.30.59 wndb</li>
<li>关闭自动提交：set autocommit=0</li>
</ul>
<h3 id="2-模拟请求"><a href="#2-模拟请求" class="headerlink" title="2.模拟请求"></a>2.模拟请求</h3><p>Session A<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">begin</span>;</div><div class="line"></div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_follow (user_id, security_type, stock_code, <span class="keyword">exchange</span>, stock_name, sub_fund_type, <span class="keyword">sort</span>) <span class="keyword">values</span> (<span class="number">3245964</span>, <span class="number">4</span>, <span class="string">'600628'</span>, <span class="string">'SH'</span>,<span class="string">'新世界'</span>, <span class="literal">null</span>, (<span class="keyword">select</span> <span class="keyword">max</span>(<span class="keyword">IFNULL</span>(t1.sort,<span class="number">0</span>)) + <span class="number">1</span> <span class="keyword">from</span> test_FOLLOW t1 <span class="keyword">where</span> t1.user_id = <span class="number">3245964</span>) ) <span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span> <span class="keyword">sort</span>= (<span class="keyword">select</span> <span class="keyword">max</span>(<span class="keyword">IFNULL</span>(t2.sort,<span class="number">0</span>)) + <span class="number">1</span> <span class="keyword">from</span> test_follow t2 <span class="keyword">where</span> t2.user_id= <span class="number">3245964</span>);</div></pre></td></tr></table></figure></p>
<p>Session B<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">begin</span>;</div><div class="line"></div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_follow (user_id, security_type, stock_code, <span class="keyword">exchange</span>, stock_name, sub_fund_type, <span class="keyword">sort</span>) <span class="keyword">values</span> (<span class="number">3245964</span>, <span class="number">4</span>, <span class="string">'600628'</span>, <span class="string">'SH'</span>,<span class="string">'新世界'</span>, <span class="literal">null</span>, (<span class="keyword">select</span> <span class="keyword">max</span>(<span class="keyword">IFNULL</span>(t1.sort,<span class="number">0</span>)) + <span class="number">1</span> <span class="keyword">from</span> test_FOLLOW t1 <span class="keyword">where</span> t1.user_id = <span class="number">3245964</span>) ) <span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span> <span class="keyword">sort</span>= (<span class="keyword">select</span> <span class="keyword">max</span>(<span class="keyword">IFNULL</span>(t2.sort,<span class="number">0</span>)) + <span class="number">1</span> <span class="keyword">from</span> test_follow t2 <span class="keyword">where</span> t2.user_id= <span class="number">3245964</span>);</div></pre></td></tr></table></figure></p>
<p>Session C<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">begin</span>;</div><div class="line"></div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_follow (user_id, security_type, stock_code, <span class="keyword">exchange</span>, stock_name, sub_fund_type, <span class="keyword">sort</span>) <span class="keyword">values</span> (<span class="number">3245964</span>, <span class="number">4</span>, <span class="string">'600628'</span>, <span class="string">'SH'</span>,<span class="string">'新世界'</span>, <span class="literal">null</span>, (<span class="keyword">select</span> <span class="keyword">max</span>(<span class="keyword">IFNULL</span>(t1.sort,<span class="number">0</span>)) + <span class="number">1</span> <span class="keyword">from</span> test_FOLLOW t1 <span class="keyword">where</span> t1.user_id = <span class="number">3245964</span>) ) <span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span> <span class="keyword">sort</span>= (<span class="keyword">select</span> <span class="keyword">max</span>(<span class="keyword">IFNULL</span>(t2.sort,<span class="number">0</span>)) + <span class="number">1</span> <span class="keyword">from</span> test_follow t2 <span class="keyword">where</span> t2.user_id= <span class="number">3245964</span>);</div></pre></td></tr></table></figure></p>
<p>commit Session A，session B与session C竞争X锁，直接报错:</p>
<p><img src="https://raw.githubusercontent.com/roc-wong/images/master/%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98.png" alt="死锁"></p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>首先这是个添加操作，APP端不应该对同一用户、同一只股票执行多次并发添加操作<br>，APP端需要解决单设备、多并发问题。后台针对同一用户、同一股票的添加操作，需要使用分布式锁控制并发。</p>
]]></content>
    
    <summary type="html">
    
      Deadlock found when trying to get lock; try restarting transaction
    
    </summary>
    
      <category term="Mysql" scheme="https://roc-wong.github.io/categories/Mysql/"/>
    
    
      <category term="Mysql" scheme="https://roc-wong.github.io/tags/Mysql/"/>
    
  </entry>
  
  <entry>
    <title>micro-services</title>
    <link href="https://roc-wong.github.io/blog/2017/07/micro-services.html"/>
    <id>https://roc-wong.github.io/blog/2017/07/micro-services.html</id>
    <published>2017-07-21T12:11:00.000Z</published>
    <updated>2018-11-21T02:18:25.554Z</updated>
    
    <content type="html"><![CDATA[<p>微服务是一种架构风格，一个大型复杂软件应用由一个或多个微服务组成。系统中的各个微服务可被独立部署，各个微服务之间是松耦合的。每个微服务仅关注于完成一件任务并很好地完成该任务。在所有情况下，每个任务代表着一个小的业务能力。</p>
<a id="more"></a>
<p>MicroServices、Docker、SOA、Agile、Cloud、DevOps等等这类名词的最大特点就是： 一解释就懂，一问就不知，一讨论就打架。 </p>
<p><img src="http://ogu4xc937.bkt.clouddn.com/what-do-you-mean.png" alt="你再装逼我弄死你"></p>
<p>微服务是当前互联网业界的一个技术热点，可提到这个词，大家都有共同的疑问：</p>
<ul>
<li>一个微服务架构有哪些技术关注点(technical concerns)？</li>
<li>需要哪些基础框架或组件来支持微服务架构？</li>
<li>这些框架或组件该如何选型？</li>
</ul>
<p>本篇博客整理自</p>
<ul>
<li><a href="http://www.infoq.com/cn/articles/basis-frameworkto-implement-micro-service/" target="_blank" rel="external">实施微服务，我们需要哪些基础框架？</a></li>
<li><a href="https://www.ibm.com/developerworks/community/blogs/3302cc3b-074e-44da-90b1-5055f1dc0d9c/entry/%E8%A7%A3%E6%9E%90%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84_%E4%B8%80_%E4%BB%80%E4%B9%88%E6%98%AF%E5%BE%AE%E6%9C%8D%E5%8A%A1?lang=es" target="_blank" rel="external">解析微服务架构(一)：什么是微服务</a></li>
</ul>
<p>##服务注册、发现、负载均衡和健康检查</p>
<p>和单块(Monolithic)架构不同，微服务架构是由一系列职责单一的细粒度服务构成的分布式网状结构，服务之间通过轻量机制进行通信，这时候必然引入一个服务注册发现问题，也就是说服务提供方要注册通告服务地址，服务的调用方要能发现目标服务，同时服务提供方一般以集群方式提供服务，也就引入了负载均衡和健康检查问题。根据负载均衡LB所在位置的不同，目前主要的服务注册、发现和负载均衡方案有三种：</p>
<p>###第一种是集中式LB方案<br>如下图Fig 1，在服务消费者和服务提供者之间有一个独立的LB，LB通常是专门的硬件设备如F5，或者基于软件如LVS，HAproxy等实现。LB上有所有服务的地址映射表，通常由运维配置注册，当服务消费方调用某个目标服务时，它向LB发起请求，由LB以某种策略（比如Round-Robin）做负载均衡后将请求转发到目标服务。LB一般具备健康检查能力，能自动摘除不健康的服务实例。服务消费方如何发现LB呢？通常的做法是通过DNS，运维人员为服务配置一个DNS域名，这个域名指向LB。</p>
<p><img src="http://cdn4.infoqstatic.com/statics_s2_20170711-0402/resource/articles/basis-frameworkto-implement-micro-service/zh/resources/1125000.png" alt="集中式LB方案"> Fig 1, 集中式LB方案</p>
<p>集中式LB方案实现简单，在LB上也容易做集中式的访问控制，这一方案目前还是业界主流。集中式LB的主要问题是单点问题，所有服务调用流量都经过LB，当服务数量和调用量大的时候，LB容易成为瓶颈，且一旦LB发生故障对整个系统的影响是灾难性的。另外，LB在服务消费方和服务提供方之间增加了一跳(hop)，有一定性能开销。</p>
<p>###第二种是进程内LB方案<br>针对集中式LB的不足，进程内LB方案将LB的功能以库的形式集成到服务消费方进程里头，该方案也被称为软负载(Soft Load Balancing)或者客户端负载方案，下图Fig 2展示了这种方案的工作原理。这一方案需要一个服务注册表(Service Registry)配合支持服务自注册和自发现，服务提供方启动时，首先将服务地址注册到服务注册表（同时定期报心跳到服务注册表以表明服务的存活状态，相当于健康检查），服务消费方要访问某个服务时，它通过内置的LB组件向服务注册表查询（同时缓存并定期刷新）目标服务地址列表，然后以某种负载均衡策略选择一个目标服务地址，最后向目标服务发起请求。这一方案对服务注册表的可用性(Availability)要求很高，一般采用能满足高可用分布式一致的组件（例如Zookeeper, Consul, Etcd等）来实现。</p>
<p><img src="http://cdn4.infoqstatic.com/statics_s2_20170711-0402/resource/articles/basis-frameworkto-implement-micro-service/zh/resources/1125001.png" alt="进程内LB"><br>Fig 2, 进程内LB方案</p>
<p>进程内LB方案是一种分布式方案，LB和服务发现能力被分散到每一个服务消费者的进程内部，同时服务消费方和服务提供方之间是直接调用，没有额外开销，性能比较好。但是，该方案以客户库(Client Library)的方式集成到服务调用方进程里头，如果企业内有多种不同的语言栈，就要配合开发多种不同的客户端，有一定的研发和维护成本。另外，一旦客户端跟随服务调用方发布到生产环境中，后续如果要对客户库进行升级，势必要求服务调用方修改代码并重新发布，所以该方案的升级推广有不小的阻力。</p>
<p>进程内LB的案例是Netflix的开源服务框架，对应的组件分别是：Eureka服务注册表，Karyon服务端框架支持服务自注册和健康检查，Ribbon客户端框架支持服务自发现和软路由。另外，阿里开源的服务框架Dubbo也是采用类似机制。</p>
<p>###第三种是主机独立LB进程方案<br>该方案是针对第二种方案的不足而提出的一种折中方案，原理和第二种方案基本类似，不同之处是，他将LB和服务发现功能从进程内移出来，变成主机上的一个独立进程，主机上的一个或者多个服务要访问目标服务时，他们都通过同一主机上的独立LB进程做服务发现和负载均衡，见下图Fig 3。</p>
<p><img src="http://cdn4.infoqstatic.com/statics_s2_20170711-0402/resource/articles/basis-frameworkto-implement-micro-service/zh/resources/1125002.png" alt="独立LB进程方案"></p>
<p>Fig 3 主机独立LB进程方案</p>
<p>该方案也是一种分布式方案，没有单点问题，一个LB进程挂了只影响该主机上的服务调用方，服务调用方和LB之间是进程间调用，性能好，同时，该方案还简化了服务调用方，不需要为不同语言开发客户库，LB的升级不需要服务调用方改代码。该方案的不足是部署较复杂，环节多，出错调试排查问题不方便。</p>
<p>该方案的典型案例是Airbnb的SmartStack服务发现框架，对应组件分别是：Zookeeper作为服务注册表，Nerve独立进程负责服务注册和健康检查，Synapse/HAproxy独立进程负责服务发现和负载均衡。Google最新推出的基于容器的PaaS平台Kubernetes，其内部服务发现采用类似的机制。</p>
<p>##服务前端路由</p>
<p>微服务除了内部相互之间调用和通信之外，最终要以某种方式暴露出去，才能让外界系统（例如客户的浏览器、移动设备等等）访问到，这就涉及服务的前端路由，对应的组件是服务网关(Service Gateway)，见图Fig 4，网关是连接企业内部和外部系统的一道门，有如下关键作用：</p>
<ol>
<li>服务反向路由，网关要负责将外部请求反向路由到内部具体的微服务，这样虽然企业内部是复杂的分布式微服务结构，但是外部系统从网关上看到的就像是一个统一的完整服务，网关屏蔽了后台服务的复杂性，同时也屏蔽了后台服务的升级和变化。</li>
<li>安全认证和防爬虫，所有外部请求必须经过网关，网关可以集中对访问进行安全控制，比如用户认证和授权，同时还可以分析访问模式实现防爬虫功能，网关是连接企业内外系统的安全之门。</li>
<li>限流和容错，在流量高峰期，网关可以限制流量，保护后台系统不被大流量冲垮，在内部系统出现故障时，网关可以集中做容错，保持外部良好的用户体验。</li>
<li>监控，网关可以集中监控访问量，调用延迟，错误计数和访问模式，为后端的性能优化或者扩容提供数据支持。</li>
<li>日志，网关可以收集所有的访问日志，进入后台系统做进一步分析。</li>
</ol>
<p><img src="http://cdn2.infoqstatic.com/statics_s1_20170711-0402/resource/articles/basis-frameworkto-implement-micro-service/zh/resources/1125003.png" alt="图Fig 4"><br>Fig 4, 服务网关</p>
<p>除以上基本能力外，网关还可以实现线上引流，线上压测，线上调试(Surgical debugging)，金丝雀测试(Canary Testing)，数据中心双活(Active-Active HA)等高级功能。</p>
<p>网关通常工作在7层，有一定的计算逻辑，一般以集群方式部署，前置LB进行负载均衡。</p>
<p>开源的网关组件有Netflix的Zuul，特点是动态可热部署的过滤器(filter)机制，其它如HAproxy，Nginx等都可以扩展作为网关使用。</p>
<p>在介绍过服务注册表和网关等组件之后，我们可以通过一个简化的微服务架构图(Fig 5)来更加直观地展示整个微服务体系内的服务注册发现和路由机制，该图假定采用进程内LB服务发现和负载均衡机制。在下图Fig 5的微服务架构中，服务简化为两层，后端通用服务（也称中间层服务Middle Tier Service）和前端服务（也称边缘服务Edge Service，前端服务的作用是对后端服务做必要的聚合和裁剪后暴露给外部不同的设备，如PC，Pad或者Phone）。后端服务启动时会将地址信息注册到服务注册表，前端服务通过查询服务注册表就可以发现然后调用后端服务；前端服务启动时也会将地址信息注册到服务注册表，这样网关通过查询服务注册表就可以将请求路由到目标前端服务，这样整个微服务体系的服务自注册自发现和软路由就通过服务注册表和网关串联起来了。如果以面向对象设计模式的视角来看，网关类似Proxy代理或者Façade门面模式，而服务注册表和服务自注册自发现类似IoC依赖注入模式，微服务可以理解为基于网关代理和注册表IoC构建的分布式系统。</p>
<p><img src="http://cdn2.infoqstatic.com/statics_s1_20170711-0402/resource/articles/basis-frameworkto-implement-micro-service/zh/resources/1125004.png" alt="Fig 5"><br>Fig 5, 简化的微服务架构图</p>
<p>##服务容错</p>
<p>当企业微服务化以后，服务之间会有错综复杂的依赖关系，例如，一个前端请求一般会依赖于多个后端服务，技术上称为1 -&gt; N扇出(见图Fig 6)。在实际生产环境中，服务往往不是百分百可靠，服务可能会出错或者产生延迟，如果一个应用不能对其依赖的故障进行容错和隔离，那么该应用本身就处在被拖垮的风险中。在一个高流量的网站中，某个单一后端一旦发生延迟，可能在数秒内导致所有应用资源(线程，队列等)被耗尽，造成所谓的雪崩效应(Cascading Failure，见图Fig 7)，严重时可致整个网站瘫痪。</p>
<p>Fig 6, 服务依赖<img src="http://cdn2.infoqstatic.com/statics_s1_20170711-0402/resource/articles/basis-frameworkto-implement-micro-service/zh/resources/1125005.png" alt="图Fig 6"></p>
<p>Fig 7, 高峰期单个服务延迟致雪崩效应 <img src="http://cdn2.infoqstatic.com/statics_s1_20170711-0402/resource/articles/basis-frameworkto-implement-micro-service/zh/resources/1125006.png" alt="图Fig 7"></p>
<p>经过多年的探索和实践，业界在分布式服务容错一块探索出了一套有效的容错模式和最佳实践，主要包括：</p>
<ol>
<li><p>电路熔断器模式(Circuit Breaker Patten), 该模式的原理类似于家里的电路熔断器，如果家里的电路发生短路，熔断器能够主动熔断电路，以避免灾难性损失。在分布式系统中应用电路熔断器模式后，当目标服务慢或者大量超时，调用方能够主动熔断，以防止服务被进一步拖垮；如果情况又好转了，电路又能自动恢复，这就是所谓的弹性容错，系统有自恢复能力。下图Fig 8是一个典型的具备弹性恢复能力的电路保护器状态图，正常状态下，电路处于关闭状态(Closed)，如果调用持续出错或者超时，电路被打开进入熔断状态(Open)，后续一段时间内的所有调用都会被拒绝(Fail Fast)，一段时间以后，保护器会尝试进入半熔断状态(Half-Open)，允许少量请求进来尝试，如果调用仍然失败，则回到熔断状态，如果调用成功，则回到电路闭合状态。<br>Fig 8, 弹性电路保护状态图 <img src="http://cdn2.infoqstatic.com/statics_s1_20170711-0402/resource/articles/basis-frameworkto-implement-micro-service/zh/resources/1125007.png" alt="图Fig 8"></p>
</li>
<li><p>舱壁隔离模式(Bulkhead Isolation Pattern)，顾名思义，该模式像舱壁一样对资源或失败单元进行隔离，如果一个船舱破了进水，只损失一个船舱，其它船舱可以不受影响 。线程隔离(Thread Isolation)就是舱壁隔离模式的一个例子，假定一个应用程序A调用了Svc1/Svc2/Svc3三个服务，且部署A的容器一共有120个工作线程，采用线程隔离机制，可以给对Svc1/Svc2/Svc3的调用各分配40个线程，当Svc2慢了，给Svc2分配的40个线程因慢而阻塞并最终耗尽，线程隔离可以保证给Svc1/Svc3分配的80个线程可以不受影响，如果没有这种隔离机制，当Svc2慢的时候，120个工作线程会很快全部被对Svc2的调用吃光，整个应用程序会全部慢下来。</p>
</li>
<li>限流(Rate Limiting/Load Shedder)，服务总有容量限制，没有限流机制的服务很容易在突发流量(秒杀，双十一)时被冲垮。限流通常指对服务限定并发访问量，比如单位时间只允许100个并发调用，对超过这个限制的请求要拒绝并回退。</li>
<li>回退(fallback)，在熔断或者限流发生的时候，应用程序的后续处理逻辑是什么？回退是系统的弹性恢复能力，常见的处理策略有，直接抛出异常，也称快速失败(Fail Fast)，也可以返回空值或缺省值，还可以返回备份数据，如果主服务熔断了，可以从备份服务获取数据。</li>
</ol>
<p>Netflix将上述容错模式和最佳实践集成到一个称为Hystrix的开源组件中，凡是需要容错的依赖点(服务，缓存，数据库访问等)，开发人员只需要将调用封装在Hystrix Command里头，则相关调用就自动置于Hystrix的弹性容错保护之下。Hystrix组件已经在Netflix经过多年运维验证，是Netflix微服务平台稳定性和弹性的基石，正逐渐被社区接受为标准容错组件。</p>
<p>服务框架</p>
<p>微服务化以后，为了让业务开发人员专注于业务逻辑实现，避免冗余和重复劳动，规范研发提升效率，必然要将一些公共关注点推到框架层面。服务框架(Fig 9)主要封装公共关注点逻辑，包括：</p>
<p><img src="http://cdn2.infoqstatic.com/statics_s1_20170711-0402/resource/articles/basis-frameworkto-implement-micro-service/zh/resources/1125008.png" alt="Fig 9"><br>Fig 9, 服务框架</p>
<ol>
<li>服务注册、发现、负载均衡和健康检查，假定采用进程内LB方案，那么服务自注册一般统一做在服务器端框架中，健康检查逻辑由具体业务服务定制，框架层提供调用健康检查逻辑的机制，服务发现和负载均衡则集成在服务客户端框架中。</li>
<li>监控日志，框架一方面要记录重要的框架层日志、metrics和调用链数据，还要将日志、metrics等接口暴露出来，让业务层能根据需要记录业务日志数据。在运行环境中，所有日志数据一般集中落地到企业后台日志系统，做进一步分析和处理。</li>
<li>REST/RPC和序列化，框架层要支持将业务逻辑以HTTP/REST或者RPC方式暴露出来，HTTP/REST是当前主流API暴露方式，在性能要求高的场合则可采用Binary/RPC方式。针对当前多样化的设备类型(浏览器、普通PC、无线设备等)，框架层要支持可定制的序列化机制，例如，对浏览器，框架支持输出Ajax友好的JSON消息格式，而对无线设备上的Native App，框架支持输出性能高的Binary消息格式。</li>
<li>配置，除了支持普通配置文件方式的配置，框架层还可集成动态运行时配置，能够在运行时针对不同环境动态调整服务的参数和配置。</li>
<li>限流和容错，框架集成限流容错组件，能够在运行时自动限流和容错，保护服务，如果进一步和动态配置相结合，还可以实现动态限流和熔断。</li>
<li>管理接口，框架集成管理接口，一方面可以在线查看框架和服务内部状态，同时还可以动态调整内部状态，对调试、监控和管理能提供快速反馈。Spring Boot微框架的Actuator模块就是一个强大的管理接口。</li>
<li>统一错误处理，对于框架层和服务的内部异常，如果框架层能够统一处理并记录日志，对服务监控和快速问题定位有很大帮助。</li>
<li>安全，安全和访问控制逻辑可以在框架层统一进行封装，可做成插件形式，具体业务服务根据需要加载相关安全插件。</li>
<li>文档自动生成，文档的书写和同步一直是一个痛点，框架层如果能支持文档的自动生成和同步，会给使用API的开发和测试人员带来极大便利。Swagger是一种流行Restful API的文档方案。<br>当前业界比较成熟的微服务框架有Netflix的Karyon/Ribbon，Spring的Spring Boot/Cloud，阿里的Dubbo等。</li>
</ol>
<p>##运行期配置管理</p>
<p>服务一般有很多依赖配置，例如访问数据库有连接字符串配置，连接池大小和连接超时配置，这些配置在不同环境(开发/测试/生产)一般不同，比如生产环境需要配连接池，而开发测试环境可能不配，另外有些参数配置在运行期可能还要动态调整，例如，运行时根据流量状况动态调整限流和熔断阀值。目前比较常见的做法是搭建一个运行时配置中心支持微服务的动态配置，简化架构如下图(Fig 10):<br><img src="http://cdn2.infoqstatic.com/statics_s1_20170711-0402/resource/articles/basis-frameworkto-implement-micro-service/zh/resources/1125009.png" alt="简化架构"><br>Fig 10, 服务配置中心</p>
<p>动态配置存放在集中的配置服务器上，用户通过管理界面配置和调整服务配置，具体服务通过定期拉(Scheduled Pull)的方式或者服务器推(Server-side Push)的方式更新动态配置，拉方式比较可靠，但会有延迟同时有无效网络开销(假设配置不常更新)，服务器推方式能及时更新配置，但是实现较复杂，一般在服务和配置服务器之间要建立长连接。配置中心还要解决配置的版本控制和审计问题，对于大规模服务化环境，配置中心还要考虑分布式和高可用问题。</p>
<p>配置中心比较成熟的开源方案有百度的Disconf，360的QConf，Spring的Cloud Config和阿里的Diamond等。</p>
<p><strong>Netflix的微服务框架</strong><br>Netflix是一家成功实践微服务架构的互联网公司，几年前，Netflix就把它的几乎整个微服务框架栈开源贡献给了社区，这些框架和组件包括：</p>
<ul>
<li>Eureka:　服务注册发现框架</li>
<li>Zuul:　服务网关</li>
<li>Karyon:　服务端框架</li>
<li>Ribbon:　客户端框架</li>
<li>Hystrix: 服务容错组件</li>
<li>Archaius: 服务配置组件</li>
<li>Servo: Metrics组件</li>
<li>Blitz4j: 日志组件</li>
</ul>
<p>下图Fig 11展示了基于这些组件构建的一个微服务框架体系，来自recipes-rss。<br><img src="http://cdn2.infoqstatic.com/statics_s1_20170711-0402/resource/articles/basis-frameworkto-implement-micro-service/zh/resources/1125010.png" alt="基于Netflix开源组件的微服务框架"></p>
<p>Fig 11, 基于Netflix开源组件的微服务框架</p>
<p>Netflix的开源框架组件已经在Netflix的大规模分布式微服务环境中经过多年的生产实战验证，正逐步被社区接受为构造微服务框架的标准组件。Pivotal去年推出的Spring Cloud开源产品，主要是基于对Netflix开源组件的进一步封装，方便Spring开发人员构建微服务基础框架。对于一些打算构建微服务框架体系的公司来说，充分利用或参考借鉴Netflix的开源微服务组件(或Spring Cloud)，在此基础上进行必要的企业定制，无疑是通向微服务架构的捷径。</p>
]]></content>
    
    <summary type="html">
    
      微服务的目的是有效的拆分应用，实现敏捷开发和部署 。
    
    </summary>
    
      <category term="MicroServices" scheme="https://roc-wong.github.io/categories/MicroServices/"/>
    
    
      <category term="微服务" scheme="https://roc-wong.github.io/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>腹肌锻炼</title>
    <link href="https://roc-wong.github.io/blog/2017/06/abs-exercises.html"/>
    <id>https://roc-wong.github.io/blog/2017/06/abs-exercises.html</id>
    <published>2017-06-09T11:54:08.000Z</published>
    <updated>2018-01-11T02:04:04.728Z</updated>
    
    <content type="html"><![CDATA[<p>健身是一个循序渐进的过程，不要想一天就成为你心中的那个偶像，需要持久坚持和努力。腹肌训练更是如此，想要减脂塑形、梦想拥有完美身材的男女，不妨一起来试练下面一组动作，提示各位要按照顺序完成训练量。</p>
<a id="more"></a>
<p>动作一、60个开合跳，连续进行；</p>
<p><img src="http://p3.pstatp.com/large/52e0008ccb2085c2c0b" alt=""></p>
<p>动作二、40个仰卧交替收膝，动作要到位；</p>
<p><img src="http://p3.pstatp.com/large/52e0008ccb0f1ac2a38" alt=""></p>
<p>动作三、10~15个仰卧起坐；</p>
<p><img src="http://p3.pstatp.com/large/52d0008cd209da95902" alt=""></p>
<p>动作四、看到Z没有，20个凳(Z)上反屈伸；</p>
<p><img src="http://p1.pstatp.com/large/52e0008ccb14d565f3c" alt=""></p>
<p>动作五、按照下方示范动作，左右各20个侧步蹲；</p>
<p><img src="http://p1.pstatp.com/large/5b100007798d8ceeb44" alt=""></p>
<p>动作六、同动作三，俯卧撑10~15个；</p>
<p><img src="http://p3.pstatp.com/large/5b100007799ddf0815e" alt=""></p>
<p>动作七、有没有经常见到这个动作呢？仰卧举腿20个；</p>
<p><img src="http://p9.pstatp.com/large/5b10000779a9f79ffda" alt=""></p>
<p>动作八、30个高抬腿走起 ；</p>
<p><img src="http://p3.pstatp.com/large/52d0008cd211e4c9755" alt=""></p>
<p>动作九、深蹲跳 10个就够了；</p>
<p><img src="http://p3.pstatp.com/large/5b10000779b4ab8800a" alt=""></p>
<p>动作十、平板支撑60秒！哦，一分钟 ；</p>
<p><img src="http://p1.pstatp.com/large/52c0008ca6fd187a7c4" alt=""></p>
<p>附带视频一个：<a href="http://www.toutiao.com/i6263916207875817985/" target="_blank" rel="external">click me</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;健身是一个循序渐进的过程，不要想一天就成为你心中的那个偶像，需要持久坚持和努力。腹肌训练更是如此，想要减脂塑形、梦想拥有完美身材的男女，不妨一起来试练下面一组动作，提示各位要按照顺序完成训练量。&lt;/p&gt;
    
    </summary>
    
      <category term="健身" scheme="https://roc-wong.github.io/categories/%E5%81%A5%E8%BA%AB/"/>
    
    
      <category term="健身 腹肌" scheme="https://roc-wong.github.io/tags/%E5%81%A5%E8%BA%AB-%E8%85%B9%E8%82%8C/"/>
    
  </entry>
  
  <entry>
    <title>maven-war-plugin</title>
    <link href="https://roc-wong.github.io/blog/2017/04/maven-war-plugin.html"/>
    <id>https://roc-wong.github.io/blog/2017/04/maven-war-plugin.html</id>
    <published>2017-04-25T14:06:59.000Z</published>
    <updated>2018-11-21T02:18:25.546Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Apache-Maven-WAR-Plugin"><a href="#Apache-Maven-WAR-Plugin" class="headerlink" title="Apache Maven WAR Plugin"></a>Apache Maven WAR Plugin</h2><p>The WAR Plugin is responsible for collecting all artifact dependencies, classes and resources of the web application and packaging them into a web application archive.</p>
<p>“打包“这个词听起来比较土，比较正式的说法应该是”构建项目软件包“，具体说就是将项目中的各种文件，比如源代码、编译生成的字节码、配置文件、文档，按照规范的格式生成归档，最常见的当然就是JAR包和WAR包了，复杂点的例子是Maven官方下载页面的分发包，它有自定义的格式，方便用户直接解压后就在命令行使用。作为一款”打包工具“，Maven自然有义务帮助用户创建各种各样的包，规范的JAR包和WAR包自然不再话下，略微复杂的自定义打包格式也必须支持，本文就介绍一些常用的打包案例以及相关的实现方式，除了前面提到的一些包以外，你还能看到如何生成源码包、Javadoc包、以及从命令行可直接运行的CLI包。</p>
<a id="more"></a>
<p>任何一个Maven项目都需要定义POM元素packaging（如果不写则默认值为jar）。顾名思义，该元素决定了项目的打包方式。实际的情形中，如果你不声明该元素，Maven会帮你生成一个JAR包；如果你定义该元素的值为war，那你会得到一个WAR包；如果定义其值为POM（比如是一个父模块），那什么包都不会生成。除此之外，Maven默认还支持一些其他的流行打包格式，例如ejb3和ear。你不需要了解具体的打包细节，你所需要做的就是告诉Maven，”我是个什么类型的项目“，这就是约定优于配置的力量。</p>
<p>对应于同样的package生命周期阶段，Maven为jar项目调用了maven-jar-plugin，为war项目调用了maven-war-plugin，换言之，packaging直接影响Maven的构建生命周期。了解这一点非常重要，特别是当你需要自定义打包行为的时候，你就必须知道去配置哪个插件。</p>
<h2 id="war-plugin的常用配置参数"><a href="#war-plugin的常用配置参数" class="headerlink" title="war plugin的常用配置参数"></a>war plugin的常用配置参数</h2><h3 id="archiveClasses配置项"><a href="#archiveClasses配置项" class="headerlink" title="archiveClasses配置项"></a>archiveClasses配置项</h3><p>该配置的值为true|false，默认是false。表示是否将class进行打包。<br>正常情况下war类型的工程，java代码编译后的类文件会放到WEB-INF/classes目录下面，散装。 当该参数配置为true时，会将所有的class打包为一个jar，jar的名字与war的名字一致（除了后缀）。然后把这个jar放到WEB-INF/lib目录下，此时WEB-INF/classes目录下是空的。</p>
<h3 id="attachClasses配置项"><a href="#attachClasses配置项" class="headerlink" title="attachClasses配置项"></a>attachClasses配置项</h3><p>该配置的值为true|false，默认是false。表示在发布war包的时候是否同时发布一个jar包（只有classes，不包含页面相关文件）。<br>正常情况下war类型的工程，当我们执行install或者deploy的时候build出一个war包，安装到本地或者发布到远程。<br>当该参数配置为true时，除了war包外还会多出一个jar包，不过该jar包的classifier默认为classes。</p>
<h3 id="overlays配置节点"><a href="#overlays配置节点" class="headerlink" title="overlays配置节点"></a>overlays配置节点</h3><p>overlays配置的作用是，将指定war包中的内容与当前项目进行合并。合并策略：如果存在同名冲突，则使用当前项目中的文件。 overlay的具体配置项（include|exclude）可以指定包含或者排除特定模式的文件。</p>
<h2 id="配置示例"><a href="#配置示例" class="headerlink" title="配置示例"></a>配置示例</h2><h3 id="多war合并"><a href="#多war合并" class="headerlink" title="多war合并"></a>多war合并</h3><p>archiveClasses和attachClasses参数可以同时配置为true。此时打包文件中含有lib，不含classes。发布时会同时发布classifier为classes的jar包。</p>
<p>如果当前工程A需要从B工程的war包中合入页面文件，同时代码中也要使用B的类文件。工程B包含配置如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-war-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">attachClasses</span>&gt;</span>true<span class="tag">&lt;/<span class="name">attachClasses</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>工程A包含配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>groupB<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>B<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">classifier</span>&gt;</span>classes<span class="tag">&lt;/<span class="name">classifier</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>groupB<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>B<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">type</span>&gt;</span>war<span class="tag">&lt;/<span class="name">type</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-war-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                  <span class="tag">&lt;<span class="name">overlays</span>&gt;</span></div><div class="line">                      <span class="tag">&lt;<span class="name">overlay</span>&gt;</span></div><div class="line">                          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>groupB<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>B<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                      <span class="tag">&lt;/<span class="name">overlay</span>&gt;</span></div><div class="line">                  <span class="tag">&lt;/<span class="name">overlays</span>&gt;</span></div><div class="line">              <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div></pre></td></tr></table></figure>
<blockquote>
<p>可注意如果同名的文件夹会进行合并，不合并空文件夹。</p>
</blockquote>
<h3 id="把class文件打包成jar，怎么排除resources目录"><a href="#把class文件打包成jar，怎么排除resources目录" class="headerlink" title="把class文件打包成jar，怎么排除resources目录?"></a>把class文件打包成jar，怎么排除resources目录?</h3><p>正常情况下war类型的工程，java代码编译后的类文件会放到WEB-INF/classes目录下面，散装。 当archiveClasses参数配置为true时，会将所有的class打包为一个jar，jar的名字与war的名字一致。然后把这个jar放到WEB-INF/lib目录下，此时WEB-INF/classes目录下是空的，但如果想在war包的WEB-INF/classes中保留logback.xml配置文件，该怎么做？</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="params">&lt;plugin&gt;</span></div><div class="line">    <span class="params">&lt;artifactId&gt;</span>maven-war-plugin<span class="params">&lt;/artifactId&gt;</span></div><div class="line">    <span class="params">&lt;version&gt;</span><span class="number">3.0</span><span class="number">.0</span><span class="params">&lt;/version&gt;</span></div><div class="line">    <span class="params">&lt;configuration&gt;</span></div><div class="line">        <span class="params">&lt;archiveClasses&gt;</span>true<span class="params">&lt;/archiveClasses&gt;</span></div><div class="line">        <span class="params">&lt;webResources&gt;</span></div><div class="line">            <span class="params">&lt;resource&gt;</span></div><div class="line">                <span class="params">&lt;directory&gt;</span>src<span class="meta-keyword">/main/</span>resources<span class="params">&lt;/directory&gt;</span></div><div class="line">                <span class="params">&lt;targetPath&gt;</span>WEB-INF/classes<span class="params">&lt;/targetPath&gt;</span></div><div class="line">                <span class="params">&lt;filtering&gt;</span>true<span class="params">&lt;/filtering&gt;</span></div><div class="line">            <span class="params">&lt;/resource&gt;</span></div><div class="line">        <span class="params">&lt;/webResources&gt;</span></div><div class="line">    <span class="params">&lt;/configuration&gt;</span></div><div class="line"><span class="params">&lt;/plugin&gt;</span></div></pre></td></tr></table></figure>
<h3 id="对项目进行动态打包，不同的环境使用不同的配置文件打包"><a href="#对项目进行动态打包，不同的环境使用不同的配置文件打包" class="headerlink" title="对项目进行动态打包，不同的环境使用不同的配置文件打包"></a>对项目进行动态打包，不同的环境使用不同的配置文件打包</h3><h4 id="demo-1"><a href="#demo-1" class="headerlink" title="demo 1"></a>demo 1</h4><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">project/</div><div class="line">`-- src</div><div class="line">    |<span class="string">-- main</span></div><div class="line">    |<span class="string">   </span>|<span class="string">-- java</span></div><div class="line">    |<span class="string">   </span>|<span class="string">-- resources</span></div><div class="line">    |<span class="string">   </span>|<span class="string">   </span>|<span class="string">-- local</span></div><div class="line">    |<span class="string">   </span>|<span class="string">   </span>|<span class="string">   </span>|<span class="string">-- logback.xml</span></div><div class="line">    |<span class="string">   </span>|<span class="string">   </span>|<span class="string">   </span>|<span class="string">-- spring-dataSource.xml</span></div><div class="line">    |<span class="string">   </span>|<span class="string">   </span>|<span class="string">   `-- variable.propertes</span></div><div class="line">    |<span class="string">   </span>|<span class="string">   </span>|<span class="string">-- product</span></div><div class="line">    |<span class="string">   </span>|<span class="string">   </span>|<span class="string">   </span>|<span class="string">-- logback.xml</span></div><div class="line">    |<span class="string">   </span>|<span class="string">   </span>|<span class="string">   </span>|<span class="string">-- spring-dataSource.xml</span></div><div class="line">    |<span class="string">   </span>|<span class="string">   </span>|<span class="string">   `-- variable.propertes</span></div><div class="line">    |<span class="string">   </span>|<span class="string">   `-- qa</span></div><div class="line">    |<span class="string">   </span>|<span class="string">       </span>|<span class="string">-- logback.xml</span></div><div class="line">    |<span class="string">   </span>|<span class="string">       </span>|<span class="string">-- spring-dataSource.xml</span></div><div class="line">    |<span class="string">   </span>|<span class="string">       `-- variable.propertes</span></div><div class="line">    |<span class="string">   </span>|<span class="string">-- webapp</span></div><div class="line">    `-- test</div></pre></td></tr></table></figure>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">maven <span class="keyword">package</span> <span class="title">–P local   开发环境</span></div><div class="line">maven <span class="keyword">package</span> <span class="title">–P product  生产环境</span></div></pre></td></tr></table></figure>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span></div><div class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>local<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">package.environment</span>&gt;</span>local<span class="tag">&lt;/<span class="name">package.environment</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">activation</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>product<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">package.environment</span>&gt;</span>product<span class="tag">&lt;/<span class="name">package.environment</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- class文件打包成jar包，排除相关配置文件和jrebel配置文件 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>local/*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>product/*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>rebel.xml<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- 区别dev环境与生产环境logback.xml配置 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-war-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">archiveClasses</span>&gt;</span>true<span class="tag">&lt;/<span class="name">archiveClasses</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">failOnMissingWebXml</span>&gt;</span>false<span class="tag">&lt;/<span class="name">failOnMissingWebXml</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">webResources</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources/$<span class="template-variable">&#123;package.environment&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span></div><div class="line">                        <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">targetPath</span>&gt;</span>WEB-INF/classes<span class="tag">&lt;/<span class="name">targetPath</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">webResources</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>default-jar<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="demo-2"><a href="#demo-2" class="headerlink" title="demo 2"></a>demo 2</h4><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">project/</div><div class="line">`-- src</div><div class="line">    |<span class="string">-- main</span></div><div class="line">    |<span class="string">   </span>|<span class="string">-- java</span></div><div class="line">    |<span class="string">   </span>|<span class="string">-- env</span></div><div class="line">    |<span class="string">   </span>|<span class="string">   </span>|<span class="string">-- dev</span></div><div class="line">    |<span class="string">   </span>|<span class="string">   </span>|<span class="string">   </span>|<span class="string">-- log4j.properties</span></div><div class="line">    |<span class="string">   </span>|<span class="string">   </span>|<span class="string">   </span>|<span class="string">-- spring-dataSource.xml</span></div><div class="line">    |<span class="string">   </span>|<span class="string">   </span>|<span class="string">   `-- variable.propertes</span></div><div class="line">    |<span class="string">   </span>|<span class="string">   </span>|<span class="string">-- prod</span></div><div class="line">    |<span class="string">   </span>|<span class="string">   </span>|<span class="string">   </span>|<span class="string">-- log4j.properties</span></div><div class="line">    |<span class="string">   </span>|<span class="string">   </span>|<span class="string">   </span>|<span class="string">-- spring-dataSource.xml</span></div><div class="line">    |<span class="string">   </span>|<span class="string">   </span>|<span class="string">   `-- variable.propertes</span></div><div class="line">    |<span class="string">   </span>|<span class="string">   `-- qa</span></div><div class="line">    |<span class="string">   </span>|<span class="string">       </span>|<span class="string">-- log4j.properties</span></div><div class="line">    |<span class="string">   </span>|<span class="string">       </span>|<span class="string">-- spring-dataSource.xml</span></div><div class="line">    |<span class="string">   </span>|<span class="string">       `-- variable.propertes</span></div><div class="line">    |<span class="string">   </span>|<span class="string">-- resources</span></div><div class="line">    |<span class="string">   `-- webapp</span></div><div class="line">    `-- test</div></pre></td></tr></table></figure>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mvn clean <span class="keyword">package</span> <span class="title">-P dev</span></div><div class="line">mvn clean <span class="keyword">package</span> <span class="title">-P qa</span></div></pre></td></tr></table></figure>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span></div><div class="line">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>demo Maven Webapp<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>webapp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>webapp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">scm</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">connection</span>&gt;</span>scm:svn:http://127.0.0.1/dummy<span class="tag">&lt;/<span class="name">connection</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">developerConnection</span>&gt;</span>scm:svn:https://127.0.0.1/dummy<span class="tag">&lt;/<span class="name">developerConnection</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">tag</span>&gt;</span>HEAD<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://127.0.0.1/dummy<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">scm</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">spring-version</span>&gt;</span>3.1.0.RELEASE<span class="tag">&lt;/<span class="name">spring-version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>$<span class="template-variable">&#123;final.name&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span></div><div class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-war-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">overlays</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">overlay</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>TransactionResource<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>TransactionResource<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></div><div class="line">                                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>WEB-INF/web.xml<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;/<span class="name">overlay</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">overlays</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">webResources</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$<span class="template-variable">&#123;runtime.env&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span></div><div class="line">                            <span class="tag">&lt;<span class="name">targetPath</span>&gt;</span>WEB-INF/classes<span class="tag">&lt;/<span class="name">targetPath</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">webResources</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        ……</div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">profiles</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">profile</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">activation</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">runtime.env</span>&gt;</span>src/main/env/dev<span class="tag">&lt;/<span class="name">runtime.env</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">final.name</span>&gt;</span>webapp<span class="tag">&lt;/<span class="name">final.name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.eightqiu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>CodeCmns<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">profile</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>qa<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">runtime.env</span>&gt;</span>src/main/env/qa<span class="tag">&lt;/<span class="name">runtime.env</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">final.name</span>&gt;</span>webapp_$<span class="template-variable">&#123;buildNumber&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">final.name</span>&gt;</span></span></div><div class="line">            <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.mojo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>buildnumber-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">execution</span>&gt;</span></div><div class="line">                                <span class="tag">&lt;<span class="name">phase</span>&gt;</span>validate<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></div><div class="line">                                <span class="tag">&lt;<span class="name">goals</span>&gt;</span></div><div class="line">                                    <span class="tag">&lt;<span class="name">goal</span>&gt;</span>create<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></div><div class="line">                                <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">format</span>&gt;</span><span class="template-variable">&#123;0,date,yyyyMMdd&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">format</span>&gt;</span></span></div><div class="line">                            <span class="tag">&lt;<span class="name">items</span>&gt;</span></div><div class="line">                                <span class="tag">&lt;<span class="name">item</span>&gt;</span>timestamp<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;/<span class="name">items</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">reporting</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-javadoc-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">reporting</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.eightqiu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>CodeCmns<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">profile</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>prod<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">runtime.env</span>&gt;</span>src/main/env/prod<span class="tag">&lt;/<span class="name">runtime.env</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">final.name</span>&gt;</span>webapp<span class="tag">&lt;/<span class="name">final.name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.eightqiu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>CodeCmns<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      maven war plugin
    
    </summary>
    
      <category term="Maven" scheme="https://roc-wong.github.io/categories/Maven/"/>
    
    
      <category term="Maven" scheme="https://roc-wong.github.io/tags/Maven/"/>
    
      <category term="maven war plugin" scheme="https://roc-wong.github.io/tags/maven-war-plugin/"/>
    
  </entry>
  
  <entry>
    <title>maven-paranamer-plugin</title>
    <link href="https://roc-wong.github.io/blog/2017/04/maven-paranamer-plugin.html"/>
    <id>https://roc-wong.github.io/blog/2017/04/maven-paranamer-plugin.html</id>
    <published>2017-04-25T13:16:55.000Z</published>
    <updated>2018-11-21T02:18:25.542Z</updated>
    
    <content type="html"><![CDATA[<h2 id="What-is-it"><a href="#What-is-it" class="headerlink" title="What is it?"></a>What is it?</h2><p>It is a library that allows the parameter names of non-private methods and constructors to be accessed at runtime. Normally this information is dropped by the compiler. In effect, methods like doSometing(mypkg.Person toMe) currently look like doSomething(mypackage.Person ???) to people using Java’s reflection to inspect methods.</p>
<p>项目主页：<a href="https://github.com/paul-hammant/paranamer" target="_blank" rel="external">https://github.com/paul-hammant/paranamer</a></p>
<a id="more"></a>
<h2 id="如何在运行时获取java方法参数名称"><a href="#如何在运行时获取java方法参数名称" class="headerlink" title="如何在运行时获取java方法参数名称?"></a>如何在运行时获取java方法参数名称?</h2><ol>
<li>由于jdk的反射方式，未提供获取参数名的方法</li>
<li>Java的字节码文件默认不存储参数名称。在使用javac编译时，如果开启-g:{vars}选项，可以增加Local variable debugging information。对java方法，参数实际是按照局部变量来存储的，所以可以获取参数名称；但对于java接口中的方法声明，这种方法就无法获取参数名称。</li>
</ol>
<p>Paranamer专门用来解决获取参数名的问题。其原理是在编译阶段，修改.class文件，在类或接口的字节码文件中增加一个字符串常量，这个常量保存了所有的方法声明信息，包括方法名、参数类型、参数名称。这样在运行时，class loader加载类文件以后，使用Paranamer的api去读取这个字符串，就可以获取参数名称。加上java反射，实际上可以把源代码重现出来。</p>
<p>这个工具可以用来实现代码生成器。其缺点在于，它需要修改源项目的build步骤。据其项目主页说明，Java 8已经加入存储参数名称的功能。</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// MySomethingOrOther.java**</span></div><div class="line"><span class="function"><span class="keyword">Method</span> <span class="title">method</span> = <span class="title">Foo</span>.<span class="title">class</span>.<span class="title">getMethod</span><span class="params">(...)</span>;</span></div><div class="line"></div><div class="line">Paranamer paranamer = <span class="keyword">new</span> CachingParanamer();</div><div class="line"></div><div class="line">String[] parameterNames = paranamer.lookupParameterNames(<span class="function"><span class="keyword">method</span>) // <span class="title">throws</span> <span class="title">ParameterNamesNotFoundException</span> <span class="title">if</span> <span class="title">not</span> <span class="title">found</span></span></div><div class="line"></div><div class="line">// <span class="title">or</span>:</div><div class="line"></div><div class="line">parameterNames = paranamer.lookupParameterNames(<span class="function"><span class="keyword">method</span>, <span class="title">false</span>) // <span class="title">will</span> <span class="title">return</span> <span class="title">null</span> <span class="title">if</span> <span class="title">not</span> <span class="title">found</span></span></div></pre></td></tr></table></figure>
<h2 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h2><p>需求：通过java的反射获取method，使用paranamer获取method的参数名称。<br>诡异之处：使用Paranamer paranamer = new CachingParanamer()l.ookupParameterNames(method);无法正常获取方法的变量名称。</p>
<p>一个简单的java类，<strong>请注意使用了import .* 的方式</strong></p>
<figure class="highlight julia"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">package hbec.commons.services.stock.controller;</div><div class="line"></div><div class="line"><span class="keyword">import</span> hbec.commons.domain.stock.condition.dto.*;</div><div class="line"><span class="keyword">import</span> hbec.commons.domain.stock.vo.*;</div><div class="line"><span class="keyword">import</span> hbec.exception.portal.HbecPortalStockBizException;</div><div class="line"><span class="keyword">import</span> hbec.platform.commons.annotations.HbecService;</div><div class="line"><span class="keyword">import</span> hbec.platform.commons.exceptions.HbecDbServiceException;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.validation.constraints.NotNull;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"></div><div class="line">/**</div><div class="line"> * <span class="meta">@author</span> roc Jul <span class="number">4</span>, <span class="number">2016</span></div><div class="line"> *</div><div class="line"> */</div><div class="line">public interface IConditionTradeController &#123;</div><div class="line"></div><div class="line">	ConditionSaveResult save(<span class="built_in">Integer</span> userId, <span class="meta">@NotNull</span> ConditionTradeDto conditionTradeDto) ;</div><div class="line"></div><div class="line">	ConditionSaveResult saveTurnPoint(<span class="built_in">Integer</span> userId, <span class="meta">@NotNull</span> ConditionTradeTurnPointDto conditionTradeDto) ;</div><div class="line"></div><div class="line">	ConditionSaveResult saveBatching(<span class="built_in">Integer</span> userId, <span class="meta">@NotNull</span> ConditionTradeBatchingDto conditionTradeDto) ;</div><div class="line"></div><div class="line">	ConditionSaveResult saveGrid(<span class="built_in">Integer</span> userId, <span class="meta">@NotNull</span> GridTradeDto conditionTradeDto) ;</div><div class="line"></div><div class="line">	ConditionSaveResult saveProfit(<span class="built_in">Integer</span> userId, ProfitConditionTradeDto profitConditionTradeDto) ;</div><div class="line"></div><div class="line">	<span class="built_in">Integer</span> delete(<span class="built_in">Integer</span> userId, <span class="meta">@NotNull</span> <span class="built_in">Integer</span> warnId) ;</div><div class="line"></div><div class="line">	<span class="built_in">Integer</span> pause(<span class="built_in">Integer</span> userId, <span class="meta">@NotNull</span> <span class="built_in">Integer</span> warnId) ;</div><div class="line"></div><div class="line">	<span class="built_in">Integer</span> resume(<span class="built_in">Integer</span> userId, <span class="meta">@NotNull</span> <span class="built_in">Integer</span> warnId) ;</div><div class="line"></div><div class="line">	PageVo&lt;ConditionTradeMarketVO&gt; findMonitorPageWithMarket(<span class="built_in">Integer</span> userId, <span class="built_in">String</span> code, ConditionPageVo&lt;ConditionTradeMarketVO&gt; pager) ;</div><div class="line"></div><div class="line">	ConditionTradeDetailVo detail(<span class="meta">@NotNull</span> <span class="built_in">Integer</span> userId, <span class="meta">@NotNull</span> <span class="built_in">Integer</span> warnId) ;</div><div class="line"></div><div class="line">	PageVo&lt;ConditionTradeHistoryVo&gt; queryHistory(<span class="meta">@NotNull</span> <span class="built_in">Integer</span> userId, <span class="built_in">String</span> stockCode, PageVo&lt;ConditionTradeHistoryVo&gt; pager) ;</div><div class="line"></div><div class="line">	ConditionTradeDetailVo detailWithMarket(<span class="built_in">Integer</span> userId, <span class="built_in">Integer</span> warnId) ;</div><div class="line"></div><div class="line">	List&lt;EntrustVO&gt; queryEntrustRecord(<span class="built_in">Integer</span> userId, <span class="built_in">Integer</span> warnId) ;</div><div class="line"></div><div class="line">	List&lt;ConditionInfoVO&gt; queryEntrustResult(<span class="built_in">Integer</span> userId, <span class="built_in">String</span> stockCode, <span class="built_in">String</span> historyIds) ;</div><div class="line"></div><div class="line">	PageCursorVo&lt;ConditionInfoVO&gt; queryEntrustedResult(<span class="built_in">Integer</span> userId, <span class="built_in">String</span> stockCode, <span class="built_in">Integer</span> warnId, <span class="built_in">Integer</span> cursor, <span class="built_in">Integer</span> pageSize) ;</div><div class="line"></div><div class="line">	CountTradeHistoryVo countEntrustedResult(<span class="built_in">Integer</span> userId, <span class="built_in">String</span> stockCode, <span class="built_in">Integer</span> warnId) ;</div><div class="line"></div><div class="line">	int markAsRead(<span class="built_in">Integer</span> userId, <span class="built_in">String</span> stockCode, <span class="built_in">Integer</span> warnId) ;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用paranamer-maven-plugin编译之后如下：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public static final String __PARANAMER_DATA = <span class="string">"countConditionNum java.lang.Integer userId <span class="subst">\n</span>countEntrustedResult java.lang.Integer,java.lang.String,java.lang.Integer userId,stockCode,warnId <span class="subst">\n</span>delete java.lang.Integer,java.lang.Integer userId,warnId <span class="subst">\n</span>detail java.lang.Integer,java.lang.Integer userId,warnId <span class="subst">\n</span>detailWithMarket java.lang.Integer,java.lang.Integer userId,warnId <span class="subst">\n</span>entrustManual java.lang.Integer,java.lang.Integer,EntrustDto userId,warnId,entrustDto <span class="subst">\n</span>findCurrentEntrust java.lang.Integer,java.lang.String,PageVo userId,stockCode,pager <span class="subst">\n</span>findMonitorPageWithMarket java.lang.Integer,java.lang.String,ConditionPageVo userId,code,pager <span class="subst">\n</span>findPage java.lang.Integer,java.lang.String,ConditionPageVo userId,strategyState,pager <span class="subst">\n</span>findTriggeredPage java.lang.Integer,java.lang.Integer,PageVo userId,handled,pager <span class="subst">\n</span>markAsRead java.lang.Integer,java.lang.String,java.lang.Integer userId,stockCode,warnId <span class="subst">\n</span>pause java.lang.Integer,java.lang.Integer userId,warnId <span class="subst">\n</span>queryEntrustRecord java.lang.Integer,java.lang.Integer userId,warnId <span class="subst">\n</span>queryEntrustResult java.lang.Integer,java.lang.String,java.lang.String userId,stockCode,historyIds <span class="subst">\n</span>queryEntrustedResult java.lang.Integer,java.lang.String,java.lang.Integer,java.lang.Integer,java.lang.Integer userId,stockCode,warnId,cursor,pageSize <span class="subst">\n</span>queryHistory java.lang.Integer,java.lang.String,PageVo userId,stockCode,pager <span class="subst">\n</span>resume java.lang.Integer,java.lang.Integer userId,warnId <span class="subst">\n</span>save java.lang.Integer,ConditionTradeDto userId,conditionTradeDto <span class="subst">\n</span>saveBatching java.lang.Integer,ConditionTradeBatchingDto userId,conditionTradeDto <span class="subst">\n</span>saveGrid java.lang.Integer,GridTradeDto userId,conditionTradeDto <span class="subst">\n</span>saveNewShares java.lang.Integer,NewSharesDto userId,newSharesDto <span class="subst">\n</span>saveProfit java.lang.Integer,ProfitConditionTradeDto userId,profitConditionTradeDto <span class="subst">\n</span>saveTurnPoint java.lang.Integer,ConditionTradeTurnPointDto userId,conditionTradeDto <span class="subst">\n</span>saveVipBatching java.lang.Integer,ConditionTradeBatchingDto userId,conditionTradeDto <span class="subst">\n</span>"</span>;</div></pre></td></tr></table></figure>
<p>仔细观察可以发现生成的__PARANAMER_DATA常量中，并未包含对象类型变量的具体package路径，此时使用new CachingParanamer()l.ookupParameterNames(method)无法正常获取方法的变量名称。</p>
<p>去掉import .* 的方式之后，再次编译，常量中包含了对象类型变量具体的package路径，此时可成功获取方法的变量名称。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public static final String __PARANAMER_DATA = <span class="string">"countConditionNum java.lang.Integer userId <span class="subst">\n</span>countEntrustedResult java.lang.Integer,java.lang.String,java.lang.Integer userId,stockCode,warnId <span class="subst">\n</span>delete java.lang.Integer,java.lang.Integer userId,warnId <span class="subst">\n</span>detail java.lang.Integer,java.lang.Integer userId,warnId <span class="subst">\n</span>detailWithMarket java.lang.Integer,java.lang.Integer userId,warnId <span class="subst">\n</span>entrustManual java.lang.Integer,java.lang.Integer,hbec.commons.domain.stock.dto.EntrustDto userId,warnId,entrustDto <span class="subst">\n</span>findCurrentEntrust java.lang.Integer,java.lang.String,hbec.commons.domain.stock.vo.PageVo userId,stockCode,pager <span class="subst">\n</span>findMonitorPageWithMarket java.lang.Integer,java.lang.String,hbec.commons.domain.stock.vo.ConditionPageVo userId,code,pager <span class="subst">\n</span>findPage java.lang.Integer,java.lang.String,hbec.commons.domain.stock.vo.ConditionPageVo userId,strategyState,pager <span class="subst">\n</span>findTriggeredPage java.lang.Integer,java.lang.Integer,hbec.commons.domain.stock.vo.PageVo userId,handled,pager <span class="subst">\n</span>markAsRead java.lang.Integer,java.lang.String,java.lang.Integer userId,stockCode,warnId <span class="subst">\n</span>pause java.lang.Integer,java.lang.Integer userId,warnId <span class="subst">\n</span>queryEntrustRecord java.lang.Integer,java.lang.Integer userId,warnId <span class="subst">\n</span>queryEntrustResult java.lang.Integer,java.lang.String,java.lang.String userId,stockCode,historyIds <span class="subst">\n</span>queryEntrustedResult java.lang.Integer,java.lang.String,java.lang.Integer,java.lang.Integer,java.lang.Integer userId,stockCode,warnId,cursor,pageSize <span class="subst">\n</span>queryHistory java.lang.Integer,java.lang.String,hbec.commons.domain.stock.vo.PageVo userId,stockCode,pager <span class="subst">\n</span>resume java.lang.Integer,java.lang.Integer userId,warnId <span class="subst">\n</span>save java.lang.Integer,hbec.commons.domain.stock.dto.ConditionTradeDto userId,conditionTradeDto <span class="subst">\n</span>saveBatching java.lang.Integer,hbec.commons.domain.stock.dto.ConditionTradeBatchingDto userId,conditionTradeDto <span class="subst">\n</span>saveGrid java.lang.Integer,hbec.commons.domain.stock.dto.GridTradeDto userId,conditionTradeDto <span class="subst">\n</span>saveNewShares java.lang.Integer,hbec.commons.domain.stock.dto.NewSharesDto userId,newSharesDto <span class="subst">\n</span>saveProfit java.lang.Integer,hbec.commons.domain.stock.condition.dto.ProfitConditionTradeDto userId,profitConditionTradeDto <span class="subst">\n</span>saveTurnPoint java.lang.Integer,hbec.commons.domain.stock.dto.ConditionTradeTurnPointDto userId,conditionTradeDto <span class="subst">\n</span>saveVipBatching java.lang.Integer,hbec.commons.domain.stock.dto.ConditionTradeBatchingDto userId,conditionTradeDto <span class="subst">\n</span>"</span>;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      使用maven paranamer plugin获取java方法中的参数名称
    
    </summary>
    
      <category term="Maven" scheme="https://roc-wong.github.io/categories/Maven/"/>
    
    
      <category term="Maven" scheme="https://roc-wong.github.io/tags/Maven/"/>
    
      <category term="maven paranamer plugin" scheme="https://roc-wong.github.io/tags/maven-paranamer-plugin/"/>
    
  </entry>
  
  <entry>
    <title>Shell脚本调试技术</title>
    <link href="https://roc-wong.github.io/blog/2017/03/Shell%E8%84%9A%E6%9C%AC%E8%B0%83%E8%AF%95%E6%8A%80%E6%9C%AF.html"/>
    <id>https://roc-wong.github.io/blog/2017/03/Shell脚本调试技术.html</id>
    <published>2017-03-26T14:13:40.000Z</published>
    <updated>2018-11-21T02:18:25.550Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>shell编程在unix/linux世界中使用得非常广泛，熟练掌握shell编程也是成为一名优秀的unix/linux开发者和系统管理员的必经之路。脚本调试的主要工作就是发现引发脚本错误的原因以及在脚本源代码中定位发生错误的行，常用的手段包括分析输出的错误信息，通过在脚本中加入调试语句，输出调试信息来辅助诊断错误，利用调试工具等。但与其它高级语言相比，shell解释器缺乏相应的调试机制和调试工具的支持，其输出的错误信息又往往很不明确，初学者在调试脚本时，除了知道用echo语句输出一些信息外，别无它法，而仅仅依赖于大量的加入echo语句来诊断错误，确实令人不胜其繁，故常见初学者抱怨shell脚本太难调试了。本文将系统地介绍一些重要的shell脚本调试技术，希望能对shell的初学者有所裨益。</p>
<a id="more"></a>
<p>本篇博客整理自 Shell脚本调试技术</p>
<blockquote>
<ul>
<li><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-shell-debug/" target="_blank" rel="external">Shell脚本调试技术</a></li>
</ul>
</blockquote>
<p>本文的目标读者是unix/linux环境下的开发人员，测试人员和系统管理员，要求读者具有基本的shell编程知识。本文所使用范例在Bash3.1+Redhat Enterprise Server 4.0下测试通过，但所述调试技巧应也同样适用于其它shell。</p>
<h1 id="在shell脚本中输出调试信息"><a href="#在shell脚本中输出调试信息" class="headerlink" title="在shell脚本中输出调试信息"></a>在shell脚本中输出调试信息</h1><p>通过在程序中加入调试语句把一些关键地方或出错的地方的相关信息显示出来是最常见的调试手段。Shell程序员通常使用echo(ksh程序员常使用print)语句输出信息，但仅仅依赖echo语句的输出跟踪信息很麻烦，调试阶段在脚本中加入的大量的echo语句在产品交付时还得再费力一一删除。针对这个问题，本节主要介绍一些如何方便有效的输出调试信息的方法。</p>
<h2 id="使用trap命令"><a href="#使用trap命令" class="headerlink" title="使用trap命令"></a>使用trap命令</h2><p>trap命令用于捕获指定的信号并执行预定义的命令。其基本的语法是:</p>
<figure class="highlight qml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">trap <span class="string">'command'</span> <span class="keyword">signal</span><span class="string"></span></div></pre></td></tr></table></figure>
<p>其中signal是要捕获的信号，command是捕获到指定的信号之后，所要执行的命令。可以用kill –l命令看到系统中全部可用的信号名，捕获信号后所执行的命令可以是任何一条或多条合法的shell语句，也可以是一个函数名。</p>
<p>shell脚本在执行时，会产生三个所谓的“伪信号”，(之所以称之为“伪信号”是因为这三个信号是由shell产生的，而其它的信号是由操作系统产生的)，通过使用trap命令捕获这三个“伪信号”并输出相关信息对调试非常有帮助。</p>
<p>表 1. shell伪信号</p>
<table>
<thead>
<tr>
<th>信号名</th>
<th>何时产生</th>
</tr>
</thead>
<tbody>
<tr>
<td>EXIT</td>
<td>从一个函数中退出或整个脚本执行完毕</td>
</tr>
<tr>
<td>ERR</td>
<td>当一条命令返回非零状态时(代表命令执行不成功)</td>
</tr>
<tr>
<td>DEBUG</td>
<td>脚本中每一条命令执行之前</td>
</tr>
</tbody>
</table>
<p>通过捕获EXIT信号,我们可以在shell脚本中止执行或从函数中退出时，输出某些想要跟踪的变量的值，并由此来判断脚本的执行状态以及出错原因,其使用方法是：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">trap</span> <span class="string">'command'</span> <span class="keyword">EXIT</span>　或　<span class="keyword">trap</span> <span class="string">'command'</span> <span class="number">0</span></div></pre></td></tr></table></figure>
<p>通过捕获ERR信号,我们可以方便的追踪执行不成功的命令或函数，并输出相关的调试信息，以下是一个捕获ERR信号的示例程序，其中的$LINENO是一个shell的内置变量，代表shell脚本的当前行号。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ cat -n exp1.sh</div><div class="line"><span class="function"><span class="title">ERRTRAP</span></span>()</div><div class="line">&#123;</div><div class="line">  <span class="built_in">echo</span> <span class="string">"[LINE:<span class="variable">$1</span>] Error: Command or function exited with status $?"</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="title">foo</span></span>()</div><div class="line">&#123;</div><div class="line"><span class="built_in">return</span> 1;</div><div class="line">&#125;</div><div class="line"><span class="built_in">trap</span> <span class="string">'ERRTRAP $LINENO'</span> ERR</div><div class="line">abc</div><div class="line">foo</div></pre></td></tr></table></figure>
<p>其输出结果如下：</p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ sh exp1.sh</div><div class="line">exp1.sh: <span class="literal">line</span> <span class="number">10</span>: abc: command <span class="keyword">not</span> found</div><div class="line">[<span class="literal">LINE</span>:<span class="number">10</span>] <span class="literal">Error</span>: Command <span class="keyword">or</span> <span class="keyword">function</span> exited <span class="keyword">with</span> status <span class="number">127</span></div><div class="line">[<span class="literal">LINE</span>:<span class="number">11</span>] <span class="literal">Error</span>: Command <span class="keyword">or</span> <span class="keyword">function</span> exited <span class="keyword">with</span> status <span class="number">1</span></div></pre></td></tr></table></figure>
<p>在调试过程中，为了跟踪某些变量的值，我们常常需要在shell脚本的许多地方插入相同的echo语句来打印相关变量的值，这种做法显得烦琐而笨拙。而通过捕获DEBUG信号，我们只需要一条trap语句就可以完成对相关变量的全程跟踪。</p>
<p>以下是一个通过捕获DEBUG信号来跟踪变量的示例程序:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ cat –n exp2.sh</div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="built_in">trap</span> <span class="string">'echo “before execute line:$LINENO, a=$a,b=$b,c=$c”'</span> DEBUG</div><div class="line">a=1</div><div class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$a</span>"</span> <span class="_">-eq</span> 1 ]</div><div class="line"><span class="keyword">then</span></div><div class="line">   b=2</div><div class="line"><span class="keyword">else</span></div><div class="line">   b=1</div><div class="line"><span class="keyword">fi</span></div><div class="line">c=3</div><div class="line"><span class="built_in">echo</span> <span class="string">"end"</span></div></pre></td></tr></table></figure>
<p>其输出结果如下：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ sh exp2.sh</div><div class="line">before<span class="built_in"> execute </span>line:3, a=,b=,c=</div><div class="line">before<span class="built_in"> execute </span>line:4, a=1,b=,c=</div><div class="line">before<span class="built_in"> execute </span>line:6, a=1,b=,c=</div><div class="line">before<span class="built_in"> execute </span>line:10, a=1,b=2,c=</div><div class="line">before<span class="built_in"> execute </span>line:11, a=1,b=2,c=3</div><div class="line">end</div></pre></td></tr></table></figure>
<p>从运行结果中可以清晰的看到每执行一条命令之后，相关变量的值的变化。同时，从运行结果中打印出来的行号来分析，可以看到整个脚本的执行轨迹，能够判断出哪些条件分支执行了，哪些条件分支没有执行。</p>
<h2 id="使用tee命令"><a href="#使用tee命令" class="headerlink" title="使用tee命令"></a>使用tee命令</h2><p>在shell脚本中管道以及输入输出重定向使用得非常多，在管道的作用下，一些命令的执行结果直接成为了下一条命令的输入。如果我们发现由管道连接起来的一批命令的执行结果并非如预期的那样，就需要逐步检查各条命令的执行结果来判断问题出在哪儿，但因为使用了管道，这些中间结果并不会显示在屏幕上，给调试带来了困难，此时我们就可以借助于tee命令了。</p>
<p>tee命令会从标准输入读取数据，将其内容输出到标准输出设备,同时又可将内容保存成文件。例如有如下的脚本片段，其作用是获取本机的ip地址：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ipaddr=`/sbin/ifconfig | grep <span class="string">'inet addr:'</span> | grep -v <span class="string">'127.0.0.1'</span></div><div class="line">| cut <span class="_">-d</span> : <span class="_">-f</span>3 | awk <span class="string">'&#123;print $1&#125;'</span>`</div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="variable">$ipaddr</span></div></pre></td></tr></table></figure>
<p>#注意=号后面的整句是用反引号(数字1键的左边那个键)括起来的。</p>
<p>运行这个脚本，实际输出的却不是本机的ip地址，而是广播地址,这时我们可以借助tee命令，输出某些中间结果，将上述脚本片段修改为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ipaddr=`/sbin/ifconfig | grep <span class="string">'inet addr:'</span> | grep -v <span class="string">'127.0.0.1'</span></div><div class="line">| tee temp.txt | cut <span class="_">-d</span> : <span class="_">-f</span>3 | awk <span class="string">'&#123;print $1&#125;'</span>`</div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="variable">$ipaddr</span></div></pre></td></tr></table></figure>
<p>之后，将这段脚本再执行一遍，然后查看temp.txt文件的内容：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ cat temp.txt</div><div class="line">inet addr:<span class="number">192.168</span><span class="meta">.0</span><span class="meta">.1</span>  Bcast:<span class="number">192.168</span><span class="meta">.0</span><span class="meta">.255</span>  Mask:<span class="number">255.255</span><span class="meta">.255</span><span class="meta">.0</span></div></pre></td></tr></table></figure>
<p>我们可以发现中间结果的第二列(列之间以:号分隔)才包含了IP地址，而在上面的脚本中使用cut命令截取了第三列，故我们只需将脚本中的cut -d : -f3改为cut -d : -f2即可得到正确的结果。</p>
<p>具体到上述的script例子，我们也许并不需要tee命令的帮助，比如我们可以分段执行由管道连接起来的各条命令并查看各命令的输出结果来诊断错误，但在一些复杂的shell脚本中，这些由管道连接起来的命令可能又依赖于脚本中定义的一些其它变量，这时我们想要在提示符下来分段运行各条命令就会非常麻烦了，简单地在管道之间插入一条tee命令来查看中间结果会更方便一些。</p>
<h2 id="使用”调试钩子”"><a href="#使用”调试钩子”" class="headerlink" title="使用”调试钩子”"></a>使用”调试钩子”</h2><p>在C语言程序中，我们经常使用DEBUG宏来控制是否要输出调试信息，在shell脚本中我们同样可以使用这样的机制，如下列代码所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> [ “<span class="variable">$DEBUG</span>” = “<span class="literal">true</span>” ]; <span class="keyword">then</span></div><div class="line"><span class="built_in">echo</span> “debugging”  <span class="comment">#此处可以输出调试信息</span></div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure>
<p>这样的代码块通常称之为“调试钩子”或“调试块”。在调试钩子内部可以输出任何您想输出的调试信息，使用调试钩子的好处是它是可以通过DEBUG变量来控制的，在脚本的开发调试阶段，可以先执行export DEBUG=true命令打开调试钩子，使其输出调试信息，而在把脚本交付使用时，也无需再费事把脚本中的调试语句一一删除。</p>
<p>如果在每一处需要输出调试信息的地方均使用if语句来判断DEBUG变量的值，还是显得比较繁琐，通过定义一个DEBUG函数可以使植入调试钩子的过程更简洁方便，如下面代码所示:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">$ cat –n exp3.sh</div><div class="line">       <span class="function"><span class="title">DEBUG</span></span>()</div><div class="line">       &#123;</div><div class="line">       <span class="keyword">if</span> [ <span class="string">"<span class="variable">$DEBUG</span>"</span> = <span class="string">"true"</span> ]; <span class="keyword">then</span></div><div class="line">           <span class="variable">$@</span>　　</div><div class="line">       <span class="keyword">fi</span></div><div class="line">       &#125;</div><div class="line">       a=1</div><div class="line">       DEBUG <span class="built_in">echo</span> <span class="string">"a=<span class="variable">$a</span>"</span></div><div class="line">       <span class="keyword">if</span> [ <span class="string">"<span class="variable">$a</span>"</span> <span class="_">-eq</span> 1 ]</div><div class="line">      <span class="keyword">then</span></div><div class="line">           b=2</div><div class="line">      <span class="keyword">else</span></div><div class="line">           b=1</div><div class="line">      <span class="keyword">fi</span></div><div class="line">      DEBUG <span class="built_in">echo</span> <span class="string">"b=<span class="variable">$b</span>"</span></div><div class="line">      c=3</div><div class="line">      DEBUG <span class="built_in">echo</span> <span class="string">"c=<span class="variable">$c</span>"</span></div></pre></td></tr></table></figure>
<p>在上面所示的DEBUG函数中，会执行任何传给它的命令，并且这个执行过程是可以通过DEBUG变量的值来控制的，我们可以把所有跟调试有关的命令都作为DEBUG函数的参数来调用，非常的方便。<br>回页首</p>
<h2 id="使用shell的执行选项"><a href="#使用shell的执行选项" class="headerlink" title="使用shell的执行选项"></a>使用shell的执行选项</h2><p>上一节所述的调试手段是通过修改shell脚本的源代码，令其输出相关的调试信息来定位错误的，那有没有不修改源代码来调试shell脚本的方法呢？答案就是使用shell的执行选项，本节将介绍一些常用选项的用法：</p>
<ul>
<li>-n 只读取shell脚本，但不实际执行</li>
<li>-x 进入跟踪方式，显示所执行的每一条命令</li>
<li>-c “string” 从strings中读取命令</li>
</ul>
<p>“-n”可用于测试shell脚本是否存在语法错误，但不会实际执行命令。在shell脚本编写完成之后，实际执行之前，首先使用“-n”选项来测试脚本是否存在语法错误是一个很好的习惯。因为某些shell脚本在执行时会对系统环境产生影响，比如生成或移动文件等，如果在实际执行才发现语法错误，您不得不手工做一些系统环境的恢复工作才能继续测试这个脚本。</p>
<p>“-c”选项使shell解释器从一个字符串中而不是从一个文件中读取并执行shell命令。当需要临时测试一小段脚本的执行结果时，可以使用这个选项，如下所示：<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">sh</span> -c <span class="string">'a=1;b=2;let c=<span class="variable">$a</span>+<span class="variable">$b</span>;echo "c=<span class="variable">$c</span>"'</span></div></pre></td></tr></table></figure></p>
<p>“-x”选项可用来跟踪脚本的执行，是调试shell脚本的强有力工具。“-x”选项使shell在执行脚本的过程中把它实际执行的每一个命令行显示出来，并且在行首显示一个”+”号。 “+”号后面显示的是经过了变量替换之后的命令行的内容，有助于分析实际执行的是什么命令。 “-x”选项使用起来简单方便，可以轻松对付大多数的shell调试任务,应把其当作首选的调试手段。</p>
<p>如果把本文前面所述的trap ‘command’ DEBUG机制与“-x”选项结合起来，我们 就可以既输出实际执行的每一条命令，又逐行跟踪相关变量的值，对调试相当有帮助。</p>
<p>仍以前面所述的exp2.sh为例，现在加上“-x”选项来执行它：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">$ sh –x exp2.sh</div><div class="line">+ trap 'echo <span class="string">"before execute line:$LINENO, a=$a,b=$b,c=$c"</span>' DEBUG</div><div class="line">++ echo 'before<span class="built_in"> execute </span>line:3, a=,b=,c='</div><div class="line">before<span class="built_in"> execute </span>line:3, a=,b=,c=</div><div class="line">+ a=1</div><div class="line">++ echo 'before<span class="built_in"> execute </span>line:4, a=1,b=,c='</div><div class="line">before<span class="built_in"> execute </span>line:4, a=1,b=,c=</div><div class="line">+ '[' 1 -eq 1 ']'</div><div class="line">++ echo 'before<span class="built_in"> execute </span>line:6, a=1,b=,c='</div><div class="line">before<span class="built_in"> execute </span>line:6, a=1,b=,c=</div><div class="line">+ b=2</div><div class="line">++ echo 'before<span class="built_in"> execute </span>line:10, a=1,b=2,c='</div><div class="line">before<span class="built_in"> execute </span>line:10, a=1,b=2,c=</div><div class="line">+ c=3</div><div class="line">++ echo 'before<span class="built_in"> execute </span>line:11, a=1,b=2,c=3'</div><div class="line">before<span class="built_in"> execute </span>line:11, a=1,b=2,c=3</div><div class="line">+ echo end</div><div class="line">end</div></pre></td></tr></table></figure>
<p>在上面的结果中，前面有“+”号的行是shell脚本实际执行的命令，前面有“++”号的行是执行trap机制中指定的命令，其它的行则是输出信息。</p>
<p>shell的执行选项除了可以在启动shell时指定外，亦可在脚本中用set命令来指定。 “set -参数”表示启用某选项，”set +参数”表示关闭某选项。有时候我们并不需要在启动时用”-x”选项来跟踪所有的命令行，这时我们可以在脚本中使用set命令，如以下脚本片段所示：</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">set</span> -x　　　 #启动<span class="string">"-x"</span>选项</div><div class="line">要跟踪的程序段</div><div class="line"><span class="keyword">set</span> <span class="comment">+x</span>　　　　<span class="comment"> #</span>关闭<span class="comment">"-x"</span>选项</div></pre></td></tr></table></figure>
<p>set命令同样可以使用上一节中介绍的调试钩子—DEBUG函数来调用，这样可以避免脚本交付使用时删除这些调试语句的麻烦，如以下脚本片段所示：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">DEBUG <span class="keyword">set</span> -x　　　 <span class="comment">#启动"-x"选项</span></div><div class="line">要跟踪的程序段</div><div class="line">DEBUG <span class="keyword">set</span> +x　　　 <span class="comment">#关闭"-x"选项</span></div><div class="line">回页首</div></pre></td></tr></table></figure>
<h2 id="对”-x”选项的增强"><a href="#对”-x”选项的增强" class="headerlink" title="对”-x”选项的增强"></a>对”-x”选项的增强</h2><p>“-x”执行选项是目前最常用的跟踪和调试shell脚本的手段，但其输出的调试信息仅限于进行变量替换之后的每一条实际执行的命令以及行首的一个”+”号提示符，居然连行号这样的重要信息都没有，对于复杂的shell脚本的调试来说，还是非常的不方便。幸运的是，我们可以巧妙地利用shell内置的一些环境变量来增强”-x”选项的输出信息，下面先介绍几个shell内置的环境变量：</p>
<h3 id="LINENO"><a href="#LINENO" class="headerlink" title="$LINENO"></a>$LINENO</h3><p>代表shell脚本的当前行号，类似于C语言中的内置宏<strong>LINE</strong></p>
<h3 id="FUNCNAME"><a href="#FUNCNAME" class="headerlink" title="$FUNCNAME"></a>$FUNCNAME</h3><p>函数的名字，类似于C语言中的内置宏<strong>func</strong>,但宏<strong>func</strong>只能代表当前所在的函数名，而$FUNCNAME的功能更强大，它是一个数组变量，其中包含了整个调用链上所有的函数的名字，故变量${FUNCNAME[0]}代表shell脚本当前正在执行的函数的名字，而变量${FUNCNAME[1]}则代表调用函数${FUNCNAME[0]}的函数的名字，余者可以依此类推。</p>
<h3 id="PS4"><a href="#PS4" class="headerlink" title="$PS4"></a>$PS4</h3><p>主提示符变量$PS1和第二级提示符变量$PS2比较常见，但很少有人注意到第四级提示符变量$PS4的作用。我们知道使用“-x”执行选项将会显示shell脚本中每一条实际执行过的命令，而$PS4的值将被显示在“-x”选项输出的每一条命令的前面。在Bash Shell中，缺省的$PS4的值是”+”号。(现在知道为什么使用”-x”选项时，输出的命令前面有一个”+”号了吧？)。</p>
<p>利用$PS4这一特性，通过使用一些内置变量来重定义$PS4的值，我们就可以增强”-x”选项的输出信息。例如先执行export PS4=’+{$LINENO:${FUNCNAME[0]}} ‘, 然后再使用“-x”选项来执行脚本，就能在每一条实际执行的命令前面显示其行号以及所属的函数名。</p>
<p>以下是一个存在bug的shell脚本的示例，本文将用此脚本来示范如何用“-n”以及增强的“-x”执行选项来调试shell脚本。这个脚本中定义了一个函数isRoot(),用于判断当前用户是不是root用户，如果不是，则中止脚本的执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">$ cat –n exp4.sh</div><div class="line"> <span class="comment">#!/bin/bash</span></div><div class="line"> <span class="function"><span class="title">isRoot</span></span>()</div><div class="line"> &#123;</div><div class="line">         <span class="keyword">if</span> [ <span class="string">"<span class="variable">$UID</span>"</span> <span class="_">-ne</span> 0 ]</div><div class="line">                 <span class="built_in">return</span> 1</div><div class="line">         <span class="keyword">else</span></div><div class="line">                 <span class="built_in">return</span> 0</div><div class="line">         <span class="keyword">fi</span></div><div class="line">&#125;</div><div class="line">isRoot</div><div class="line"><span class="keyword">if</span> [<span class="string">"$?"</span> <span class="_">-ne</span> 0 ]</div><div class="line"><span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"Must be root to run this script"</span></div><div class="line">        <span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">else</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"welcome root user"</span></div><div class="line">        <span class="comment">#do something</span></div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure>
<p>首先执行sh –n exp4.sh来进行语法检查，输出如下：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ <span class="keyword">sh</span> –<span class="keyword">n</span> exp4.<span class="keyword">sh</span></div><div class="line">exp4.<span class="keyword">sh</span>: <span class="keyword">line</span> 6: <span class="keyword">syntax</span> <span class="keyword">error</span> near unexpected <span class="keyword">token</span> <span class="symbol">`else'</span></div><div class="line">exp4.<span class="keyword">sh</span>: <span class="keyword">line</span> 6: `      <span class="keyword">else</span>'</div></pre></td></tr></table></figure>
<p>发现了一个语法错误，通过仔细检查第6行前后的命令，我们发现是第4行的if语句缺少then关键字引起的(写惯了C程序的人很容易犯这个错误)。我们可以把第4行修改为if [ “$UID” -ne 0 ]; then来修正这个错误。再次运行sh –n exp4.sh来进行语法检查，没有再报告错误。接下来就可以实际执行这个脚本了，执行结果如下：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ <span class="keyword">sh</span> exp4.<span class="keyword">sh</span></div><div class="line">exp2.<span class="keyword">sh</span>: <span class="built_in">line</span> <span class="number">11</span>: [<span class="number">1</span>: <span class="keyword">command</span> not found</div><div class="line">welcome root user</div></pre></td></tr></table></figure>
<p>尽管脚本没有语法错误了，在执行时却又报告了错误。错误信息还非常奇怪“[1: command not found”。现在我们可以试试定制$PS4的值，并使用“-x”选项来跟踪：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$ export PS4=<span class="string">'+&#123;$LINENO:$&#123;FUNCNAME[0]&#125;&#125; '</span></div><div class="line">$ <span class="keyword">sh</span> –<span class="keyword">x</span> exp4.<span class="keyword">sh</span></div><div class="line">+&#123;<span class="number">10</span>:&#125; isRoot</div><div class="line">+&#123;<span class="number">4</span>:isRoot&#125; <span class="string">'['</span> <span class="number">503</span> -ne <span class="number">0</span> <span class="string">']'</span></div><div class="line">+&#123;<span class="number">5</span>:isRoot&#125; <span class="keyword">return</span> <span class="number">1</span></div><div class="line">+&#123;<span class="number">11</span>:&#125; <span class="string">'[1'</span> -ne <span class="number">0</span> <span class="string">']'</span></div><div class="line">exp4.<span class="keyword">sh</span>: <span class="built_in">line</span> <span class="number">11</span>: [<span class="number">1</span>: <span class="keyword">command</span> not found</div><div class="line">+&#123;<span class="number">16</span>:&#125; <span class="keyword">echo</span> <span class="string">'welcome root user'</span></div><div class="line">welcome root user</div></pre></td></tr></table></figure>
<p>从输出结果中，我们可以看到脚本实际被执行的语句，该语句的行号以及所属的函数名也被打印出来，从中可以清楚的分析出脚本的执行轨迹以及所调用的函数的内部执行情况。由于执行时是第11行报错，这是一个if语句，我们对比分析一下同为if语句的第4行的跟踪结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">+&#123;4:isRoot&#125; <span class="string">'['</span> 503 <span class="_">-ne</span> 0 <span class="string">']'</span></div><div class="line">+&#123;11:&#125; <span class="string">'[1'</span> <span class="_">-ne</span> 0 <span class="string">']'</span></div></pre></td></tr></table></figure>
<p>可知由于第11行的[号后面缺少了一个空格，导致[号与紧挨它的变量$?的值1被shell解释器看作了一个整体，并试着把这个整体视为一个命令来执行，故有“[1: command not found”这样的错误提示。只需在[号后面插入一个空格就一切正常了。</p>
<p>shell中还有其它一些对调试有帮助的内置变量，比如在Bash Shell中还有BASH_SOURCE, BASH_SUBSHELL等一批对调试有帮助的内置变量，您可以通过man sh或man bash来查看，然后根据您的调试目的,使用这些内置变量来定制$PS4，从而达到增强“-x”选项的输出信息的目的。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>现在让我们来总结一下调试shell脚本的过程：</p>
<p>首先使用“-n”选项检查语法错误，然后使用“-x”选项跟踪脚本的执行，使用“-x”选项之前，别忘了先定制PS4变量的值来增强“-x”选项的输出信息，至少应该令其输出行号信息(先执行export PS4=’+[$LINENO]’，更一劳永逸的办法是将这条语句加到您用户主目录的.bash_profile文件中去)，这将使你的调试之旅更轻松。也可以利用trap,调试钩子等手段输出关键调试信息，快速缩小排查错误的范围，并在脚本中使用“set -x”及“set +x”对某些代码块进行重点跟踪。这样多种手段齐下，相信您已经可以比较轻松地抓出您的shell脚本中的臭虫了。如果您的脚本足够复杂，还需要更强的调试能力，可以使用shell调试器bashdb，这是一个类似于GDB的调试工具，可以完成对shell脚本的断点设置，单步执行，变量观察等许多功能，使用bashdb对阅读和理解复杂的shell脚本也会大有裨益。关于bashdb的安装和使用，不属于本文范围，您可参阅<a href="http://bashdb.sourceforge.net/上的文档并下载试用。" target="_blank" rel="external">http://bashdb.sourceforge.net/上的文档并下载试用。</a></p>
]]></content>
    
    <summary type="html">
    
      Shell脚本调试技术
    
    </summary>
    
      <category term="Linux" scheme="https://roc-wong.github.io/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://roc-wong.github.io/tags/Linux/"/>
    
      <category term="Shell" scheme="https://roc-wong.github.io/tags/Shell/"/>
    
  </entry>
  
  <entry>
    <title>shell 函数返回字符串的方法</title>
    <link href="https://roc-wong.github.io/blog/2017/03/shell-%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%96%B9%E6%B3%95.html"/>
    <id>https://roc-wong.github.io/blog/2017/03/shell-函数返回字符串的方法.html</id>
    <published>2017-03-26T13:53:37.000Z</published>
    <updated>2018-11-21T02:17:03.290Z</updated>
    
    <content type="html"><![CDATA[<p>shell的函数只能返回整数值，如果想让函数返回字符串，一般有两种方法：将返回值赋值给一个字符串变量、输出返回值，在函数调用处为变量赋值。</p>
<a id="more"></a>
<h2 id="Shell函数"><a href="#Shell函数" class="headerlink" title="Shell函数"></a>Shell函数</h2><p>Shell 函数的定义格式如下：</p>
<figure class="highlight ceylon"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">function</span><span class="number">_n</span>ame () &#123;</div><div class="line">    list <span class="keyword">of</span> commands</div><div class="line">    [ <span class="keyword">return</span> <span class="keyword">value</span> ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你愿意，也可以在函数名前加上关键字 function：<br><figure class="highlight qml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">function_name</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">list</span> <span class="keyword">of</span> commands</div><div class="line">    [ <span class="keyword">return</span> value ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>函数返回值，可以显式增加return语句；如果不加，会将最后一条命令运行结果作为返回值。</p>
<p>Shell 函数返回值只能是整数，一般用来表示函数执行成功与否，0表示成功，其他值表示失败。如果 return 其他数据，比如一个字符串，往往会得到错误提示：“numeric argument required”。</p>
<p>如果一定要让函数返回字符串，那么可以先定义一个变量，用来接收函数的计算结果，脚本在需要的时候访问这个变量来获得函数返回值。</p>
<h2 id="将返回值赋值给一个字符串变量"><a href="#将返回值赋值给一个字符串变量" class="headerlink" title="将返回值赋值给一个字符串变量"></a>将返回值赋值给一个字符串变量</h2><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">get_project_version()&#123;</div><div class="line">  VERSION=`grep version $<span class="number">1</span>/pom.xml | head -n <span class="number">1</span> | sed -E <span class="string">'s:&lt;/?version&gt;::g'</span> | sed -E <span class="string">'s/^\t*//'</span> | sed -E <span class="string">'s/^ *//'</span> | sed -E <span class="string">'s/\r$//'</span>`</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="输出返回值，在函数调用处为变量赋值"><a href="#输出返回值，在函数调用处为变量赋值" class="headerlink" title="输出返回值，在函数调用处为变量赋值"></a>输出返回值，在函数调用处为变量赋值</h2><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">get_project_version()&#123;</div><div class="line">  echo `grep version $<span class="number">1</span>/pom.xml | head -n <span class="number">1</span> | sed -E <span class="string">'s:&lt;/?version&gt;::g'</span> | sed -E <span class="string">'s/^\t*//'</span> | sed -E <span class="string">'s/^ *//'</span> | sed -E <span class="string">'s/\r$//'</span>`</div><div class="line">&#125;</div><div class="line"></div><div class="line">version=`get_project_version $PROJECT_PATH`</div></pre></td></tr></table></figure>
<h2 id="特殊变量列表"><a href="#特殊变量列表" class="headerlink" title="特殊变量列表"></a>特殊变量列表</h2><table>
<thead>
<tr>
<th>变量</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>$0</td>
<td>是脚本本身的名字；</td>
</tr>
<tr>
<td>$#</td>
<td>是传给脚本的参数个数；</td>
</tr>
<tr>
<td>$@</td>
<td>是传给脚本的所有参数的列表，即被扩展为”$1” “$2” “$3”等；</td>
</tr>
<tr>
<td>$*</td>
<td>是以一个单字符串显示所有向脚本传递的参数，与位置变量不同，参数可超过9个，即被扩展成”$1c$2c$3”，其中c是IFS的第一个字符；</td>
</tr>
<tr>
<td>$$</td>
<td>是脚本运行的当前进程ID号；</td>
</tr>
<tr>
<td>$?</td>
<td>是显示最后命令的退出状态，0表示没有错误，其他表示有错误；</td>
</tr>
<tr>
<td>$n</td>
<td>获取参数的值，$1表示第一个参数，当n&gt;=10时，需要使用${n}来获取参数。</td>
</tr>
</tbody>
</table>
<p>如果你希望直接从终端调用函数，可以将函数定义在主目录下的 .profile 文件，这样每次登录后，在命令提示符后面输入函数名字就可以立即调用。</p>
]]></content>
    
    <summary type="html">
    
      shell函数返回字符串
    
    </summary>
    
      <category term="Linux" scheme="https://roc-wong.github.io/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://roc-wong.github.io/tags/Linux/"/>
    
      <category term="Shell" scheme="https://roc-wong.github.io/tags/Shell/"/>
    
  </entry>
  
  <entry>
    <title>shell 文件包含</title>
    <link href="https://roc-wong.github.io/blog/2017/03/shell-%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB.html"/>
    <id>https://roc-wong.github.io/blog/2017/03/shell-文件包含.html</id>
    <published>2017-03-26T13:46:15.000Z</published>
    <updated>2018-11-21T02:17:08.825Z</updated>
    
    <content type="html"><![CDATA[<p>像其他语言一样，Shell 也可以包含外部脚本，将外部脚本的内容合并到当前脚本。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>.   . ./subscript.<span class="keyword">sh</span> (常用)     </div><div class="line"><span class="number">2</span>.   <span class="keyword">source</span> ./subscript.<span class="keyword">sh</span></div></pre></td></tr></table></figure>
<a id="more"></a>
<p>两种方式的效果相同，简单起见，一般使用点号(.)，但是注意点号(.)和文件名中间有一空格。两个脚本不在同一目录时，要用绝对路径。</p>
<p>PS:被包含脚本不需要有执行权限，调用脚本必须有可执行权限。</p>
]]></content>
    
    <summary type="html">
    
      Shell脚本中引用、调用另一个脚本文件的方式
    
    </summary>
    
      <category term="Linux" scheme="https://roc-wong.github.io/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://roc-wong.github.io/tags/Linux/"/>
    
      <category term="Shell" scheme="https://roc-wong.github.io/tags/Shell/"/>
    
  </entry>
  
  <entry>
    <title>shell 获取正在执行脚本的绝对路径</title>
    <link href="https://roc-wong.github.io/blog/2017/03/shell-%E8%8E%B7%E5%8F%96%E6%AD%A3%E5%9C%A8%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC%E7%9A%84%E7%BB%9D%E5%AF%B9%E8%B7%AF%E5%BE%84.html"/>
    <id>https://roc-wong.github.io/blog/2017/03/shell-获取正在执行脚本的绝对路径.html</id>
    <published>2017-03-26T13:25:23.000Z</published>
    <updated>2018-11-21T02:18:25.538Z</updated>
    
    <content type="html"><![CDATA[<p>今天在写脚本的时候，想获取下当前执行脚本的绝对路径，试了试pwd，发现并不是正确的路径。找资料后发现 pwd 命令的作用是“print name of current/working directory-当前的工作目录”。 试了试$0，发现也不对，$0是Bash环境下的特殊变量，其真实含义是：</p>
<a id="more"></a>
<p>　　Expands to the name of the shell or shell script. This is set at shell initialization.  If bash is invoked with a file of commands, $0 is set to the name of that file. If bash is started with the -c option, then $0 is set to the first argument after the string to be executed, if one is present. Otherwise, it is set to the file name used to invoke bash, as given by argument zero.</p>
<p>$0的结果与调用方式有关：</p>
<ul>
<li>使用一个文件调用bash，那$0的值，是那个文件的名字(不能确定绝对路径)</li>
<li>使用-c选项启动bash的话，真正执行的命令会从一个字符串中读取，字符串后面如果还有别的参数的话，使用从$0开始的特殊变量引用(跟路径无关)</li>
<li>除此以外，$0会被设置成调用bash的那个文件的名字(不能确定是绝对路径)</li>
</ul>
<p>正确的姿势：</p>
<p>basepath=$(cd <code>dirname $0</code>; pwd)</p>
<ul>
<li>dirname $0，取得当前执行的脚本文件的父目录</li>
<li>cd <code>dirname $0</code>，进入这个目录(切换当前工作目录)</li>
<li>pwd，显示当前工作目录(cd执行后的)</li>
</ul>
]]></content>
    
    <summary type="html">
    
      shell 获取正在执行脚本的绝对路径
    
    </summary>
    
      <category term="Linux" scheme="https://roc-wong.github.io/categories/Linux/"/>
    
    
      <category term="Linux" scheme="https://roc-wong.github.io/tags/Linux/"/>
    
      <category term="Shell" scheme="https://roc-wong.github.io/tags/Shell/"/>
    
  </entry>
  
  <entry>
    <title>svn status</title>
    <link href="https://roc-wong.github.io/blog/2017/03/svn-status.html"/>
    <id>https://roc-wong.github.io/blog/2017/03/svn-status.html</id>
    <published>2017-03-26T13:07:54.000Z</published>
    <updated>2018-11-21T02:18:25.522Z</updated>
    
    <content type="html"><![CDATA[<h2 id="名称"><a href="#名称" class="headerlink" title="名称"></a>名称</h2><p>svn status (stat, st) — 打印工作副本文件和目录的状态。</p>
<h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>svn status [PATH…]</p>
<h2 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h2><p>Print the status of working copy files and directories. With no arguments, it prints only locally modified items (no repository access). With –show-updates (-u), it adds working revision and server out-of-date information. With –verbose (-v), it prints full revision information on every item. With –quiet (-q), it prints only summary information about locally modified items.</p>
<a id="more"></a>
<p>The first seven columns in the output are each one character wide, and each column gives you information about a different aspect of each working copy item.</p>
<p>第一列指出一个项目的是添加, 删除还是其它的修改：</p>
<p>‘ ‘<br>没有修改。</p>
<p>‘A’<br>预定要添加的项目。</p>
<p>‘D’<br>预定要删除的项目。</p>
<p>‘M’<br>项目已经修改了。</p>
<p>‘R’<br>Item has been replaced in your working copy. This means the file was scheduled for deletion, and then a new file with the same name was scheduled for addition in its place.</p>
<p>‘C’<br>项目的内容(相对于属性)与更新得到的数据冲突了。</p>
<p>‘X’<br>项目与外部定义相关。</p>
<p>‘I’<br>项目被忽略(例如使用svn:ignore属性)。</p>
<p>‘?’<br>项目不在版本控制之下。</p>
<p>‘!’<br>Item is missing (e.g., you moved or deleted it without using svn). This also indicates that a directory is incomplete (a checkout or update was interrupted).</p>
<p>‘~’<br>Item is versioned as one kind of object (file, directory, link), but has been replaced by a different kind of object.</p>
<p>The second column tells the status of a file’s or directory’s properties:</p>
<p>‘ ‘<br>没有修改。</p>
<p>‘M’<br>这个项目的属性已经修改。</p>
<p>‘C’<br>这个项目的属性与从版本库得到的更新有冲突。</p>
<p>The third column is populated only if the working copy directory is locked (see 第 6 节 “有时你只需要清理”):</p>
<p>‘ ‘<br>项目没有锁定。</p>
<p>‘L’<br>项目已经锁定。</p>
<p>The fourth column is populated only if the item is scheduled for addition-with-history:</p>
<p>‘ ‘<br>没有历史预定要提交。</p>
<p>‘+’<br>历史预定要伴随提交。</p>
<p>The fifth column is populated only if the item is switched relative to its parent (see 第 5 节 “使用分支”):</p>
<p>‘ ‘<br>项目是它的父目录的孩子。</p>
<p>‘S’<br>项目已经转换。</p>
<p>The sixth column is populated with lock information:</p>
<p>‘ ‘<br>When –show-updates (-u) is used, the file is not locked. If –show-updates (-u) is not used, this merely means that the file is not locked in this working copy.</p>
<p>K<br>文件锁定在工作副本。</p>
<p>O<br>File is locked either by another user or in another working copy. This appears only when –show-updates (-u) is used.</p>
<p>T<br>File was locked in this working copy, but the lock has been “stolen” and is invalid. The file is currently locked in the repository. This appears only when –show-updates (-u) is used.</p>
<p>B<br>File was locked in this working copy, but the lock has been “broken” and is invalid. The file is no longer locked. This appears only when –show-updates (-u) is used.</p>
<p>The seventh column is populated only if the item is the victim of a tree conflict:</p>
<p>‘ ‘<br>项目不是树冲突的受害者。</p>
<p>‘C’<br>项目是树冲突的受害者</p>
<p>第八列始终为空。</p>
<p>The out-of-date information appears in the ninth column (only if you pass the –show-updates (-u) option):</p>
<p>‘ ‘<br>这个项目在工作副本是最新的。</p>
<p>‘*‘<br>在服务器这个项目有了新的修订版本。</p>
<p>The remaining fields are variable width and delimited by spaces. The working revision is the next field if the –show-updates (-u) or –verbose (-v) option is passed.</p>
<p>If the –verbose (-v) option is passed, the last committed revision and last committed author are displayed next.</p>
<p>工作副本路径永远是最后一个字段，所以它可以包括空格。</p>
<p>选项</p>
<p>–changelist ARG<br>–depth ARG<br>–ignore-externals<br>–incremental<br>–no-ignore<br>–quiet (-q)<br>–show-updates (-u)<br>–verbose (-v)<br>–xml<br>例子</p>
<p>这是查看你在工作副本所做的修改的最简单的方法。</p>
<p>$ svn status wc<br> M      wc/bar.c<br>A  +    wc/qax.c<br>If you want to find out what files in your working copy are out of date, pass the –show-updates (-u) option (this will not make any changes to your working copy). Here you can see that wc/foo.c has changed in the repository since we last updated our working copy:</p>
<p>$ svn status -u wc<br> M            965    wc/bar.c</p>
<pre><code>*     965    wc/foo.c
</code></pre><p>A  +          965    wc/qax.c<br>Status against revision:    981<br>[注意]    注意<br>–show-updates (-u) only places an asterisk next to items that are out of date (i.e., items that will be updated from the repository if you later use svn update). –show-updates (-u) does not cause the status listing to reflect the repository’s version of the item (although you can see the revision number in the repository by passing the –verbose (-v) option).</p>
<p>The most information you can get out of the status subcommand is as follows:</p>
<p>$ svn status -u -v wc<br> M            965       938 sally        wc/bar.c</p>
<pre><code>*     965       922 harry        wc/foo.c
</code></pre><p>A  +          965       687 harry        wc/qax.c<br>              965       687 harry        wc/zig.c<br>Status against revision:   981<br>Lastly, you can get svn status output in XML format with the –xml option:</p>
<p>$ svn status –xml wc<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">status</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">target</span></span></div><div class="line">   <span class="attr">path</span>=<span class="string">"wc"</span>&gt;</div><div class="line"><span class="tag">&lt;<span class="name">entry</span></span></div><div class="line">   <span class="attr">path</span>=<span class="string">"qax.c"</span>&gt;</div><div class="line"><span class="tag">&lt;<span class="name">wc-status</span></span></div><div class="line">   <span class="attr">props</span>=<span class="string">"none"</span></div><div class="line">   <span class="attr">item</span>=<span class="string">"added"</span></div><div class="line">   <span class="attr">revision</span>=<span class="string">"0"</span>&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">wc-status</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">entry</span></span></div><div class="line">   <span class="attr">path</span>=<span class="string">"bar.c"</span>&gt;</div><div class="line"><span class="tag">&lt;<span class="name">wc-status</span></span></div><div class="line">   <span class="attr">props</span>=<span class="string">"normal"</span></div><div class="line">   <span class="attr">item</span>=<span class="string">"modified"</span></div><div class="line">   <span class="attr">revision</span>=<span class="string">"965"</span>&gt;</div><div class="line"><span class="tag">&lt;<span class="name">commit</span></span></div><div class="line">   <span class="attr">revision</span>=<span class="string">"965"</span>&gt;</div><div class="line"><span class="tag">&lt;<span class="name">author</span>&gt;</span>sally<span class="tag">&lt;/<span class="name">author</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">date</span>&gt;</span>2008-05-28T06:35:53.048870Z<span class="tag">&lt;/<span class="name">date</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">commit</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">wc-status</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">target</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">status</span>&gt;</span></div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      svn status 详解
    
    </summary>
    
      <category term="SVN" scheme="https://roc-wong.github.io/categories/SVN/"/>
    
    
      <category term="SVN" scheme="https://roc-wong.github.io/tags/SVN/"/>
    
  </entry>
  
  <entry>
    <title>股票估值</title>
    <link href="https://roc-wong.github.io/blog/2017/03/%E8%82%A1%E7%A5%A8%E4%BC%B0%E5%80%BC.html"/>
    <id>https://roc-wong.github.io/blog/2017/03/股票估值.html</id>
    <published>2017-03-15T15:13:19.000Z</published>
    <updated>2018-11-21T02:16:58.624Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>格雷厄姆认为：“稳健投资者的基本原理是不会随着年代的更替而改变的，但是这些原理的应用，则必须随着金融机制和金融环境所发生的重大变化而作出相应的调整。”</p>
<p>实际上巴菲特的“以合理的价格买优秀的公司”也正是格老与时俱进思想的体现。</p>
</blockquote>
<p>股票估值是一个相对复杂的过程，影响的因素很多，没有全球统一的标准。影响股票估值的主要因素依次是每股收益、行业市盈率、流通股本、每股净资产、每股净资产增长率等指标。</p>
<p>股票估值分为绝对估值、相对估值和联合估值。</p>
<a id="more"></a>
<h2 id="绝对估值"><a href="#绝对估值" class="headerlink" title="绝对估值"></a>绝对估值</h2><p>绝对估值(absolute valuation)是通过对上市公司历史及当前的基本面的分析和对未来反映公司经营状况的财务数据的预测获得上市公司股票的内在价值。</p>
<h3 id="绝对估值的方法"><a href="#绝对估值的方法" class="headerlink" title="绝对估值的方法"></a>绝对估值的方法</h3><p>一是现金流贴现定价模型，二是B-S期权定价模型(主要应用于期权定价、权证定价等)。现金流贴现定价模型目前使用最多的是DDM和DCF，而DCF估值模型中，最广泛应用的就是FCFE股权自由现金流模型。</p>
<h3 id="绝对估值的作用"><a href="#绝对估值的作用" class="headerlink" title="绝对估值的作用"></a>绝对估值的作用</h3><p>股票的价格总是围绕着股票的内在价值上下波动，发现价格被低估的股票，在股票的价格远远低于内在价值的时候买入股票，而在股票的价格回归到内在价值甚至高于内在价值的时候卖出以获利。<br>对上市公司进行研究，经常听到估值这个词，说的其实是如何来判断一家公司的价值同时与它的当前股价进行对比，得出股价是否偏离价值的判断，进而指导投资。</p>
<p>DCF是一套很严谨的估值方法，是一种绝对定价方法，想得出准确的DCF值，需要对公司未来发展情况有清晰的了解。得出DCF 值的过程就是判断公司未来发展的过程。所以DCF 估值的过程也很重要。就准确判断企业的未来发展来说，判断成熟稳定的公司相对容易一些，处于扩张期的企业未来发展的不确定性较大，准确判断较为困难。再加上DCF 值本身对参数的变动很敏感，使DCF 值的可变性很大。但在得出DCF 值的过程中，会反映研究员对企业未来发展的判断，并在此基础上假设。有了DCF 的估值过程和结果，以后如果假设有变动，即可通过修改参数得到新的估值。</p>
<h2 id="相对估值"><a href="#相对估值" class="headerlink" title="相对估值"></a>相对估值</h2><p>相对估值是使用市盈率、市净率、市售率、市现率等价格指标与其它多只股票（对比系）进行对比，如果低于对比系的相应的指标值的平均值，股票价格被低估，股价将很有希望上涨，使得指标回归对比系的平均值。<br>相对估值包括PE、PB、PEG、EV/EBITDA等估值法。通常的做法是对比，一个是和该公司历史数据进行对比，二是和国内同行业企业的数据进行对比，确定它的位置，三是和国际上的(特别是香港和美国)同行业重点企业数据进行对比。<br><strong>市盈率PE（股价/每股收益）</strong>：</p>
<p>PE是简洁有效的估值方法，其核心在于e 的确定。PE=p/e，即价格与每股收益的比值。从直观上看，如果公司未来若干年每股收益为恒定值，那么PE 值代表了公司保持恒定盈利水平的存在年限。这有点像实业投资中回收期的概念，只是忽略了资金的时间价值。而实际上保持恒定的e 几乎是不可能的，e 的变动往往取决于宏观经济和企业的生存周期所决定的波动周期。所以在运用PE 值的时候，e 的确定显得尤为重要，由此也衍生出具有不同含义的PE 值。E 有两个方面，一个是历史的e，另一个是预测的e。对于历史的e 来说，可以用不同e 的时点值，可以用移动平均值，也可以用动态年度值，这取决于想要表达的内容。对于预测的e 来说，预测的准确性尤为重要，在实际市场中，e 的变动趋势对股票投资往往具有决定性的影响。<br>市净率PB（股价/每股净资）和净资产收益率ROE,PB &amp;ROE适合于周期的极值判断。对于股票投资来说，准确预测e 是非常重要的，e 的变动趋势往往决定了股价是上行还是下行。但股价上升或下降到多少是合理的呢？ PB&amp;ROE 可以给出一个判断极值的方法。比如，对于一个有良好历史ROE 的公司，在业务前景尚可的情况下，PB 值低于1就有可能是被低估的。如果公司的盈利前景较稳定，没有表现出明显的增长性特征，公司的PB 值显著高于行业（公司历史）的最高PB 值，股价触顶的可能性就比较大。这里提到的周期有三个概念：市场的波动周期、股价的变动周期和周期性行业的变动周期。</p>
<h2 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h2><h3 id="PE"><a href="#PE" class="headerlink" title="PE"></a>PE</h3><p>PE是指市盈率，也称为“利润收益率”，是某种股票普通股每股市价与每股盈利的比率，即：PE(市盈率)=每股市价/每股收益。市盈率把股价和利润联系起来，反映了企业的近期表现。如果股价上升，利润没有变化，甚至下降，则市盈率将会上升。</p>
<h2 id="PB"><a href="#PB" class="headerlink" title="PB"></a>PB</h2><p>平均市净率=股价/账面价值。其中，账面价值=总资产-无形资产-负债-优先股权益。可以看出，所谓账面价值是公司解散清算的价值。如果公司要清算，那么先要还债，无形资产则将不复存在，而优先股的优先权之一就是清算的时候先分钱，但是本股市没有优先股。这样，用每股净资产来代替账面价值，则PB就是大家理解的市净率，即：PB(市净率)=股价/每股净资产。</p>
<h2 id="ROE"><a href="#ROE" class="headerlink" title="ROE"></a>ROE</h2><p>ROE即净资产收益率，又称股东权益报酬率。作为判断上市公司盈利能力的一项重要指标，一直受到证券市场参与各方的极大关注。分析师将ROE解释为将公司盈余再投资以产生更多收益的能力。它也是衡量公司内部财务、行销及经营绩效的指标。ROE的计算方法是：净资产收益率＝报告期净利润／报告期末净资产。</p>
<h2 id="DCF"><a href="#DCF" class="headerlink" title="DCF"></a>DCF</h2><p>绝对估值法DCF：DCF是一套很严谨的估值方法，是一种绝对定价方法，想得出准确的DCF值，需要对公司未来发展情况有清晰的了解。得出DCF值的过程就是判断公司未来发展的过程，所以DCF估值的过程也很重要。就准确判断企业的未来发展来说，判断成熟稳定的公司相对容易一些，处于扩张期的企业未来发展的不确定性较大，准确判断较为困难。再加上DCF值本身对参数的变动很敏感，使DCF值的可变性很大。但在得出DCF值的过程中，会反映研究员对企业未来发展的判断，并在此基础上假设。有了DCF的估值过程和结果，以后如果假设有变动，即可通过修改参数得到新的估值。</p>
]]></content>
    
    <summary type="html">
    
      股票估值分为绝对估值、相对估值和联合估值。影响股票估值的主要因素依次是每股收益、行业市盈率、流通股本、每股净资产、每股净资产增长率等指标。
    
    </summary>
    
      <category term="证券" scheme="https://roc-wong.github.io/categories/%E8%AF%81%E5%88%B8/"/>
    
    
      <category term="证券" scheme="https://roc-wong.github.io/tags/%E8%AF%81%E5%88%B8/"/>
    
  </entry>
  
  <entry>
    <title>人生最浪费生命的事情</title>
    <link href="https://roc-wong.github.io/blog/2017/03/%E4%BA%BA%E7%94%9F%E6%9C%80%E6%B5%AA%E8%B4%B9%E7%94%9F%E5%91%BD%E7%9A%84%E4%BA%8B%E6%83%85.html"/>
    <id>https://roc-wong.github.io/blog/2017/03/人生最浪费生命的事情.html</id>
    <published>2017-03-14T16:03:51.000Z</published>
    <updated>2017-03-14T16:14:09.000Z</updated>
    
    <content type="html"><![CDATA[<p>人这一生，浪费了太多的时间在毫无意义的事情上，担忧、抱怨、埋怨、比较……</p>
<a id="more"></a>
<h2 id="担忧"><a href="#担忧" class="headerlink" title="担忧"></a>担忧</h2><p>庸人自扰是为难自己，让自己每天神经紧绷、忧心忡忡，只会使自己身心俱疲。生活里总会有变数，总会有风雨，任谁都无法提前预知一切。所以，让自己焦虑烦扰，不如让自己释怀轻松地过每一天，顺其自然、淡定坦然地面对一切，不要让担忧禁锢你的身体、束缚你的内心。</p>
<h2 id="抱怨"><a href="#抱怨" class="headerlink" title="抱怨"></a>抱怨</h2><p>充满抱怨的人生会与快乐渐行渐远。对环境不满、对别人不满、对命运不满、对现实不满，最后对自己的选择和决定不满……抱怨会削弱你奋斗的力量，会阻碍你前行的脚步，会让你陷入负面情绪无法自拔。试着让自己勇敢坦然地面对一切风雨，接受自己做出的每一个决定，即使这个过程充满艰辛，也不要轻言放弃，更不要裹足不前、自怨自艾。</p>
<h2 id="埋怨"><a href="#埋怨" class="headerlink" title="埋怨"></a>埋怨</h2><p>遇事，先责备别人；不顺，先埋怨条件，这是一种消极被动的人生态度，是一种缺乏担当的表现。埋怨根本于事无补，只会让你看不清自己的问题、意识不到自己的错误。聪明的人会懂得先反省自己，从自己的身上找答案。只有用这种积极的态度去面对生活中遇到的问题，才能够让你汲取教训、增长经验，让你在今后的生活中越走越顺利。</p>
<h2 id="比较"><a href="#比较" class="headerlink" title="比较"></a>比较</h2><p>　　生活中，自己觉得快乐不快乐、满足不满足、幸福不幸福，才是正理。不要陷入跟别人不断的比较之中，不要因为别人扰乱了自己的步伐。每个人都有自己的机遇和福分，也会遭遇自己的坎坷和波折，不要拿别人的成就荣耀与自己比，不要盲目追随、模仿别人的生活方式而忘记了自己的初衷和追求。多倾听自己的内心，多思考自己的需要，走自己的路，过自己的人生。</p>
<h2 id="这是你吗？"><a href="#这是你吗？" class="headerlink" title="这是你吗？"></a>这是你吗？</h2><h3 id="花费了太多的时间在你不该做的事情上。"><a href="#花费了太多的时间在你不该做的事情上。" class="headerlink" title="花费了太多的时间在你不该做的事情上。"></a>花费了太多的时间在你不该做的事情上。</h3><h3 id="总是在抱怨。"><a href="#总是在抱怨。" class="headerlink" title="总是在抱怨。"></a>总是在抱怨。</h3><h3 id="没有充实你的思想。"><a href="#没有充实你的思想。" class="headerlink" title="没有充实你的思想。"></a>没有充实你的思想。</h3><h3 id="满脑子都是消极想法。"><a href="#满脑子都是消极想法。" class="headerlink" title="满脑子都是消极想法。"></a>满脑子都是消极想法。</h3><h3 id="觉得没有激情。"><a href="#觉得没有激情。" class="headerlink" title="觉得没有激情。"></a>觉得没有激情。</h3><h3 id="对未来没有计划。"><a href="#对未来没有计划。" class="headerlink" title="对未来没有计划。"></a>对未来没有计划。</h3><h3 id="花了太多时间和对你成长没有任何贡献的人在一起。"><a href="#花了太多时间和对你成长没有任何贡献的人在一起。" class="headerlink" title="花了太多时间和对你成长没有任何贡献的人在一起。"></a>花了太多时间和对你成长没有任何贡献的人在一起。</h3><h3 id="沉迷于手机。"><a href="#沉迷于手机。" class="headerlink" title="沉迷于手机。"></a>沉迷于手机。</h3><h3 id="把钱花在了毫无意义的事上。"><a href="#把钱花在了毫无意义的事上。" class="headerlink" title="把钱花在了毫无意义的事上。"></a>把钱花在了毫无意义的事上。</h3><h3 id="睡眠不足。"><a href="#睡眠不足。" class="headerlink" title="睡眠不足。"></a>睡眠不足。</h3><h3 id="没有照顾好自己的身体。"><a href="#没有照顾好自己的身体。" class="headerlink" title="没有照顾好自己的身体。"></a>没有照顾好自己的身体。</h3><h3 id="不愿意离开舒适区。"><a href="#不愿意离开舒适区。" class="headerlink" title="不愿意离开舒适区。"></a>不愿意离开舒适区。</h3><blockquote>
<p>把时间和感受留给自己、留给内心。</p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;人这一生，浪费了太多的时间在毫无意义的事情上，担忧、抱怨、埋怨、比较……&lt;/p&gt;
    
    </summary>
    
      <category term="随笔" scheme="https://roc-wong.github.io/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
      <category term="人生感悟" scheme="https://roc-wong.github.io/tags/%E4%BA%BA%E7%94%9F%E6%84%9F%E6%82%9F/"/>
    
  </entry>
  
  <entry>
    <title>国债逆回购</title>
    <link href="https://roc-wong.github.io/blog/2017/03/%E5%9B%BD%E5%80%BA%E9%80%86%E5%9B%9E%E8%B4%AD.html"/>
    <id>https://roc-wong.github.io/blog/2017/03/国债逆回购.html</id>
    <published>2017-03-14T15:41:13.000Z</published>
    <updated>2018-11-21T02:16:42.278Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>Thinking will not overcome fear but action will.<br>空想终日惶恐，行动方可无惧。</p>
</blockquote>
<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>国债逆回购，就是将资金通过国债回购市场拆出，其实就是一种短期贷款，即你把钱借给别人，获得固定利息;而别人用国债作抵押，到期还本付息。<br>国债逆回购业务是能为投资者提高闲置资金增值能力的金融品种，它具有安全性高、流通性强、收益理想等特点，等同于国债。</p>
<a id="more"></a>
<h2 id="债券回购交易的实质是？"><a href="#债券回购交易的实质是？" class="headerlink" title="债券回购交易的实质是？"></a>债券回购交易的实质是？</h2><p>逆回购就是客户放弃一定时间内的资金使用权，在约定时间内按成交时确定的利率获取利息收入的一种投资品种。</p>
<hr>
<p>债券回购是指交易双方进行的以债券为权利质押的一种短期资金融通业务。资金融入方（正回购方）在将债券质押给资金融出方（逆回购方）以融入资金的同时，双方约定在将来某一日期由正回购方按约定回购利率计算的金额向逆回购方买回相等数量的同品种债券的交易行为。债券回购的最长期限为1年，利率由双方协商确定。</p>
<hr>
<p>这当中卖方的目的在于获得高于银行存款利息收入，而买方的目的在于获得资金的使用权。一笔回购交易涉及二次交易契约行为，即开始时的初始交易及回购期满时的回购交易。买卖双方的具体操作程序如下：债券回购交易申报中，融资方（债券持有者）按“买入”予以申报，融券方（资金持有者）按“卖出”予以申报。到期反向成交时，无须再行申报，由交易所电脑系统自动产生一条反向成交记录，登记结算机构据此进行资金和债券的清算与交割。</p>
<hr>
<p>国债逆回购本质上就是一个机构借钱给另一个机构（银行，保险等）。原本国家规定是机构间的拆借，不允许个人参与，不知道什么时候开始个人也可以参加了。什么时候机构需要临时借钱？目前来看一般是每季度末1－2天，银行需要借钱美化信贷指标；大蓝筹发行前一日。</p>
<h2 id="是否有风险？"><a href="#是否有风险？" class="headerlink" title="是否有风险？"></a>是否有风险？</h2><p>与股票交易不同，债券回购在成交之后不再承担价格波动的风险，收益率的高低在成交时确定。因此基本无价格波动风险。</p>
<h2 id="适合哪些人买？"><a href="#适合哪些人买？" class="headerlink" title="适合哪些人买？"></a>适合哪些人买？</h2><ol>
<li>有理财需求的人</li>
<li>钱放银行拿死利息的人</li>
<li>炒股的人</li>
<li>做生意的流动资金</li>
<li>家中的闲置资金</li>
</ol>
<h2 id="申报规则"><a href="#申报规则" class="headerlink" title="申报规则"></a>申报规则</h2><p>上海回购交易的申报数量必须为100手（10万资金）的整数倍，单笔数量不超过1万手（1000万资金）；回购价格为每百元资金到期的年收益率，最小变动单位为0.005元。</p>
<p>深圳回购交易的申报数量必须为1手的整数倍（1000元），回购价格为每百元资金到期的年收益率，最小变动单位为0.001元。</p>
<h2 id="回购买入的最佳时间是？"><a href="#回购买入的最佳时间是？" class="headerlink" title="回购买入的最佳时间是？"></a>回购买入的最佳时间是？</h2><ol>
<li>一般2点半之后临近收盘下单量往往会大增，从而导致价格走低。</li>
<li>一般星期四、月末、季度末、年末，市场资金面紧张价格通常很高。</li>
<li>重要节假日前两天，1日回购品种价格通常较高。</li>
<li>周五3日品种一般比1日品种总收益高。</li>
<li>如果其间有节假日，长期品种一般比短期品种总收益高。</li>
<li>单日内一般9：30-10：00、14：00-14：30收益率最高。</li>
</ol>
<blockquote>
<p>从以往的规律和盘面表现看，每日下午2时30分之前利率较高; 每周四相比平日利率要高;节假日前利率尤其高。</p>
</blockquote>
<h2 id="投资品种"><a href="#投资品种" class="headerlink" title="投资品种"></a>投资品种</h2><p>投资者要进行回购只能做沪市2040**、深1318***的新国债回购，共18个品种。</p>
<blockquote>
<p>上交所回购品种</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:center">品种</th>
<th style="text-align:right">代码</th>
<th style="text-align:center">简称</th>
<th style="text-align:center">到账时间</th>
<th style="text-align:center">可用时间</th>
<th style="text-align:center">手续费比例</th>
<th style="text-align:center">每10万元交易手续费(元)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1天国债回购</td>
<td style="text-align:right">204001</td>
<td style="text-align:center">GC001</td>
<td style="text-align:center">T + 1</td>
<td style="text-align:center">T + 2</td>
<td style="text-align:center">成交金额的0.001%</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">2天国债回购</td>
<td style="text-align:right">204002</td>
<td style="text-align:center">GC002</td>
<td style="text-align:center">T + 2</td>
<td style="text-align:center">T + 3</td>
<td style="text-align:center">成交金额的0.002%</td>
<td style="text-align:center">2</td>
</tr>
<tr>
<td style="text-align:center">3天国债回购</td>
<td style="text-align:right">204003</td>
<td style="text-align:center">GC003</td>
<td style="text-align:center">T + 3</td>
<td style="text-align:center">T + 4</td>
<td style="text-align:center">成交金额的0.003%</td>
<td style="text-align:center">3</td>
</tr>
<tr>
<td style="text-align:center">4天国债回购</td>
<td style="text-align:right">204004</td>
<td style="text-align:center">GC004</td>
<td style="text-align:center">T + 4</td>
<td style="text-align:center">T + 5</td>
<td style="text-align:center">成交金额的0.004%</td>
<td style="text-align:center">4</td>
</tr>
<tr>
<td style="text-align:center">7天国债回购</td>
<td style="text-align:right">204007</td>
<td style="text-align:center">GC007</td>
<td style="text-align:center">T + 7</td>
<td style="text-align:center">T + 8</td>
<td style="text-align:center">成交金额的0.005%</td>
<td style="text-align:center">5</td>
</tr>
<tr>
<td style="text-align:center">14天国债回购</td>
<td style="text-align:right">204014</td>
<td style="text-align:center">GC014</td>
<td style="text-align:center">T + 14</td>
<td style="text-align:center">T + 15</td>
<td style="text-align:center">成交金额的0.010%</td>
<td style="text-align:center">10</td>
</tr>
<tr>
<td style="text-align:center">28天国债回购</td>
<td style="text-align:right">204028</td>
<td style="text-align:center">GC028</td>
<td style="text-align:center">T + 28</td>
<td style="text-align:center">T + 29</td>
<td style="text-align:center">成交金额的0.020%</td>
<td style="text-align:center">20</td>
</tr>
<tr>
<td style="text-align:center">91天国债回购</td>
<td style="text-align:right">204091</td>
<td style="text-align:center">GC091</td>
<td style="text-align:center">T + 91</td>
<td style="text-align:center">T + 92</td>
<td style="text-align:center">成交金额的0.030%</td>
<td style="text-align:center">30</td>
</tr>
<tr>
<td style="text-align:center">182天国债回购</td>
<td style="text-align:right">204182</td>
<td style="text-align:center">GC182</td>
<td style="text-align:center">T + 182</td>
<td style="text-align:center">T + 183</td>
<td style="text-align:center">成交金额的0.030%</td>
<td style="text-align:center">30</td>
</tr>
</tbody>
</table>
<blockquote>
<p>深交所回购品种</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:center">品种</th>
<th style="text-align:right">代码</th>
<th style="text-align:center">简称</th>
<th style="text-align:center">到账时间</th>
<th style="text-align:center">可用时间</th>
<th style="text-align:center">手续费比例</th>
<th style="text-align:center">每10万元交易手续费(元)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1天国债回购</td>
<td style="text-align:right">131810</td>
<td style="text-align:center">R-00l</td>
<td style="text-align:center">T + 1</td>
<td style="text-align:center">T + 2</td>
<td style="text-align:center">成交金额的0.001%</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">2天国债回购</td>
<td style="text-align:right">1318ll</td>
<td style="text-align:center">R-002</td>
<td style="text-align:center">T + 2</td>
<td style="text-align:center">T + 3</td>
<td style="text-align:center">成交金额的0.002%</td>
<td style="text-align:center">2</td>
</tr>
<tr>
<td style="text-align:center">3天国债回购</td>
<td style="text-align:right">131800</td>
<td style="text-align:center">R-003</td>
<td style="text-align:center">T + 3</td>
<td style="text-align:center">T + 4</td>
<td style="text-align:center">成交金额的0.003%</td>
<td style="text-align:center">3</td>
</tr>
<tr>
<td style="text-align:center">4天国债回购</td>
<td style="text-align:right">131809</td>
<td style="text-align:center">R-004</td>
<td style="text-align:center">T + 4</td>
<td style="text-align:center">T + 5</td>
<td style="text-align:center">成交金额的0.004%</td>
<td style="text-align:center">4</td>
</tr>
<tr>
<td style="text-align:center">7天国债回购</td>
<td style="text-align:right">131801</td>
<td style="text-align:center">R-007</td>
<td style="text-align:center">T + 7</td>
<td style="text-align:center">T + 8</td>
<td style="text-align:center">成交金额的0.005%</td>
<td style="text-align:center">5</td>
</tr>
<tr>
<td style="text-align:center">14天国债回购</td>
<td style="text-align:right">131802</td>
<td style="text-align:center">R-014</td>
<td style="text-align:center">T + 14</td>
<td style="text-align:center">T + 15</td>
<td style="text-align:center">成交金额的0.010%</td>
<td style="text-align:center">10</td>
</tr>
<tr>
<td style="text-align:center">28天国债回购</td>
<td style="text-align:right">131803</td>
<td style="text-align:center">R-028</td>
<td style="text-align:center">T + 28</td>
<td style="text-align:center">T + 29</td>
<td style="text-align:center">成交金额的0.020%</td>
<td style="text-align:center">20</td>
</tr>
<tr>
<td style="text-align:center">91天国债回购</td>
<td style="text-align:right">131805</td>
<td style="text-align:center">R-091</td>
<td style="text-align:center">T + 91</td>
<td style="text-align:center">T + 92</td>
<td style="text-align:center">成交金额的0.030%</td>
<td style="text-align:center">30</td>
</tr>
<tr>
<td style="text-align:center">182天国债回购</td>
<td style="text-align:right">131806</td>
<td style="text-align:center">R-182</td>
<td style="text-align:center">T + 182</td>
<td style="text-align:center">T + 183</td>
<td style="text-align:center">成交金额的0.030%</td>
<td style="text-align:center">30</td>
</tr>
</tbody>
</table>
]]></content>
    
    <summary type="html">
    
      国债逆回购，就是将资金通过国债回购市场拆出，其实就是一种短期贷款，即你把钱借给别人，获得固定利息;而别人用国债作抵押，到期还本付息。
    
    </summary>
    
      <category term="证券" scheme="https://roc-wong.github.io/categories/%E8%AF%81%E5%88%B8/"/>
    
    
      <category term="证券" scheme="https://roc-wong.github.io/tags/%E8%AF%81%E5%88%B8/"/>
    
  </entry>
  
</feed>
